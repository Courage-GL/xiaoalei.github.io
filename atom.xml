<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>È´òÂ∞èËÉñ„ÄÇüéàÁöÑ‰∏™‰∫∫ÂçöÂÆ¢</title>
  
  <subtitle>‰∏Ä‰∏™ËÉñËÉñÁöÑ‰ΩÜÊòØÂæàÂèØÁà±ÁöÑÂ∞èÂì•Âì•</subtitle>
  <link href="https://courage-gl.github.io/xiaoalei.github.io/atom.xml" rel="self"/>
  
  <link href="https://courage-gl.github.io/xiaoalei.github.io/"/>
  <updated>2022-06-21T02:16:17.902Z</updated>
  <id>https://courage-gl.github.io/xiaoalei.github.io/</id>
  
  <author>
    <name>È´òÂ∞èËÉñ„ÄÇüéà</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>5.PJSUA2ËØ≠Èü≥ÈÄöËØùÊµÅÁ®ãÊ¢≥ÁêÜ</title>
    <link href="https://courage-gl.github.io/xiaoalei.github.io/2022/06/21/5-PJSUA2%E8%AF%AD%E9%9F%B3%E9%80%9A%E8%AF%9D%E6%B5%81%E7%A8%8B%E6%A2%B3%E7%90%86/"/>
    <id>https://courage-gl.github.io/xiaoalei.github.io/2022/06/21/5-PJSUA2%E8%AF%AD%E9%9F%B3%E9%80%9A%E8%AF%9D%E6%B5%81%E7%A8%8B%E6%A2%B3%E7%90%86/</id>
    <published>2022-06-21T01:00:02.000Z</published>
    <updated>2022-06-21T02:16:17.902Z</updated>
    
    <content type="html"><![CDATA[<h2 id="1-Êã®ÊâìÁîµËØù"><a href="#1-Êã®ÊâìÁîµËØù" class="headerlink" title="1.Êã®ÊâìÁîµËØù"></a>1.Êã®ÊâìÁîµËØù</h2><p class="code-caption" data-lang="java" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="Code" data-labels_right=":" data-labels_copy=""><span class="code-caption-label"></span><a class="code-caption-copy"></a></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (TextUtils.equals(title, getString(R.string.place_phone))) &#123;</span><br><span class="line">            <span class="comment">//IpÈÄöËØù</span></span><br><span class="line">    CallsUtils.placeCall(userName, <span class="literal">null</span>, getActivity(), <span class="literal">null</span>);</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure><h3 id="1-1-CallsUtils-placeCall-userName-null-getActivity-null"><a href="#1-1-CallsUtils-placeCall-userName-null-getActivity-null" class="headerlink" title="1.1 CallsUtils.placeCall(userName, null, getActivity(), null);"></a>1.1 CallsUtils.placeCall(userName, null, getActivity(), null);</h3><p class="code-caption" data-lang="java" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="Code" data-labels_right=":" data-labels_copy=""><span class="code-caption-label"></span><a class="code-caption-copy"></a></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">   * make a call helper for that can not get the &#123;<span class="doctag">@link</span> SipService&#125;</span></span><br><span class="line"><span class="comment">   * </span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> number the number to call</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> accId the account id</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> context the Context</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">placeCall</span><span class="params">(String number, Long accId, Context context, Bundle bundle)</span> &#123;</span><br><span class="line"><span class="comment">//      final Long[] finalAccId = &#123;accId&#125;;</span></span><br><span class="line">      XXPermissions.with(context)</span><br><span class="line">              .permission(Permission.RECORD_AUDIO)</span><br><span class="line">              .permission(Permission.Group.STORAGE)</span><br><span class="line">              .interceptor(<span class="keyword">new</span> <span class="title class_">PermissionInterceptor</span>())</span><br><span class="line">              .request(<span class="keyword">new</span> <span class="title class_">OnPermissionCallback</span>() &#123;</span><br><span class="line">                  <span class="meta">@Override</span></span><br><span class="line">                  <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onGranted</span><span class="params">(List&lt;String&gt; permissions, <span class="type">boolean</span> all)</span> &#123;</span><br><span class="line">                      <span class="keyword">if</span> (all) &#123;</span><br><span class="line">                          <span class="keyword">if</span> (!TextUtils.isEmpty(number)) &#123;</span><br><span class="line">                              <span class="type">Intent</span> <span class="variable">it</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Intent</span>(OutgoingCallListFragment.CALL_INTENT);</span><br><span class="line">                              it.setData(SipUri.forgeSipUri(SipManager.PROTOCOL_CSIP, number));</span><br><span class="line">                              it.setFlags(Intent.FLAG_ACTIVITY_NEW_TASK);</span><br><span class="line">                              <span class="keyword">if</span> (accId != <span class="literal">null</span>) &#123;</span><br><span class="line">                                  it.putExtra(SipProfile.FIELD_ACC_ID, accId);</span><br><span class="line">                                  it.putExtra(MessageFragment.BroadcastBundleKeys.MAKE_CALL_WITH_OPTS_OPTIONS, bundle);</span><br><span class="line">                              &#125;</span><br><span class="line">                              context.startActivity(it);</span><br><span class="line">                          &#125;</span><br><span class="line"></span><br><span class="line">                      &#125;</span><br><span class="line">                  &#125;</span><br><span class="line">              &#125;);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><h3 id="1-2-SipManager-ACTION-MAKE-CALL-WITH-OPTIONS-Ë∑≥ËΩ¨ÁöÑÁïåÈù¢"><a href="#1-2-SipManager-ACTION-MAKE-CALL-WITH-OPTIONS-Ë∑≥ËΩ¨ÁöÑÁïåÈù¢" class="headerlink" title="1.2 SipManager.ACTION_MAKE_CALL_WITH_OPTIONS Ë∑≥ËΩ¨ÁöÑÁïåÈù¢"></a>1.2 SipManager.ACTION_MAKE_CALL_WITH_OPTIONS Ë∑≥ËΩ¨ÁöÑÁïåÈù¢</h3><p class="code-caption" data-lang="java" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="Code" data-labels_right=":" data-labels_copy=""><span class="code-caption-label"></span><a class="code-caption-copy"></a></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (SipManager.ACTION_MAKE_CALL_WITH_OPTIONS.equals(action)) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (intent != <span class="literal">null</span>) &#123;</span><br><span class="line">                            <span class="keyword">final</span> <span class="type">String</span> <span class="variable">callee</span> <span class="operator">=</span> intent.getStringExtra(</span><br><span class="line">                                    MessageFragment.BroadcastBundleKeys.MAKE_CALL_WITH_OPTS_CALLEE);</span><br><span class="line">                            <span class="keyword">final</span> <span class="type">long</span> <span class="variable">accountId</span> <span class="operator">=</span> intent</span><br><span class="line">                                    .getLongExtra(</span><br><span class="line">                                            MessageFragment.BroadcastBundleKeys.MAKE_CALL_WITH_OPTS_ACCOUNT_ID,</span><br><span class="line">                                            -<span class="number">1</span>);</span><br><span class="line">                            <span class="keyword">final</span> <span class="type">Bundle</span> <span class="variable">options</span> <span class="operator">=</span> intent</span><br><span class="line">                                    .getBundleExtra(</span><br><span class="line">                                            MessageFragment.BroadcastBundleKeys.MAKE_CALL_WITH_OPTS_OPTIONS);</span><br><span class="line">                            <span class="keyword">try</span> &#123;</span><br><span class="line">                                binder.makeCallWithOptions(callee, (<span class="type">int</span>) accountId, options);</span><br><span class="line">                            &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">                                e.printStackTrace();</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br></pre></td></tr></table></figure><h3 id="1-3-binder-makeCallWithOptions-callee-int-accountId-options"><a href="#1-3-binder-makeCallWithOptions-callee-int-accountId-options" class="headerlink" title="1.3 binder.makeCallWithOptions(callee, (int) accountId, options);"></a>1.3 binder.makeCallWithOptions(callee, (int) accountId, options);</h3><p class="code-caption" data-lang="java" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="Code" data-labels_right=":" data-labels_copy=""><span class="code-caption-label"></span><a class="code-caption-copy"></a></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">makeCallWithOptions</span><span class="params">(<span class="keyword">final</span> String callee, <span class="keyword">final</span> <span class="type">int</span> accountId,</span></span><br><span class="line"><span class="params">                                        <span class="keyword">final</span> Bundle options)</span></span><br><span class="line">                <span class="keyword">throws</span> RemoteException &#123;</span><br><span class="line">            SipService.<span class="built_in">this</span>.enforceCallingOrSelfPermission(SipManager.PERMISSION_USE_SIP, <span class="literal">null</span>);</span><br><span class="line">            <span class="comment">// We have to ensure service is properly started and not just binded</span></span><br><span class="line">            <span class="keyword">if</span> (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.O) &#123;</span><br><span class="line">                <span class="comment">//android8.0‰ª•‰∏äÈÄöËøástartForegroundServiceÂêØÂä®service</span></span><br><span class="line">                SipService.<span class="built_in">this</span>.startService(<span class="keyword">new</span> <span class="title class_">Intent</span>(SipService.<span class="built_in">this</span>, SipService.class));</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                SipService.<span class="built_in">this</span>.startService(<span class="keyword">new</span> <span class="title class_">Intent</span>(SipService.<span class="built_in">this</span>, SipService.class));</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (pjService == <span class="literal">null</span>) &#123;</span><br><span class="line">                Log.e(THIS_FILE, <span class="string">&quot;Can&#x27;t place call if service not started&quot;</span>);</span><br><span class="line">                <span class="comment">// TODO - we should return a failing status here</span></span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (TextUtils.isEmpty(callee)) &#123;</span><br><span class="line">                Log.e(THIS_FILE, <span class="string">&quot;Can&#x27;t place call if callee equals null&quot;</span>);</span><br><span class="line">                <span class="comment">// TODO - we should return a failing status here</span></span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (!supportMultipleCalls) &#123;</span><br><span class="line">                <span class="comment">// Check if there is no ongoing calls if so drop this request by</span></span><br><span class="line">                <span class="comment">// alerting user</span></span><br><span class="line">                <span class="type">SipCallSession</span> <span class="variable">activeCall</span> <span class="operator">=</span> pjService.getActiveCallInProgress();</span><br><span class="line">                <span class="keyword">if</span> (activeCall != <span class="literal">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (!CustomDistribution.forceNoMultipleCalls()) &#123;</span><br><span class="line">                        notifyUserOfMessage(R.string.not_configured_multiple_calls);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">final</span> <span class="type">int</span> <span class="variable">callModeValue</span> <span class="operator">=</span> prefsProviderWrapper</span><br><span class="line">                    .getPreferenceIntegerValue(SipConfigManager.CALL_MODE);</span><br><span class="line"></span><br><span class="line">            Log.i(THIS_FILE, <span class="string">&quot;will call &quot;</span> + callee + <span class="string">&quot; acc_id=&quot;</span> + accountId + <span class="string">&quot; mode=&quot;</span></span><br><span class="line">                    + callModeValue);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">final</span> <span class="type">String</span> <span class="variable">finalCallee</span> <span class="operator">=</span> getCallee(callModeValue, callee);</span><br><span class="line">            <span class="keyword">if</span> (callModeValue == SipConfigManager.ASK_EACH_TIME) &#123;</span><br><span class="line">                serviceHandler.post(<span class="keyword">new</span> <span class="title class_">Runnable</span>() &#123;</span><br><span class="line"></span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">                        getChooseCallModeDialog(callee, accountId, options);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                getExecutor().execute(<span class="keyword">new</span> <span class="title class_">SipRunnable</span>() &#123;</span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">doRun</span><span class="params">()</span> <span class="keyword">throws</span> SameThreadException &#123;</span><br><span class="line">                        pjService.makeCall(finalCallee, accountId, options);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure><h3 id="1-4-pjService-makeCall-finalCallee-accountId-options"><a href="#1-4-pjService-makeCall-finalCallee-accountId-options" class="headerlink" title="1.4  pjService.makeCall(finalCallee, accountId, options);"></a>1.4  pjService.makeCall(finalCallee, accountId, options);</h3><p class="code-caption" data-lang="java" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="Code" data-labels_right=":" data-labels_copy=""><span class="code-caption-label"></span><a class="code-caption-copy"></a></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Make a call</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> callee remote contact ot call If not well formated we try to add</span></span><br><span class="line"><span class="comment">    *               domain name of the default account</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">makeCall</span><span class="params">(String callee, <span class="type">int</span> accountId, Bundle b)</span> <span class="keyword">throws</span> SameThreadException &#123;</span><br><span class="line">       <span class="keyword">if</span> (!created) &#123;</span><br><span class="line">           <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="keyword">final</span> <span class="type">ToCall</span> <span class="variable">toCall</span> <span class="operator">=</span> sanitizeSipUri(callee, accountId);</span><br><span class="line">       <span class="keyword">if</span> (toCall != <span class="literal">null</span> &amp;&amp; SipMain.hasLogged()) &#123;</span><br><span class="line">           </span><br><span class="line">           <span class="type">int</span> <span class="variable">status</span> <span class="operator">=</span> SipMain.makeCall(toCall.getCallee()) ? pjsuaConstants.PJ_SUCCESS : <span class="number">1</span>;</span><br><span class="line">           <span class="comment">//pjsua.pj_pool_release(pool);</span></span><br><span class="line">           <span class="keyword">return</span> status;</span><br><span class="line">       &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">           service.notifyUserOfMessage(service.getString(R.string.invalid_sip_uri) + <span class="string">&quot; : &quot;</span></span><br><span class="line">                   + callee);</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure><h3 id="1-5-SipMain-makeCall-toCall-getCallee"><a href="#1-5-SipMain-makeCall-toCall-getCallee" class="headerlink" title="1.5 SipMain.makeCall(toCall.getCallee())"></a>1.5 SipMain.makeCall(toCall.getCallee())</h3><p class="code-caption" data-lang="java" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="Code" data-labels_right=":" data-labels_copy=""><span class="code-caption-label"></span><a class="code-caption-copy"></a></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">makeCall</span><span class="params">(<span class="keyword">final</span> String destUri)</span> &#123;</span><br><span class="line">       <span class="keyword">return</span> SipCallMgr.getInstance().makeCall(destUri);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure><h3 id="1-6SipCallMgr-getInstance-makeCall-destUri"><a href="#1-6SipCallMgr-getInstance-makeCall-destUri" class="headerlink" title="1.6SipCallMgr.getInstance().makeCall(destUri)"></a>1.6SipCallMgr.getInstance().makeCall(destUri)</h3><p class="code-caption" data-lang="java" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="Code" data-labels_right=":" data-labels_copy=""><span class="code-caption-label"></span><a class="code-caption-copy"></a></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">makeCall</span><span class="params">(<span class="keyword">final</span> String destUri)</span> &#123;</span><br><span class="line">       Log.e(THIS_FILE, <span class="string">&quot;makeCall calling tid:&quot;</span> + Process.myTid());</span><br><span class="line">       <span class="keyword">final</span> <span class="type">SipAccount</span> <span class="variable">account</span> <span class="operator">=</span> SipAccountMgr.getInstance().getCurrentAccount();</span><br><span class="line">       <span class="keyword">if</span> (account != <span class="literal">null</span> &amp;&amp; SipUri.validSipUri(destUri)) &#123;</span><br><span class="line">           SipMain.getInstance().runOnMainThread(<span class="keyword">new</span> <span class="title class_">Runnable</span>() &#123;</span><br><span class="line">               <span class="meta">@Override</span></span><br><span class="line">               <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">                   makeCall(account, destUri);</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;);</span><br><span class="line">           <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure><h3 id="1-7-makeCall-account-destUri"><a href="#1-7-makeCall-account-destUri" class="headerlink" title="1.7  makeCall(account, destUri);"></a>1.7  makeCall(account, destUri);</h3><p class="code-caption" data-lang="java" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="Code" data-labels_right=":" data-labels_copy=""><span class="code-caption-label"></span><a class="code-caption-copy"></a></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * ÊâìÁîµËØùÁöÑÊñπÊ≥ï byÂ∞èËÉñ</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> account</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> uri</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">makeCall</span><span class="params">(<span class="keyword">final</span> SipAccount account, <span class="keyword">final</span> String uri)</span> &#123;</span><br><span class="line">        Log.e(THIS_FILE, <span class="string">&quot;makeCall executing tid:&quot;</span> + Process.myTid());</span><br><span class="line">        <span class="type">CallOpParam</span> <span class="variable">param</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CallOpParam</span>(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">SipCall</span> <span class="variable">call</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SipCall</span>(account);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            call.makeCall(uri, param);</span><br><span class="line">            <span class="type">int</span> <span class="variable">callId</span> <span class="operator">=</span> call.getId();</span><br><span class="line">            Log.e(THIS_FILE, <span class="string">&quot;makeCall to &quot;</span> + uri + <span class="string">&quot; callId:&quot;</span> + callId);</span><br><span class="line">            calls.put(callId, call);</span><br><span class="line"></span><br><span class="line">            <span class="type">SipCallSessionImpl</span> <span class="variable">session</span> <span class="operator">=</span> call.getSession();</span><br><span class="line">            session.setIncoming(<span class="literal">false</span>);</span><br><span class="line">            session.setIsRecording(<span class="literal">false</span>);</span><br><span class="line">            session.setCanRecord(<span class="literal">true</span>);</span><br><span class="line">            setCurrentActiveCall(call);</span><br><span class="line">            <span class="comment">//holdOtherCalls(callId);</span></span><br><span class="line">            SipMain.showCallingView(callId);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            Log.e(THIS_FILE, <span class="string">&quot;makeCall error:&quot;</span> + e);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            param.delete();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><h4 id="1-7-1-call-makeCall-uri-param"><a href="#1-7-1-call-makeCall-uri-param" class="headerlink" title="1.7.1   call.makeCall(uri, param);"></a>1.7.1   call.makeCall(uri, param);</h4><p class="code-caption" data-lang="java" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="Code" data-labels_right=":" data-labels_copy=""><span class="code-caption-label"></span><a class="code-caption-copy"></a></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">makeCall</span><span class="params">(String var1, CallOpParam var2)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">       pjsua2JNI.Call_makeCall(<span class="built_in">this</span>.swigCPtr, <span class="built_in">this</span>, var1, CallOpParam.getCPtr(var2), var2);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure><h4 id="1-7-2-SipMain-showCallingView-callId"><a href="#1-7-2-SipMain-showCallingView-callId" class="headerlink" title="1.7.2 SipMain.showCallingView(callId);"></a>1.7.2 SipMain.showCallingView(callId);</h4><p class="code-caption" data-lang="java" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="Code" data-labels_right=":" data-labels_copy=""><span class="code-caption-label"></span><a class="code-caption-copy"></a></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">showCallingView</span><span class="params">(<span class="type">int</span> callId)</span> &#123;</span><br><span class="line">      InCallActivity.start(SipService.getPjSipService().service, callId, <span class="literal">false</span>);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><h4 id="1-7-3-InCallActivity-start-SipService-getPjSipService-service-callId-false-ËØ•ÁïåÈù¢‰∏∫ÊâìÁîµËØùÂ±ïÁ§∫ÁïåÈù¢"><a href="#1-7-3-InCallActivity-start-SipService-getPjSipService-service-callId-false-ËØ•ÁïåÈù¢‰∏∫ÊâìÁîµËØùÂ±ïÁ§∫ÁïåÈù¢" class="headerlink" title="1.7.3  InCallActivity.start(SipService.getPjSipService().service, callId, false);ËØ•ÁïåÈù¢‰∏∫ÊâìÁîµËØùÂ±ïÁ§∫ÁïåÈù¢"></a>1.7.3  InCallActivity.start(SipService.getPjSipService().service, callId, false);ËØ•ÁïåÈù¢‰∏∫ÊâìÁîµËØùÂ±ïÁ§∫ÁïåÈù¢</h4><p class="code-caption" data-lang="java" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="Code" data-labels_right=":" data-labels_copy=""><span class="code-caption-label"></span><a class="code-caption-copy"></a></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">start</span><span class="params">(Context context, <span class="type">int</span> callId, <span class="type">boolean</span> incomingCall)</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (isAlive) &#123;</span><br><span class="line">          notifyNewCall(context, callId, incomingCall);</span><br><span class="line">          <span class="keyword">return</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="type">Intent</span> <span class="variable">starter</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Intent</span>(context, InCallActivity.class);<span class="comment">//or new Intent(SipManager.ACTION_SIP_CALL_UI);</span></span><br><span class="line">      starter.putExtra(KEY_CALL_ID, callId);</span><br><span class="line">      starter.putExtra(KEY_INCOMING_CALL, incomingCall);</span><br><span class="line">      starter.setFlags(Intent.FLAG_ACTIVITY_NEW_TASK | Intent.FLAG_ACTIVITY_SINGLE_TOP);</span><br><span class="line">      context.startActivity(starter);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><h4 id="1-7-4-ÁïåÈù¢ÂàùÂßãÂåñ"><a href="#1-7-4-ÁïåÈù¢ÂàùÂßãÂåñ" class="headerlink" title="1.7.4 ÁïåÈù¢ÂàùÂßãÂåñ"></a>1.7.4 ÁïåÈù¢ÂàùÂßãÂåñ</h4><p class="code-caption" data-lang="java" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="Code" data-labels_right=":" data-labels_copy=""><span class="code-caption-label"></span><a class="code-caption-copy"></a></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">mainFrame = (ViewGroup) findViewById(R.id.mainFrame);</span><br><span class="line">      inCallControls = (InCallControls) findViewById(R.id.inCallControls);</span><br><span class="line">      callsListView = (ListView&lt;BaseAdapter&gt;) findViewById(R.id.calls_list_view);</span><br><span class="line">      inCallAnswerControls = (InCallAnswerControls) findViewById(R.id.inCallAnswerControls);</span><br><span class="line">      activeCallsGrid = (InCallInfoGrid) findViewById(R.id.activeCallsGrid);</span><br><span class="line">      <span class="comment">// heldCallsGrid = (InCallInfoGrid) findViewById(R.id.heldCallsGrid);</span></span><br><span class="line">      <span class="comment">// Bind</span></span><br><span class="line"><span class="comment">//      attachVideoPreview();</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//   ÊúÄÂ∫ïÈÉ®ÊåâÈîÆ</span></span><br><span class="line">      inCallControls.setOnTriggerListener(<span class="built_in">this</span>);</span><br><span class="line">      <span class="comment">// Êé•Âê¨ÊàñËÄÖÊåÇÊñ≠ÁîµËØùÁöÑÊéß‰ª∂</span></span><br><span class="line">      inCallAnswerControls.setOnTriggerListener(<span class="built_in">this</span>);</span><br></pre></td></tr></table></figure><h4 id="1-7-5-Ê≥®ÂÜåÂπøÊí≠-Ê†πÊçÆsipEventÂíåmediaÊõ¥Êñ∞ÁïåÈù¢Â±ïÁ§∫-ÂÖ∂ÂÆûÂ∞±ÊòØÊ†πÊçÆÈÄöËØùÁä∂ÊÄÅÊù•Â±ïÁ§∫ÁïåÈù¢"><a href="#1-7-5-Ê≥®ÂÜåÂπøÊí≠-Ê†πÊçÆsipEventÂíåmediaÊõ¥Êñ∞ÁïåÈù¢Â±ïÁ§∫-ÂÖ∂ÂÆûÂ∞±ÊòØÊ†πÊçÆÈÄöËØùÁä∂ÊÄÅÊù•Â±ïÁ§∫ÁïåÈù¢" class="headerlink" title="1.7.5 Ê≥®ÂÜåÂπøÊí≠ Ê†πÊçÆsipEventÂíåmediaÊõ¥Êñ∞ÁïåÈù¢Â±ïÁ§∫ ÂÖ∂ÂÆûÂ∞±ÊòØÊ†πÊçÆÈÄöËØùÁä∂ÊÄÅÊù•Â±ïÁ§∫ÁïåÈù¢"></a>1.7.5 Ê≥®ÂÜåÂπøÊí≠ Ê†πÊçÆsipEventÂíåmediaÊõ¥Êñ∞ÁïåÈù¢Â±ïÁ§∫ ÂÖ∂ÂÆûÂ∞±ÊòØÊ†πÊçÆÈÄöËØùÁä∂ÊÄÅÊù•Â±ïÁ§∫ÁïåÈù¢</h4><p class="code-caption" data-lang="java" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="Code" data-labels_right=":" data-labels_copy=""><span class="code-caption-label"></span><a class="code-caption-copy"></a></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Listen to media &amp; sip events to update the UI</span></span><br><span class="line">      registerReceiver(callStateReceiver, <span class="keyword">new</span> <span class="title class_">IntentFilter</span>(SipManager.ACTION_SIP_CALL_NEW_CALL));</span><br><span class="line">      registerReceiver(callStateReceiver, <span class="keyword">new</span> <span class="title class_">IntentFilter</span>(SipManager.ACTION_SIP_CALL_CHANGED));</span><br><span class="line">      registerReceiver(callStateReceiver, <span class="keyword">new</span> <span class="title class_">IntentFilter</span>(SipManager.ACTION_SIP_MEDIA_CHANGED));</span><br><span class="line">      registerReceiver(callStateReceiver, <span class="keyword">new</span> <span class="title class_">IntentFilter</span>(SipManager.ACTION_ZRTP_SHOW_SAS));</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Listen to system call state changed to update the hold</span></span><br><span class="line">      registerReceiver(callStateReceiver, <span class="keyword">new</span> <span class="title class_">IntentFilter</span>(SipManager.ACTION_PHONE_STATE_CHANGED));</span><br></pre></td></tr></table></figure><h4 id="1-7-6-UpdateUIFromCallRunnable"><a href="#1-7-6-UpdateUIFromCallRunnable" class="headerlink" title="1.7.6 UpdateUIFromCallRunnable"></a>1.7.6 UpdateUIFromCallRunnable</h4><p class="code-caption" data-lang="java" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="Code" data-labels_right=":" data-labels_copy=""><span class="code-caption-label"></span><a class="code-caption-copy"></a></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Update the user interface from calls state.</span></span><br><span class="line"><span class="comment">    * ‰ªécallsÁä∂ÊÄÅÊõ¥Êñ∞Áî®Êà∑ÁïåÈù¢„ÄÇ</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">class</span> <span class="title class_">UpdateUIFromCallRunnable</span> <span class="keyword">implements</span> <span class="title class_">Runnable</span> &#123;</span><br><span class="line"></span><br><span class="line">       <span class="meta">@Override</span></span><br><span class="line">       <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">           <span class="comment">// Current call is the call emphasis by the UI.</span></span><br><span class="line">           <span class="type">SipCallSession</span> <span class="variable">mainCallInfo</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">           <span class="type">int</span> <span class="variable">mainsCalls</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">           <span class="type">int</span> <span class="variable">heldsCalls</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">           <span class="keyword">synchronized</span> (callMutex) &#123;</span><br><span class="line">               <span class="keyword">for</span> (SipCallSession callInfo : callPresenter.getCalls()) &#123;</span><br><span class="line">                   <span class="keyword">if</span> (!callInfo.isAfterEnded()) &#123;</span><br><span class="line">                       <span class="keyword">if</span> (callInfo.isLocalHeld()) &#123;</span><br><span class="line">                           heldsCalls++;</span><br><span class="line">                       &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                           mainsCalls++;</span><br><span class="line">                       &#125;</span><br><span class="line">                   &#125;</span><br><span class="line">                   mainCallInfo = callPresenter.getPriorityCall(callInfo, mainCallInfo);</span><br><span class="line">                   Log.e(THIS_FILE,</span><br><span class="line">                           <span class="string">&quot;We have a call &quot;</span> + callInfo.getCallId() + <span class="string">&quot; / &quot;</span></span><br><span class="line">                                   + callInfo.getCallState()</span><br><span class="line">                                   + <span class="string">&quot;/&quot;</span> + callInfo.getMediaStatus());</span><br><span class="line">                   Log.e(THIS_FILE, <span class="string">&quot;main call id &quot;</span> + mainCallInfo.getCallId()</span><br><span class="line">                           + <span class="string">&quot;is InvState.EARLY? &quot;</span></span><br><span class="line">                           + (mainCallInfo.getCallState() == InvState.EARLY));</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">           <span class="comment">// Update call control visibility - must be done before call cards</span></span><br><span class="line"><span class="comment">//           Êõ¥Êñ∞ÂëºÂè´ÊéßÂà∂ÂèØËßÅÊÄß-ÂøÖÈ°ªÂú®‰ΩøÁî®ÂëºÂè´Âç°‰πãÂâçÂÆåÊàê</span></span><br><span class="line">           <span class="comment">// because badge avail size depends on that</span></span><br><span class="line"><span class="comment">//           Âõ†‰∏∫badgeÊúâÊïàÂ§ßÂ∞èÂèñÂÜ≥‰∫éÊ≠§</span></span><br><span class="line">           <span class="keyword">if</span> ((mainsCalls + heldsCalls) &gt;= <span class="number">1</span>) &#123;</span><br><span class="line">               <span class="comment">// Update in call actions</span></span><br><span class="line">               <span class="type">int</span> <span class="variable">mainCallInfoPosition</span> <span class="operator">=</span> activeCallsAdapter</span><br><span class="line">                       .findMainCallInfoPosition(mainCallInfo);</span><br><span class="line">               inCallControls.setCallState(mainCallInfo.getCallId(), mainCallInfo.isIncoming(), mainCallInfo.getCallState());</span><br><span class="line">               activeCallsGrid.setMainCallInfoPosition(mainCallInfoPosition);</span><br><span class="line">               multiCallsAdapter.setChooseCallPosition(mainCallInfoPosition);</span><br><span class="line">               callsListView.setSelection(mainCallInfoPosition &gt; <span class="number">0</span> ? mainCallInfoPosition - <span class="number">1</span></span><br><span class="line">                       : mainCallInfoPosition);</span><br><span class="line">               inCallAnswerControls.setCallState(mainCallInfo.getCallId(), mainCallInfo.isIncoming(), mainCallInfo.getCallState());</span><br><span class="line">           &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">               <span class="type">boolean</span> <span class="variable">isIncomingCall</span> <span class="operator">=</span> callPresenter.isIncomingCall();</span><br><span class="line">               inCallControls.setCallState(SipCall.INVALID_CALL_ID, isIncomingCall, <span class="number">0</span>);</span><br><span class="line">               inCallAnswerControls.setCallState(SipCall.INVALID_CALL_ID, isIncomingCall, <span class="number">0</span>);</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">           <span class="comment">// heldCallsGrid.setVisibility((heldsCalls &gt; 0)? View.VISIBLE :</span></span><br><span class="line">           <span class="comment">// View.GONE);</span></span><br><span class="line"></span><br><span class="line">           activeCallsAdapter.notifyDataSetChanged();</span><br><span class="line">           multiCallsAdapter.notifyDataSetChanged();</span><br><span class="line"></span><br><span class="line">           <span class="comment">// findViewById(R.id.inCallContainer).requestLayout();</span></span><br><span class="line"></span><br><span class="line">           <span class="comment">// heldCallsAdapter.notifyDataSetChanged();</span></span><br><span class="line"></span><br><span class="line">           <span class="comment">// findViewById(R.id.inCallContainer).requestLayout();</span></span><br><span class="line"></span><br><span class="line">           <span class="keyword">if</span> (mainCallInfo != <span class="literal">null</span>) &#123;</span><br><span class="line">               Log.e(THIS_FILE, <span class="string">&quot;Active call is &quot;</span> + mainCallInfo.getCallId());</span><br><span class="line">               Log.e(THIS_FILE, <span class="string">&quot;Update ui from call &quot;</span> + mainCallInfo.getCallId() + <span class="string">&quot; state &quot;</span></span><br><span class="line">                       + CallsUtils.getStringCallState(mainCallInfo, InCallActivity.<span class="built_in">this</span>));</span><br><span class="line">               <span class="type">int</span> <span class="variable">state</span> <span class="operator">=</span> mainCallInfo.getCallState();</span><br><span class="line"></span><br><span class="line">               <span class="comment">// int backgroundResId =</span></span><br><span class="line">               <span class="comment">// R.drawable.bg_in_call_gradient_unidentified;</span></span><br><span class="line"></span><br><span class="line">               <span class="comment">// We manage wake lock</span></span><br><span class="line">               <span class="keyword">switch</span> (state) &#123;</span><br><span class="line">                   <span class="keyword">case</span> InvState.EARLY:</span><br><span class="line">                   <span class="keyword">case</span> InvState.INCOMING:</span><br><span class="line">                   <span class="keyword">case</span> InvState.CALLING:</span><br><span class="line">                   <span class="keyword">case</span> InvState.CONNECTING:</span><br><span class="line">                       Log.e(THIS_FILE, <span class="string">&quot;Acquire wake up lock&quot;</span>);</span><br><span class="line">                       <span class="keyword">if</span> (wakeLock != <span class="literal">null</span> &amp;&amp; !wakeLock.isHeld()) &#123;</span><br><span class="line">                           wakeLock.acquire();</span><br><span class="line">                       &#125;</span><br><span class="line">                       <span class="keyword">break</span>;</span><br><span class="line">                   <span class="keyword">case</span> InvState.CONFIRMED:</span><br><span class="line">                       <span class="keyword">break</span>;</span><br><span class="line">                   <span class="keyword">case</span> InvState.NULL:</span><br><span class="line">                   <span class="keyword">case</span> InvState.DISCONNECTED:</span><br><span class="line">                       <span class="comment">//  ÁªìÊùüÈÄöËØù</span></span><br><span class="line">                       Log.e(THIS_FILE,</span><br><span class="line">                               <span class="string">&quot;Active call session is disconnected or null wait for quit...&quot;</span>);</span><br><span class="line"><span class="comment">//                       ToastUtils.INSTANCE.show(InCallActivity.this, &quot;ÈÄöËØùÁªìÊùüÔºÅ&quot;);</span></span><br><span class="line">                       <span class="comment">// This will release locks</span></span><br><span class="line">                       onDisplayVideo(<span class="literal">false</span>);</span><br><span class="line">                       delayedQuit();</span><br><span class="line">                       <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">               &#125;</span><br><span class="line"></span><br><span class="line">               Log.e(THIS_FILE, <span class="string">&quot;we leave the update ui function&quot;</span>);</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">           proximityManager.updateProximitySensorMode();</span><br><span class="line"></span><br><span class="line">           <span class="keyword">if</span> (heldsCalls + mainsCalls == <span class="number">0</span>) &#123;</span><br><span class="line">               delayedQuit();</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure><h4 id="1-7-7-CallsAdapterÁïåÈù¢ÈÄöËØù‰ø°ÊÅØÂÖ∑‰ΩìÂ±ïÁ§∫"><a href="#1-7-7-CallsAdapterÁïåÈù¢ÈÄöËØù‰ø°ÊÅØÂÖ∑‰ΩìÂ±ïÁ§∫" class="headerlink" title="1.7.7 CallsAdapterÁïåÈù¢ÈÄöËØù‰ø°ÊÅØÂÖ∑‰ΩìÂ±ïÁ§∫"></a>1.7.7 CallsAdapterÁïåÈù¢ÈÄöËØù‰ø°ÊÅØÂÖ∑‰ΩìÂ±ïÁ§∫</h4><p class="code-caption" data-lang="java" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="Code" data-labels_right=":" data-labels_copy=""><span class="code-caption-label"></span><a class="code-caption-copy"></a></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">       <span class="keyword">public</span> View <span class="title function_">getView</span><span class="params">(<span class="type">int</span> position, View convertView, ViewGroup parent)</span> &#123;</span><br><span class="line">           <span class="keyword">if</span> (convertView == <span class="literal">null</span>) &#123;</span><br><span class="line"><span class="comment">//              Êã®ÊâìÁîµËØùÁöÑÊéßÂà∂ÁïåÈù¢</span></span><br><span class="line">               convertView = <span class="keyword">new</span> <span class="title class_">InCallCard</span>(InCallActivity.<span class="built_in">this</span>, <span class="literal">null</span>);</span><br><span class="line">           &#125;</span><br><span class="line"><span class="comment">//          Â¶ÇÊûúÁîµËØù Êé•‰∏çÈÄö ‰ºöÂ±ïÁ§∫ÈªòËÆ§ÁïåÈù¢ ÁÑ∂ÂêéÈÄÄÂá∫</span></span><br><span class="line">           <span class="keyword">if</span> (convertView <span class="keyword">instanceof</span> InCallCard) &#123;</span><br><span class="line">               <span class="type">InCallCard</span> <span class="variable">vc</span> <span class="operator">=</span> (InCallCard) convertView;</span><br><span class="line"><span class="comment">//             ÂÖàÊãøÂà∞ÂØπÁöÑÁä∂ÊÄÅ ÂÜçÊèêÁ§∫ÈîôËØØÂéüÂõ†</span></span><br><span class="line">               <span class="type">SipCallSession</span> <span class="variable">session</span> <span class="operator">=</span> (SipCallSession) getItem(position);</span><br><span class="line">               vc.setCallState(session);</span><br><span class="line">               <span class="keyword">if</span> (onQuitting) &#123;</span><br><span class="line">                   vc.showActionButtons(showCallButtons);</span><br><span class="line">                   vc.showEndCallBar(showEndCallBar);</span><br><span class="line">                   vc.stopTimer();</span><br><span class="line">               &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                   vc.setOnTriggerListener(InCallActivity.<span class="built_in">this</span>);</span><br><span class="line">                   <span class="comment">// TODO ---</span></span><br><span class="line">                   <span class="comment">// badge.setOnTouchListener(new OnBadgeTouchListener(badge,</span></span><br><span class="line">                   <span class="comment">// call));</span></span><br><span class="line">                   <span class="comment">// added by txp 2013-12-18</span></span><br><span class="line">                   vc.setMediaState(lastMediaState);</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br><span class="line">           <span class="keyword">return</span> convertView;</span><br><span class="line">       &#125;</span><br></pre></td></tr></table></figure><h4 id="1-7-8-InCallCard-ÊâìÁîµËØùÁöÑËØ¶ÁªÜÁïåÈù¢"><a href="#1-7-8-InCallCard-ÊâìÁîµËØùÁöÑËØ¶ÁªÜÁïåÈù¢" class="headerlink" title="1.7.8 InCallCard ÊâìÁîµËØùÁöÑËØ¶ÁªÜÁïåÈù¢"></a>1.7.8 InCallCard ÊâìÁîµËØùÁöÑËØ¶ÁªÜÁïåÈù¢</h4><p class="code-caption" data-lang="java" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="Code" data-labels_right=":" data-labels_copy=""><span class="code-caption-label"></span><a class="code-caption-copy"></a></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">InCallCard</span><span class="params">(Context context, AttributeSet attrs)</span> &#123;</span><br><span class="line">    <span class="built_in">super</span>(context, attrs);</span><br><span class="line">    <span class="type">LayoutInflater</span> <span class="variable">inflater</span> <span class="operator">=</span> LayoutInflater.from(context);</span><br><span class="line"><span class="comment">//    ÊâìÁîµËØùÁöÑËØ¶ÁªÜÁïåÈù¢</span></span><br><span class="line">    inflater.inflate(R.layout.in_call_card, <span class="built_in">this</span>, <span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">    prefs = PreferencesWrapper.getInstance(context);</span><br><span class="line">    isInExpertMode = prefs</span><br><span class="line">            .getPreferenceBooleanValue(PreferencesWrapper.IS_ADVANCED_USER);</span><br><span class="line">    <span class="keyword">if</span> (!isInEditMode()) &#123;</span><br><span class="line">        supportMultipleCalls = prefs.getPreferenceBooleanValue(</span><br><span class="line">                SipConfigManager.SUPPORT_MULTIPLE_CALLS);</span><br><span class="line">    &#125;</span><br><span class="line">    canVideo = prefs.getPreferenceBooleanValue(SipConfigManager.USE_VIDEO);</span><br><span class="line">    initControllerView();</span><br><span class="line">    initControllerButtons();</span><br><span class="line">    updateCallPopWindow(context, <span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line">    incallPlugins = ExtraPlugins</span><br><span class="line">            .getDynActivityPlugins(context, SipManager.ACTION_INCALL_PLUGIN);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="1-8ÁîµËØùÁä∂ÊÄÅÁõ∏ÂÖ≥"><a href="#1-8ÁîµËØùÁä∂ÊÄÅÁõ∏ÂÖ≥" class="headerlink" title="1.8ÁîµËØùÁä∂ÊÄÅÁõ∏ÂÖ≥"></a>1.8ÁîµËØùÁä∂ÊÄÅÁõ∏ÂÖ≥</h3><p class="code-caption" data-lang="java" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="Code" data-labels_right=":" data-labels_copy=""><span class="code-caption-label"></span><a class="code-caption-copy"></a></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">switch</span> (whichAction) &#123;</span><br><span class="line">             <span class="keyword">case</span> TAKE_CALL: &#123;</span><br><span class="line">                 callPresenter.answer();</span><br><span class="line">                 <span class="comment">/*if (service != null) &#123;</span></span><br><span class="line"><span class="comment">                     Log.e(THIS_FILE, &quot;Answer call &quot; + callId);</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">                     boolean shouldHoldOthers = false;*/</span></span><br><span class="line"></span><br><span class="line">                 <span class="comment">// Well actually we should be always before confirmed</span></span><br><span class="line">                     <span class="comment">/*if (call.isBeforeConfirmed()) &#123;</span></span><br><span class="line"><span class="comment">                         shouldHoldOthers = true;</span></span><br><span class="line"><span class="comment">                     &#125;*/</span></span><br><span class="line"></span><br><span class="line">                 <span class="comment">/*service.answer(call.getCallId(), SipCallSession.StatusCode.OK);*/</span></span><br><span class="line"></span><br><span class="line">                 <span class="comment">// if it&#x27;s a ringing call, we assume that user wants to</span></span><br><span class="line">                 <span class="comment">// hold other calls</span></span><br><span class="line">                     <span class="comment">/*if (shouldHoldOthers &amp;&amp; callsInfo != null) &#123;</span></span><br><span class="line"><span class="comment">                         for (SipCallSession callInfo : callsInfo) &#123;</span></span><br><span class="line"><span class="comment">                             // For each active and running call</span></span><br><span class="line"><span class="comment">                             if (SipCallSession.InvState.CONFIRMED == callInfo.getCallState()</span></span><br><span class="line"><span class="comment">                                     &amp;&amp; !callInfo.isLocalHeld()</span></span><br><span class="line"><span class="comment">                                     &amp;&amp; callInfo.getCallId() != call.getCallId()) &#123;</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">                                 Log.e(THIS_FILE, &quot;Hold call &quot; + callInfo.getCallId());</span></span><br><span class="line"><span class="comment">                                 service.hold(callInfo.getCallId());</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">                             &#125;</span></span><br><span class="line"><span class="comment">                         &#125;</span></span><br><span class="line"><span class="comment">                     &#125;*/</span></span><br><span class="line">                 <span class="comment">//&#125;</span></span><br><span class="line">                 <span class="keyword">break</span>;</span><br><span class="line">             &#125;</span><br><span class="line">             <span class="keyword">case</span> DONT_TAKE_CALL: &#123;</span><br><span class="line">                 callPresenter.hangup();</span><br><span class="line">                 <span class="comment">/*if (service != null) &#123;</span></span><br><span class="line"><span class="comment">                     //service.hangup(call.getCallId(), StatusCode.BUSY_HERE);</span></span><br><span class="line"><span class="comment">                 &#125;*/</span></span><br><span class="line">                 <span class="keyword">break</span>;</span><br><span class="line">             &#125;</span><br><span class="line">             <span class="keyword">case</span> REJECT_CALL:</span><br><span class="line">             <span class="keyword">case</span> TERMINATE_CALL: &#123;</span><br><span class="line"><span class="comment">//                ÊãíÁªùÈÄöËØù ÊàñËÄÖ ÁªìÊùüÈÄöËØù</span></span><br><span class="line">                 callPresenter.disconnect();</span><br><span class="line">                 <span class="comment">/*if (service != null) &#123;</span></span><br><span class="line"><span class="comment">                     //service.hangup(call.getCallId(), 0);</span></span><br><span class="line"><span class="comment">                 &#125;*/</span></span><br><span class="line">                 <span class="keyword">break</span>;</span><br><span class="line">             &#125;</span><br><span class="line">             <span class="keyword">case</span> MUTE_ON:</span><br><span class="line">             <span class="keyword">case</span> MUTE_OFF: &#123;</span><br><span class="line">                 callPresenter.setMicrophoneMuteStatus(whichAction == MUTE_ON);</span><br><span class="line">                 <span class="comment">/*if (service != null) &#123;</span></span><br><span class="line"><span class="comment">                     //service.setMicrophoneMute((whichAction == MUTE_ON) ? true : false);</span></span><br><span class="line"><span class="comment">                 &#125;*/</span></span><br><span class="line">                 <span class="keyword">break</span>;</span><br><span class="line">             &#125;</span><br><span class="line"><span class="comment">//             Êâ¨Â£∞Âô® ÊâìÂºÄÂÖ≥Èó≠</span></span><br><span class="line">             <span class="keyword">case</span> SPEAKER_ON:</span><br><span class="line">             <span class="keyword">case</span> SPEAKER_OFF: &#123;</span><br><span class="line">                 callPresenter.setSpeakerphoneStatus(whichAction == SPEAKER_ON);</span><br><span class="line">                 useAutoDetectSpeaker = <span class="literal">false</span>;</span><br><span class="line">                 <span class="comment">/*if (service != null) &#123;</span></span><br><span class="line"><span class="comment">                     Log.e(THIS_FILE, &quot;Manually switch to speaker&quot;);</span></span><br><span class="line"><span class="comment">                     //service.setSpeakerphoneOn((whichAction == SPEAKER_ON) ? true : false);</span></span><br><span class="line"><span class="comment">                 &#125;*/</span></span><br><span class="line">                 <span class="keyword">break</span>;</span><br><span class="line">             &#125;</span><br><span class="line">             <span class="keyword">case</span> BLUETOOTH_ON:</span><br><span class="line">             <span class="keyword">case</span> BLUETOOTH_OFF: &#123;</span><br><span class="line">                 callPresenter.setBluetoothOn(whichAction == BLUETOOTH_ON);</span><br><span class="line">                 <span class="comment">/*if (service != null) &#123;</span></span><br><span class="line"><span class="comment">                     service.setBluetoothOn((whichAction == BLUETOOTH_ON) ? true : false);</span></span><br><span class="line"><span class="comment">                 &#125;*/</span></span><br><span class="line">                 <span class="keyword">break</span>;</span><br><span class="line">             &#125;</span><br><span class="line">             <span class="keyword">case</span> DTMF_DISPLAY: &#123;</span><br><span class="line">                 showDialpad(callId);</span><br><span class="line">                 <span class="keyword">break</span>;</span><br><span class="line">             &#125;</span><br><span class="line">             <span class="keyword">case</span> DETAILED_DISPLAY: &#123;</span><br><span class="line">                 <span class="comment">// ÈÄöËØù - Êõ¥Â§ö - ‰ø°ÊÅØ</span></span><br><span class="line">                 callPresenter.dump(<span class="built_in">this</span>);</span><br><span class="line">                 <span class="keyword">break</span>;</span><br><span class="line">             &#125;</span><br><span class="line">             <span class="keyword">case</span> TOGGLE_HOLD: &#123;</span><br><span class="line">                 callPresenter.toggleHold();</span><br><span class="line">                 <span class="comment">/*if (service != null) &#123;</span></span><br><span class="line"><span class="comment">                     // Log.e(THIS_FILE,</span></span><br><span class="line"><span class="comment">                     // &quot;Current state is : &quot;+callInfo.getCallState().name()+&quot; / &quot;+callInfo.getMediaStatus().name());</span></span><br><span class="line"><span class="comment">                     if (call.getMediaStatus() == SipCallSession.MediaState.LOCAL_HOLD ||</span></span><br><span class="line"><span class="comment">                             call.getMediaStatus() == SipCallSession.MediaState.NONE) &#123;</span></span><br><span class="line"><span class="comment">                         service.reinvite(call.getCallId(), true);</span></span><br><span class="line"><span class="comment">                     &#125; else &#123;</span></span><br><span class="line"><span class="comment">                         service.hold(call.getCallId());</span></span><br><span class="line"><span class="comment">                     &#125;</span></span><br><span class="line"><span class="comment">                 &#125;*/</span></span><br><span class="line">                 <span class="keyword">break</span>;</span><br><span class="line">             &#125;</span><br><span class="line">             <span class="keyword">case</span> MEDIA_SETTINGS: &#123;</span><br><span class="line">                 startActivity(<span class="keyword">new</span> <span class="title class_">Intent</span>(<span class="built_in">this</span>, InCallMediaControl.class));</span><br><span class="line">                 <span class="keyword">break</span>;</span><br><span class="line">             &#125;</span><br><span class="line">             <span class="keyword">case</span> XFER_CALL: &#123;</span><br><span class="line">                 <span class="type">Intent</span> <span class="variable">pickupIntent</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Intent</span>(<span class="built_in">this</span>, PickupSipUri.class);</span><br><span class="line">                 pickupIntent.putExtra(CALL_ID, callId);</span><br><span class="line">                 startActivityForResult(pickupIntent, PICKUP_SIP_URI_XFER);</span><br><span class="line">                 <span class="keyword">break</span>;</span><br><span class="line">             &#125;</span><br><span class="line">             <span class="keyword">case</span> TRANSFER_CALL: &#123;</span><br><span class="line">                 <span class="keyword">final</span> ArrayList&lt;SipCallSession&gt; remoteCalls = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;SipCallSession&gt;();</span><br><span class="line">                 <span class="keyword">for</span> (SipCallSession remoteCall : callPresenter.getCalls()) &#123;</span><br><span class="line">                     <span class="comment">// Verify not current call</span></span><br><span class="line">                     <span class="keyword">if</span> (remoteCall.getCallId() != callId</span><br><span class="line">                             &amp;&amp; remoteCall.isOngoing()) &#123;</span><br><span class="line">                         remoteCalls.add(remoteCall);</span><br><span class="line">                     &#125;</span><br><span class="line">                 &#125;</span><br><span class="line"></span><br><span class="line">                 <span class="keyword">if</span> (remoteCalls.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                     <span class="type">Builder</span> <span class="variable">builder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Builder</span>(<span class="built_in">this</span>);</span><br><span class="line">                     CharSequence[] simpleAdapter = <span class="keyword">new</span> <span class="title class_">String</span>[remoteCalls.size()];</span><br><span class="line">                     <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; remoteCalls.size(); i++) &#123;</span><br><span class="line">                         simpleAdapter[i] = remoteCalls.get(i).getRemoteContact();</span><br><span class="line">                     &#125;</span><br><span class="line">                     builder.setSingleChoiceItems(simpleAdapter, -<span class="number">1</span>,</span><br><span class="line">                             <span class="keyword">new</span> <span class="title class_">Dialog</span>.OnClickListener() &#123;</span><br><span class="line">                                 <span class="meta">@Override</span></span><br><span class="line">                                 <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onClick</span><span class="params">(DialogInterface dialog, <span class="type">int</span> which)</span> &#123;</span><br><span class="line">                                    <span class="comment">/* if (service != null) &#123;</span></span><br><span class="line"><span class="comment">                                         try &#123;</span></span><br><span class="line"><span class="comment">                                             // 1 =</span></span><br><span class="line"><span class="comment">                                             // PJSUA_XFER_NO_REQUIRE_REPLACES</span></span><br><span class="line"><span class="comment">                                             service.xferReplace(callId, remoteCalls</span></span><br><span class="line"><span class="comment">                                                     .get(which).getCallId(), 1);</span></span><br><span class="line"><span class="comment">                                         &#125; catch (RemoteException e) &#123;</span></span><br><span class="line"><span class="comment">                                             Log.e(THIS_FILE,</span></span><br><span class="line"><span class="comment">                                                     &quot;Was not able to call service method&quot;, e);</span></span><br><span class="line"><span class="comment">                                         &#125;</span></span><br><span class="line"><span class="comment">                                     &#125;*/</span></span><br><span class="line">                                     dialog.dismiss();</span><br><span class="line">                                 &#125;</span><br><span class="line">                             &#125;)</span><br><span class="line">                             .setCancelable(<span class="literal">true</span>)</span><br><span class="line">                             .setNeutralButton(R.string.cancel, <span class="keyword">new</span> <span class="title class_">Dialog</span>.OnClickListener() &#123;</span><br><span class="line">                                 <span class="meta">@Override</span></span><br><span class="line">                                 <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onClick</span><span class="params">(DialogInterface dialog, <span class="type">int</span> which)</span> &#123;</span><br><span class="line">                                     dialog.dismiss();</span><br><span class="line">                                 &#125;</span><br><span class="line">                             &#125;)</span><br><span class="line">                             .show();</span><br><span class="line">                 &#125;</span><br><span class="line"></span><br><span class="line">                 <span class="keyword">break</span>;</span><br><span class="line">             &#125;</span><br><span class="line">             <span class="keyword">case</span> ADD_CALL: &#123;</span><br><span class="line">                 <span class="type">Intent</span> <span class="variable">pickupIntent</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Intent</span>(<span class="built_in">this</span>, PickupSipUri.class);</span><br><span class="line">                 startActivityForResult(pickupIntent, PICKUP_SIP_URI_NEW_CALL);</span><br><span class="line">                 <span class="keyword">break</span>;</span><br><span class="line">             &#125;</span><br><span class="line">             <span class="keyword">case</span> START_RECORDING: &#123;</span><br><span class="line">                 callPresenter.startRecording(callId, SipManager.BITMASK_ALL);</span><br><span class="line">                 <span class="keyword">break</span>;</span><br><span class="line">             &#125;</span><br><span class="line">             <span class="keyword">case</span> STOP_RECORDING: &#123;</span><br><span class="line">                 callPresenter.stopRecording(callId);</span><br><span class="line">                 <span class="keyword">break</span>;</span><br><span class="line">             &#125;</span><br><span class="line">             <span class="keyword">case</span> START_VIDEO:</span><br><span class="line">             <span class="keyword">case</span> STOP_VIDEO: &#123;</span><br><span class="line">                 <span class="comment">/*if (service != null) &#123;</span></span><br><span class="line"><span class="comment">                     Bundle opts = new Bundle();</span></span><br><span class="line"><span class="comment">                     opts.putBoolean(SipCallSession.OPT_CALL_VIDEO, whichAction == START_VIDEO);</span></span><br><span class="line"><span class="comment">                     service.updateCallOptions(callId, opts);</span></span><br><span class="line"><span class="comment">                 &#125;*/</span></span><br><span class="line">                 <span class="keyword">break</span>;</span><br><span class="line">             &#125;</span><br><span class="line">             <span class="keyword">case</span> ZRTP_TRUST: &#123;</span><br><span class="line">                 <span class="comment">/*if (service != null) &#123;</span></span><br><span class="line"><span class="comment">                     service.zrtpSASVerified(callId);</span></span><br><span class="line"><span class="comment">                 &#125;*/</span></span><br><span class="line">                 <span class="keyword">break</span>;</span><br><span class="line">             &#125;</span><br><span class="line">             <span class="keyword">case</span> ZRTP_REVOKE: &#123;</span><br><span class="line">                 <span class="comment">/*if (service != null) &#123;</span></span><br><span class="line"><span class="comment">                     service.zrtpSASRevoke(callId);</span></span><br><span class="line"><span class="comment">                 &#125;*/</span></span><br><span class="line">                 <span class="keyword">break</span>;</span><br><span class="line">             &#125;</span><br><span class="line">         &#125;</span><br></pre></td></tr></table></figure><h3 id="1-9-ÁîµËØùÁä∂ÊÄÅÁõëÂê¨"><a href="#1-9-ÁîµËØùÁä∂ÊÄÅÁõëÂê¨" class="headerlink" title="1.9 ÁîµËØùÁä∂ÊÄÅÁõëÂê¨"></a>1.9 ÁîµËØùÁä∂ÊÄÅÁõëÂê¨</h3><p class="code-caption" data-lang="java" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="Code" data-labels_right=":" data-labels_copy=""><span class="code-caption-label"></span><a class="code-caption-copy"></a></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onCallState</span><span class="params">(<span class="keyword">final</span> SipCall call, <span class="keyword">final</span> CallInfo callInfo, <span class="keyword">final</span> SipEvent event)</span> &#123;</span><br><span class="line">        <span class="comment">// Êõ¥Êñ∞ÁîµËØùÁä∂ÊÄÅ</span></span><br><span class="line">        <span class="type">SipCallSessionImpl</span> <span class="variable">session</span> <span class="operator">=</span> call.getSession();</span><br><span class="line">        updateSessionInfo(session, callInfo);</span><br><span class="line">        <span class="keyword">final</span> <span class="type">int</span> <span class="variable">state</span> <span class="operator">=</span> callInfo.getState();</span><br><span class="line">        <span class="keyword">final</span> <span class="type">int</span> <span class="variable">callId</span> <span class="operator">=</span> call.getId();</span><br><span class="line"><span class="comment">//      ÊâìÁîµËØùÁõ∏ÂÖ≥ÁöÑÁä∂ÊÄÅ‰ø°ÊÅØ</span></span><br><span class="line">        <span class="keyword">if</span> (!TextUtils.isEmpty(session.getLastReason2())) &#123;</span><br><span class="line">            SipMain.getInstance().runOnMainThread(<span class="keyword">new</span> <span class="title class_">Runnable</span>() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">                    ToastHelper.makeText(MyApplication.getApplication(), session.getLastReason2());</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (state == pjsip_inv_state.PJSIP_INV_STATE_DISCONNECTED) &#123;</span><br><span class="line">            <span class="comment">// ÊåÇÊñ≠</span></span><br><span class="line">            removeCall(call);</span><br><span class="line">            showCallNotification(callId, <span class="literal">false</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (state == pjsip_inv_state.PJSIP_INV_STATE_CONFIRMED) &#123;</span><br><span class="line"><span class="comment">//            Êé•Âê¨ ÂºÄÂßãËÆ°Êó∂ ÂÅúÊ≠¢ÂìçÈìÉ</span></span><br><span class="line">            <span class="keyword">if</span> (session.getCallStart() == <span class="number">0</span>) &#123;</span><br><span class="line">                session.setCallStart(System.currentTimeMillis());</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (session.getConnectStart() == <span class="number">0</span>) &#123;</span><br><span class="line">                session.setConnectStart(SystemClock.elapsedRealtime());</span><br><span class="line">            &#125;</span><br><span class="line">            SipMediaMgr.getInstance().stopRing();</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (state == pjsip_inv_state.PJSIP_INV_STATE_CALLING) &#123;</span><br><span class="line">            <span class="comment">//        Êã®ÊâìÁîµËØùÊó∂ Ë¶ÅÊúâÂìçÂ∫î</span></span><br><span class="line">            SipMediaMgr.getInstance().playRing(SipUri.getUserName(callInfo.getRemoteUri()));</span><br><span class="line">        &#125;</span><br><span class="line">        notifyObserverCallStateChanged(callId, state);</span><br><span class="line"> ¬† ¬† ¬† ¬†<span class="comment">// Êõ¥Êñ∞Áä∂ÊÄÅÊ†è</span></span><br><span class="line">        updateCallNotification(callId, state);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><h2 id="2-Êé•Âê¨ÁîµËØù"><a href="#2-Êé•Âê¨ÁîµËØù" class="headerlink" title="2.Êé•Âê¨ÁîµËØù"></a>2.Êé•Âê¨ÁîµËØù</h2><h3 id="2-1-Êî∂Âà∞ÁîµËØùÁõëÂê¨-onIncomingCall-final-SipCall-call-final-CallInfo-callInfo"><a href="#2-1-Êî∂Âà∞ÁîµËØùÁõëÂê¨-onIncomingCall-final-SipCall-call-final-CallInfo-callInfo" class="headerlink" title="2.1 Êî∂Âà∞ÁîµËØùÁõëÂê¨ onIncomingCall(final SipCall call, final CallInfo callInfo)"></a>2.1 Êî∂Âà∞ÁîµËØùÁõëÂê¨ onIncomingCall(final SipCall call, final CallInfo callInfo)</h3><p class="code-caption" data-lang="java" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="Code" data-labels_right=":" data-labels_copy=""><span class="code-caption-label"></span><a class="code-caption-copy"></a></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Êî∂Âà∞Âà´‰∫∫ÊâìÁîµËØùÁöÑÈÄªËæë</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onIncomingCall</span><span class="params">(<span class="keyword">final</span> SipCall call, <span class="keyword">final</span> CallInfo callInfo)</span> &#123;</span><br><span class="line">    <span class="type">int</span> <span class="variable">callId</span> <span class="operator">=</span> callInfo.getId();</span><br><span class="line">    Log.e(THIS_FILE, <span class="string">&quot;onIncomingCall callId:&quot;</span> + callId + <span class="string">&quot; uri:&quot;</span> + callInfo.getRemoteUri());</span><br><span class="line">    setCurrentActiveCall(call);</span><br><span class="line">    calls.put(callId, call);</span><br><span class="line"></span><br><span class="line">    <span class="type">SipCallSessionImpl</span> <span class="variable">session</span> <span class="operator">=</span> call.getSession();</span><br><span class="line">    session.setIncoming(<span class="literal">true</span>);</span><br><span class="line">    session.setIsRecording(<span class="literal">false</span>);</span><br><span class="line">    session.setCanRecord(<span class="literal">true</span>);</span><br><span class="line">    updateSessionInfo(session, callInfo);</span><br><span class="line"></span><br><span class="line">    call.ring();</span><br><span class="line">    <span class="comment">//ÂãøÊâ∞Ê®°Âºè‰∏ã‰∏çÂìçÈìÉ</span></span><br><span class="line">    <span class="keyword">if</span> (!notifier.isSlientMode()) &#123;</span><br><span class="line">        SipMediaMgr.getInstance().playRing(SipUri.getUserName(callInfo.getRemoteUri()));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    SipMain.notifyIncomingCall(callId);</span><br><span class="line">    updateCallNotification(callId, pjsip_inv_state.PJSIP_INV_STATE_INCOMING);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="2-2-SipMain-notifyIncomingCall-callId-ÂØπÁÖß1-7-2-1-7-3-Á¨¨‰∏â‰∏™ÂèÇÊï∞-falseË°®Á§∫-ÁªôÂØπÊñπÊâìÁîµËØù-tureË°®Á§∫ÂØπÊñπÁªôËá™Â∑±ÊâìÁîµËØù"><a href="#2-2-SipMain-notifyIncomingCall-callId-ÂØπÁÖß1-7-2-1-7-3-Á¨¨‰∏â‰∏™ÂèÇÊï∞-falseË°®Á§∫-ÁªôÂØπÊñπÊâìÁîµËØù-tureË°®Á§∫ÂØπÊñπÁªôËá™Â∑±ÊâìÁîµËØù" class="headerlink" title="2.2  SipMain.notifyIncomingCall(callId); ÂØπÁÖß1.7.2 1.7.3 Á¨¨‰∏â‰∏™ÂèÇÊï∞ falseË°®Á§∫ ÁªôÂØπÊñπÊâìÁîµËØù tureË°®Á§∫ÂØπÊñπÁªôËá™Â∑±ÊâìÁîµËØù"></a>2.2  SipMain.notifyIncomingCall(callId); ÂØπÁÖß1.7.2 1.7.3 Á¨¨‰∏â‰∏™ÂèÇÊï∞ falseË°®Á§∫ ÁªôÂØπÊñπÊâìÁîµËØù tureË°®Á§∫ÂØπÊñπÁªôËá™Â∑±ÊâìÁîµËØù</h3><p class="code-caption" data-lang="java" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="Code" data-labels_right=":" data-labels_copy=""><span class="code-caption-label"></span><a class="code-caption-copy"></a></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">notifyIncomingCall</span><span class="params">(<span class="type">int</span> callId)</span> &#123;</span><br><span class="line">        InCallActivity.start(SipService.getPjSipService().service, callId, <span class="literal">true</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><h3 id="2-3-ÁïåÈù¢Â±ïÁ§∫ÈÉ®ÂàÜÈÄªËæëÁ≠âÂêå‰∫éÊã®ÊâìÁîµËØù-Áï•Ëøá"><a href="#2-3-ÁïåÈù¢Â±ïÁ§∫ÈÉ®ÂàÜÈÄªËæëÁ≠âÂêå‰∫éÊã®ÊâìÁîµËØù-Áï•Ëøá" class="headerlink" title="2.3 ÁïåÈù¢Â±ïÁ§∫ÈÉ®ÂàÜÈÄªËæëÁ≠âÂêå‰∫éÊã®ÊâìÁîµËØù Áï•Ëøá"></a>2.3 ÁïåÈù¢Â±ïÁ§∫ÈÉ®ÂàÜÈÄªËæëÁ≠âÂêå‰∫éÊã®ÊâìÁîµËØù Áï•Ëøá</h3><h3 id="2-4-Êù•ÁîµËØùÂ±ïÁ§∫ÁöÑÁïåÈù¢-‰∏âÁßçÂΩ¢ÊÄÅ"><a href="#2-4-Êù•ÁîµËØùÂ±ïÁ§∫ÁöÑÁïåÈù¢-‰∏âÁßçÂΩ¢ÊÄÅ" class="headerlink" title="2.4 Êù•ÁîµËØùÂ±ïÁ§∫ÁöÑÁïåÈù¢ ‰∏âÁßçÂΩ¢ÊÄÅ"></a>2.4 Êù•ÁîµËØùÂ±ïÁ§∫ÁöÑÁïåÈù¢ ‰∏âÁßçÂΩ¢ÊÄÅ</h3><p class="code-caption" data-lang="java" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="Code" data-labels_right=":" data-labels_copy=""><span class="code-caption-label"></span><a class="code-caption-copy"></a></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (incomingCall) &#123;</span><br><span class="line"><span class="comment">//Êù•ÁîµËØùÂ±ïÁ§∫ÁöÑÁïåÈù¢ ‰∏âÁßçÂΩ¢ÊÄÅ</span></span><br><span class="line">setCallLockerVisibility(VISIBLE);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">setCallLockerVisibility(GONE);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="2-4-1-setCallLockerVisibility-VISIBLE-Ôºõ"><a href="#2-4-1-setCallLockerVisibility-VISIBLE-Ôºõ" class="headerlink" title="2.4.1 setCallLockerVisibility(VISIBLE)Ôºõ"></a>2.4.1 setCallLockerVisibility(VISIBLE)Ôºõ</h4><p class="code-caption" data-lang="java" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="Code" data-labels_right=":" data-labels_copy=""><span class="code-caption-label"></span><a class="code-caption-copy"></a></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">setCallLockerVisibility</span><span class="params">(<span class="type">int</span> visibility)</span> &#123;</span><br><span class="line">    controlMode = visibility == View.VISIBLE ? MODE_LOCKER : MODE_NO_ACTION;</span><br><span class="line">    setVisibility(visibility);</span><br><span class="line">        <span class="keyword">if</span>(visibility == View.VISIBLE) &#123;</span><br><span class="line">            <span class="comment">// Inflate sub views only if display is requested</span></span><br><span class="line">            <span class="keyword">if</span>(lockerWidget == <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="keyword">switch</span> (lockerWidgetType) &#123;</span><br><span class="line">                    <span class="keyword">case</span> LOCKER_SLIDINGTAB:</span><br><span class="line">                        lockerWidget = <span class="keyword">new</span> <span class="title class_">SlidingTab</span>(getContext());</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    <span class="keyword">case</span> LOCKER_BUTTON:</span><br><span class="line">                        lockerWidget = <span class="keyword">new</span> <span class="title class_">AlternateUnlocker</span>(getContext());</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    <span class="keyword">case</span> LOCKER_GLOWPAD:</span><br><span class="line">                        lockerWidget = <span class="keyword">new</span> <span class="title class_">GlowPadView</span>(getContext());</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    <span class="keyword">default</span>:</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                lockerWidget.setOnLeftRightListener(<span class="built_in">this</span>);</span><br><span class="line">                lockerWidget.setTypeOfLock(TypeOfLock.CALL);</span><br><span class="line">                lockerWidget.applyTargetTitles(R.array.answer_choices);</span><br><span class="line">                <span class="type">LayoutParams</span> <span class="variable">lp</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">LayoutParams</span>(lockerWidget.getLayoutingWidth(), lockerWidget.getLayoutingHeight());</span><br><span class="line">                <span class="keyword">if</span>(lockerWidget.getLayoutingHeight() == LayoutParams.WRAP_CONTENT ||</span><br><span class="line">                        lockerWidget.getLayoutingWidth() == LayoutParams.WRAP_CONTENT) &#123;</span><br><span class="line">                    lp.addRule(RelativeLayout.CENTER_IN_PARENT, RelativeLayout.TRUE);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="built_in">this</span>.addView((View) lockerWidget, lp);</span><br><span class="line">                </span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(lockerWidget != <span class="literal">null</span>) &#123;</span><br><span class="line">            lockerWidget.setVisibility(visibility);</span><br><span class="line">            lockerWidget.resetView();</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="2-5-Êé•Âê¨„ÄÅÊãíÊé•„ÄÅÊåÇÊñ≠Á≠âÁ≠âÂêå‰∫éÊâìÁîµËØùÁõ∏ÂÖ≥Êìç‰Ωú-Áï•Ëøá"><a href="#2-5-Êé•Âê¨„ÄÅÊãíÊé•„ÄÅÊåÇÊñ≠Á≠âÁ≠âÂêå‰∫éÊâìÁîµËØùÁõ∏ÂÖ≥Êìç‰Ωú-Áï•Ëøá" class="headerlink" title="2.5 Êé•Âê¨„ÄÅÊãíÊé•„ÄÅÊåÇÊñ≠Á≠âÁ≠âÂêå‰∫éÊâìÁîµËØùÁõ∏ÂÖ≥Êìç‰Ωú Áï•Ëøá"></a>2.5 Êé•Âê¨„ÄÅÊãíÊé•„ÄÅÊåÇÊñ≠Á≠âÁ≠âÂêå‰∫éÊâìÁîµËØùÁõ∏ÂÖ≥Êìç‰Ωú Áï•Ëøá</h3><p> ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬†</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;1-Êã®ÊâìÁîµËØù&quot;&gt;&lt;a href=&quot;#1-Êã®ÊâìÁîµËØù&quot; class=&quot;headerlink&quot; title=&quot;1.Êã®ÊâìÁîµËØù&quot;&gt;&lt;/a&gt;1.Êã®ÊâìÁîµËØù&lt;/h2&gt;&lt;p class=&quot;code-caption&quot; data-lang=&quot;java&quot; data-line_number</summary>
      
    
    
    
    
  </entry>
  
  <entry>
    <title>4.PJSUA2ÁºñËØëÊïôÁ®ã</title>
    <link href="https://courage-gl.github.io/xiaoalei.github.io/2022/06/21/4-PJSUA2%E7%BC%96%E8%AF%91%E6%95%99%E7%A8%8B/"/>
    <id>https://courage-gl.github.io/xiaoalei.github.io/2022/06/21/4-PJSUA2%E7%BC%96%E8%AF%91%E6%95%99%E7%A8%8B/</id>
    <published>2022-06-21T00:44:42.000Z</published>
    <updated>2022-06-21T00:59:22.139Z</updated>
    
    <content type="html"><![CDATA[<h2 id="1-‰∏ãËΩΩËµÑÊ∫ê"><a href="#1-‰∏ãËΩΩËµÑÊ∫ê" class="headerlink" title="1.‰∏ãËΩΩËµÑÊ∫ê"></a>1.‰∏ãËΩΩËµÑÊ∫ê</h2><h3 id="1-1-‰∏ãËΩΩopenssl"><a href="#1-1-‰∏ãËΩΩopenssl" class="headerlink" title="1.1 ‰∏ãËΩΩopenssl"></a>1.1 ‰∏ãËΩΩopenssl</h3><p>git clone git:&#x2F;&#x2F;git.openssl.org&#x2F;openssl.git ‰∏ãËΩΩopensllÊñá‰ª∂</p><h3 id="1-2-‰∏ãËΩΩpjproject-2-12-1"><a href="#1-2-‰∏ãËΩΩpjproject-2-12-1" class="headerlink" title="1.2 ‰∏ãËΩΩpjproject-2.12.1"></a>1.2 ‰∏ãËΩΩpjproject-2.12.1</h3><h2 id="2-ÂáÜÂ§áÁºñËØë"><a href="#2-ÂáÜÂ§áÁºñËØë" class="headerlink" title="2.ÂáÜÂ§áÁºñËØë"></a>2.ÂáÜÂ§áÁºñËØë</h2><h3 id="2-1-‰øÆÊîπÁõ∏ÂÖ≥ÈÖçÁΩÆ-Âú®config-site-hÊñá‰ª∂‰∏ãÈù¢‰øÆÊîπÁõ∏ÂÖ≥ÈÖçÁΩÆ"><a href="#2-1-‰øÆÊîπÁõ∏ÂÖ≥ÈÖçÁΩÆ-Âú®config-site-hÊñá‰ª∂‰∏ãÈù¢‰øÆÊîπÁõ∏ÂÖ≥ÈÖçÁΩÆ" class="headerlink" title="2.1 ‰øÆÊîπÁõ∏ÂÖ≥ÈÖçÁΩÆ Âú®config_site.hÊñá‰ª∂‰∏ãÈù¢‰øÆÊîπÁõ∏ÂÖ≥ÈÖçÁΩÆ"></a>2.1 ‰øÆÊîπÁõ∏ÂÖ≥ÈÖçÁΩÆ Âú®config_site.hÊñá‰ª∂‰∏ãÈù¢‰øÆÊîπÁõ∏ÂÖ≥ÈÖçÁΩÆ</h3><p>&#x2F;* Activate Android specific settings in the ‚Äòconfig_site_sample.h‚Äô *&#x2F;<br>&#x2F;&#x2F; ÊåáÂÆöÁºñËØëÂπ≥Âè∞‰∏∫Android<br>#define PJ_CONFIG_ANDROID 1<br>#include &lt;pj&#x2F;config_site_sample.h&gt;<br>#define PJMEDIA_HAS_VIDEO 1<br>#define PJ_HAS_IPV6 1<br>&#x2F;&#x2F; ‰ΩøÁî®ssl<br>#define PJ_HAS_SSL_SOCK 1<br>#define PJSIP_HAS_TLS_TRANSPORT 1<br>&#x2F;&#x2F; ÂøÉË∑≥ 300<br>#define PJSIP_TCP_KEEP_ALIVE_INTERVAL 300<br>&#x2F;&#x2F; ËØ≠Èü≥ÈôçÂô™ÁÆóÊ≥ïÁõ∏ÂÖ≥<br>#define PJMEDIA_WEBRTC_AEC_USE_MOBILE 1<br>#define PJMEDIA_HAS_WEBRTC_AEC 1</p><h3 id="2-2-ÁºñËØëopensslÊñá‰ª∂-Ê†πÊçÆandroid‰∏çÂêåÂπ≥Âè∞ÁîüÊàê‰∏çÂêåÁöÑopensslÊñá‰ª∂"><a href="#2-2-ÁºñËØëopensslÊñá‰ª∂-Ê†πÊçÆandroid‰∏çÂêåÂπ≥Âè∞ÁîüÊàê‰∏çÂêåÁöÑopensslÊñá‰ª∂" class="headerlink" title="2.2 ÁºñËØëopensslÊñá‰ª∂ Ê†πÊçÆandroid‰∏çÂêåÂπ≥Âè∞ÁîüÊàê‰∏çÂêåÁöÑopensslÊñá‰ª∂"></a>2.2 ÁºñËØëopensslÊñá‰ª∂ Ê†πÊçÆandroid‰∏çÂêåÂπ≥Âè∞ÁîüÊàê‰∏çÂêåÁöÑopensslÊñá‰ª∂</h3><h4 id="ÁºñËØëÂëΩ‰ª§Â¶Ç‰∏ãÔºö"><a href="#ÁºñËØëÂëΩ‰ª§Â¶Ç‰∏ãÔºö" class="headerlink" title="ÁºñËØëÂëΩ‰ª§Â¶Ç‰∏ãÔºö"></a>ÁºñËØëÂëΩ‰ª§Â¶Ç‰∏ãÔºö</h4><h5 id="1-git-clone-git-x2F-x2F-git-openssl-org-x2F-openssl-git-‰∏ãËΩΩopensllÊñá‰ª∂"><a href="#1-git-clone-git-x2F-x2F-git-openssl-org-x2F-openssl-git-‰∏ãËΩΩopensllÊñá‰ª∂" class="headerlink" title="1.git clone git:&#x2F;&#x2F;git.openssl.org&#x2F;openssl.git ‰∏ãËΩΩopensllÊñá‰ª∂"></a>1.git clone git:&#x2F;&#x2F;git.openssl.org&#x2F;openssl.git ‰∏ãËΩΩopensllÊñá‰ª∂</h5><h6 id="2-cdËøõÂÖ•Âà∞opensslÁõÆÂΩï‰∏ã-ÁºñËØëÊ∫êÁ†Å"><a href="#2-cdËøõÂÖ•Âà∞opensslÁõÆÂΩï‰∏ã-ÁºñËØëÊ∫êÁ†Å" class="headerlink" title="2.cdËøõÂÖ•Âà∞opensslÁõÆÂΩï‰∏ã ÁºñËØëÊ∫êÁ†Å"></a>2.cdËøõÂÖ•Âà∞opensslÁõÆÂΩï‰∏ã ÁºñËØëÊ∫êÁ†Å</h6><h6 id="3-‰ΩøÁî®exportÂëΩ‰ª§Êñ∞Â¢û-x2F-‰øÆÊîπÁéØÂ¢ÉÂèòÈáèANDROID-NDK-ROOTÊåáÂêë‰Ω†ÁöÑNDKÁõÆÂΩïÔºåexport-ÁöÑÊïàÂäõ‰ªÖÈôê‰∫éËØ•Ê¨°ÁôªÂΩïÊìç‰ΩúexportANDROID-NDK-ROOT-x3D-x2F-Users-x2F-gaolei-x2F-Library-x2F-Android-x2F-sdk-x2F-ndk-x2F-22-0-7026061"><a href="#3-‰ΩøÁî®exportÂëΩ‰ª§Êñ∞Â¢û-x2F-‰øÆÊîπÁéØÂ¢ÉÂèòÈáèANDROID-NDK-ROOTÊåáÂêë‰Ω†ÁöÑNDKÁõÆÂΩïÔºåexport-ÁöÑÊïàÂäõ‰ªÖÈôê‰∫éËØ•Ê¨°ÁôªÂΩïÊìç‰ΩúexportANDROID-NDK-ROOT-x3D-x2F-Users-x2F-gaolei-x2F-Library-x2F-Android-x2F-sdk-x2F-ndk-x2F-22-0-7026061" class="headerlink" title="3.‰ΩøÁî®exportÂëΩ‰ª§Êñ∞Â¢û&#x2F;‰øÆÊîπÁéØÂ¢ÉÂèòÈáèANDROID_NDK_ROOTÊåáÂêë‰Ω†ÁöÑNDKÁõÆÂΩïÔºåexport ÁöÑÊïàÂäõ‰ªÖÈôê‰∫éËØ•Ê¨°ÁôªÂΩïÊìç‰ΩúexportANDROID_NDK_ROOT&#x3D;&#x2F;Users&#x2F;gaolei&#x2F;Library&#x2F;Android&#x2F;sdk&#x2F;ndk&#x2F;22.0.7026061"></a>3.‰ΩøÁî®exportÂëΩ‰ª§Êñ∞Â¢û&#x2F;‰øÆÊîπÁéØÂ¢ÉÂèòÈáèANDROID_NDK_ROOTÊåáÂêë‰Ω†ÁöÑNDKÁõÆÂΩïÔºåexport ÁöÑÊïàÂäõ‰ªÖÈôê‰∫éËØ•Ê¨°ÁôªÂΩïÊìç‰ΩúexportANDROID_NDK_ROOT&#x3D;&#x2F;Users&#x2F;gaolei&#x2F;Library&#x2F;Android&#x2F;sdk&#x2F;ndk&#x2F;22.0.7026061</h6><h6 id="4-Â∞ÜÁºñËØëopensslÊâÄÈúÄÁöÑNDKÂëΩ‰ª§ÊâÄÂú®ÁöÑÁõÆÂΩïÊ∑ªÂä†Âà∞ÁéØÂ¢ÉÂèòÈáèPATH‰∏≠PATH-x3D-ANDROID-NDK-ROOT-x2F-toolchains-x2F-llvm-x2F-prebuilt-x2F-darwin-x86-64-x2F-bin-PATH"><a href="#4-Â∞ÜÁºñËØëopensslÊâÄÈúÄÁöÑNDKÂëΩ‰ª§ÊâÄÂú®ÁöÑÁõÆÂΩïÊ∑ªÂä†Âà∞ÁéØÂ¢ÉÂèòÈáèPATH‰∏≠PATH-x3D-ANDROID-NDK-ROOT-x2F-toolchains-x2F-llvm-x2F-prebuilt-x2F-darwin-x86-64-x2F-bin-PATH" class="headerlink" title="4.Â∞ÜÁºñËØëopensslÊâÄÈúÄÁöÑNDKÂëΩ‰ª§ÊâÄÂú®ÁöÑÁõÆÂΩïÊ∑ªÂä†Âà∞ÁéØÂ¢ÉÂèòÈáèPATH‰∏≠PATH&#x3D;$ANDROID_NDK_ROOT&#x2F;toolchains&#x2F;llvm&#x2F;prebuilt&#x2F;darwin-x86_64&#x2F;bin:$PATH"></a>4.Â∞ÜÁºñËØëopensslÊâÄÈúÄÁöÑNDKÂëΩ‰ª§ÊâÄÂú®ÁöÑÁõÆÂΩïÊ∑ªÂä†Âà∞ÁéØÂ¢ÉÂèòÈáèPATH‰∏≠PATH&#x3D;$ANDROID_NDK_ROOT&#x2F;toolchains&#x2F;llvm&#x2F;prebuilt&#x2F;darwin-x86_64&#x2F;bin:$PATH</h6><h6 id="5-ËøêË°å-x2F-ConfigureËÑöÊú¨ÁîüÊàêMakefileÊñá‰ª∂ÔºåËøôÈáåÊåáÂÆöÁîüÊàêarm64ÁöÑ-so-x2F-x2F-ÊåáÂÆöÁºñËØëopensslËæìÂá∫‰ΩçÁΩÆ-ÁîüÊàêopensslsoÊñá‰ª∂-x2F-Configure-android-arm64-D-ANDROID-API-x3D-21-‚Äìprefix-x3D-x2F-Users-x2F-gaolei-x2F-Desktop-x2F-opensslarm64-x2F-Configure-android-arm-D-ANDROID-API-x3D-21-‚Äìprefix-x3D-x2F-Users-x2F-gaolei-x2F-Desktop-x2F-opensslarm-x2F-Configure-android-x86-D-ANDROID-API-x3D-21-‚Äìprefix-x3D-x2F-Users-x2F-gaolei-x2F-Desktop-x2F-opensslx86-x2F-Configure-android-x86-64-D-ANDROID-API-x3D-21-‚Äìprefix-x3D-x2F-Users-x2F-gaolei-x2F-Desktop-x2F-opensslx86-64ÊâßË°åÂÆå‰πãÂêé‰ºöÂú®ÂΩìÂâçÁõÆÂΩï‰∏ãÁîüÊàê‰∏Ä‰∏ã‰∏§‰∏™Êñá‰ª∂-makeFile"><a href="#5-ËøêË°å-x2F-ConfigureËÑöÊú¨ÁîüÊàêMakefileÊñá‰ª∂ÔºåËøôÈáåÊåáÂÆöÁîüÊàêarm64ÁöÑ-so-x2F-x2F-ÊåáÂÆöÁºñËØëopensslËæìÂá∫‰ΩçÁΩÆ-ÁîüÊàêopensslsoÊñá‰ª∂-x2F-Configure-android-arm64-D-ANDROID-API-x3D-21-‚Äìprefix-x3D-x2F-Users-x2F-gaolei-x2F-Desktop-x2F-opensslarm64-x2F-Configure-android-arm-D-ANDROID-API-x3D-21-‚Äìprefix-x3D-x2F-Users-x2F-gaolei-x2F-Desktop-x2F-opensslarm-x2F-Configure-android-x86-D-ANDROID-API-x3D-21-‚Äìprefix-x3D-x2F-Users-x2F-gaolei-x2F-Desktop-x2F-opensslx86-x2F-Configure-android-x86-64-D-ANDROID-API-x3D-21-‚Äìprefix-x3D-x2F-Users-x2F-gaolei-x2F-Desktop-x2F-opensslx86-64ÊâßË°åÂÆå‰πãÂêé‰ºöÂú®ÂΩìÂâçÁõÆÂΩï‰∏ãÁîüÊàê‰∏Ä‰∏ã‰∏§‰∏™Êñá‰ª∂-makeFile" class="headerlink" title="5.ËøêË°å.&#x2F;ConfigureËÑöÊú¨ÁîüÊàêMakefileÊñá‰ª∂ÔºåËøôÈáåÊåáÂÆöÁîüÊàêarm64ÁöÑ.so&#x2F;&#x2F; ÊåáÂÆöÁºñËØëopensslËæìÂá∫‰ΩçÁΩÆ  ÁîüÊàêopensslsoÊñá‰ª∂.&#x2F;Configure android-arm64 -D__ANDROID_API__&#x3D;21 ‚Äìprefix&#x3D;&#x2F;Users&#x2F;gaolei&#x2F;Desktop&#x2F;opensslarm64.&#x2F;Configure android-arm -D__ANDROID_API__&#x3D;21 ‚Äìprefix&#x3D;&#x2F;Users&#x2F;gaolei&#x2F;Desktop&#x2F;opensslarm.&#x2F;Configure android-x86 -D__ANDROID_API__&#x3D;21 ‚Äìprefix&#x3D;&#x2F;Users&#x2F;gaolei&#x2F;Desktop&#x2F;opensslx86¬†.&#x2F;Configure android-x86_64 -D__ANDROID_API__&#x3D;21 ‚Äìprefix&#x3D;&#x2F;Users&#x2F;gaolei&#x2F;Desktop&#x2F;opensslx86_64ÊâßË°åÂÆå‰πãÂêé‰ºöÂú®ÂΩìÂâçÁõÆÂΩï‰∏ãÁîüÊàê‰∏Ä‰∏ã‰∏§‰∏™Êñá‰ª∂ makeFile"></a>5.ËøêË°å.&#x2F;ConfigureËÑöÊú¨ÁîüÊàêMakefileÊñá‰ª∂ÔºåËøôÈáåÊåáÂÆöÁîüÊàêarm64ÁöÑ.so&#x2F;&#x2F; ÊåáÂÆöÁºñËØëopensslËæìÂá∫‰ΩçÁΩÆ  ÁîüÊàêopensslsoÊñá‰ª∂.&#x2F;Configure android-arm64 -D__ANDROID_API__&#x3D;21 ‚Äìprefix&#x3D;&#x2F;Users&#x2F;gaolei&#x2F;Desktop&#x2F;opensslarm64.&#x2F;Configure android-arm -D__ANDROID_API__&#x3D;21 ‚Äìprefix&#x3D;&#x2F;Users&#x2F;gaolei&#x2F;Desktop&#x2F;opensslarm.&#x2F;Configure android-x86 -D__ANDROID_API__&#x3D;21 ‚Äìprefix&#x3D;&#x2F;Users&#x2F;gaolei&#x2F;Desktop&#x2F;opensslx86¬†.&#x2F;Configure android-x86_64 -D__ANDROID_API__&#x3D;21 ‚Äìprefix&#x3D;&#x2F;Users&#x2F;gaolei&#x2F;Desktop&#x2F;opensslx86_64ÊâßË°åÂÆå‰πãÂêé‰ºöÂú®ÂΩìÂâçÁõÆÂΩï‰∏ãÁîüÊàê‰∏Ä‰∏ã‰∏§‰∏™Êñá‰ª∂ makeFile</h6><h6 id="6-‰ΩøÁî®make-amp-amp-make-install-ÂëΩ‰ª§ËøõË°åÁºñËØë-armeabi-ÂØπÂ∫î-android-arm-arm64-v8a-ÂØπÂ∫î-android-arm64-x86-ÂØπÂ∫î-android-x86-Ôºåx86-64ÂØπÂ∫î-android-x86-64"><a href="#6-‰ΩøÁî®make-amp-amp-make-install-ÂëΩ‰ª§ËøõË°åÁºñËØë-armeabi-ÂØπÂ∫î-android-arm-arm64-v8a-ÂØπÂ∫î-android-arm64-x86-ÂØπÂ∫î-android-x86-Ôºåx86-64ÂØπÂ∫î-android-x86-64" class="headerlink" title="6.‰ΩøÁî®make &amp;&amp; make install ÂëΩ‰ª§ËøõË°åÁºñËØë(armeabi ÂØπÂ∫î android-arm, arm64-v8a ÂØπÂ∫î android-arm64, x86 ÂØπÂ∫î android-x86 Ôºåx86_64ÂØπÂ∫î android-x86_64)"></a>6.‰ΩøÁî®make &amp;&amp; make install ÂëΩ‰ª§ËøõË°åÁºñËØë(armeabi ÂØπÂ∫î android-arm, arm64-v8a ÂØπÂ∫î android-arm64, x86 ÂØπÂ∫î android-x86 Ôºåx86_64ÂØπÂ∫î android-x86_64)</h6><h5 id="7-ÊâßË°åÂÆå‰ºöÂú®Ê°åÈù¢ÁîüÊàêÊÉ≥ÂØπÂ∫îÁöÑandroidÂπ≥Âè∞ÁöÑopensslÊñá‰ª∂Â§π"><a href="#7-ÊâßË°åÂÆå‰ºöÂú®Ê°åÈù¢ÁîüÊàêÊÉ≥ÂØπÂ∫îÁöÑandroidÂπ≥Âè∞ÁöÑopensslÊñá‰ª∂Â§π" class="headerlink" title="7.ÊâßË°åÂÆå‰ºöÂú®Ê°åÈù¢ÁîüÊàêÊÉ≥ÂØπÂ∫îÁöÑandroidÂπ≥Âè∞ÁöÑopensslÊñá‰ª∂Â§π"></a>7.ÊâßË°åÂÆå‰ºöÂú®Ê°åÈù¢ÁîüÊàêÊÉ≥ÂØπÂ∫îÁöÑandroidÂπ≥Âè∞ÁöÑopensslÊñá‰ª∂Â§π</h5><h3 id="2-3-ÁºñËØëpjsua2Êñá‰ª∂"><a href="#2-3-ÁºñËØëpjsua2Êñá‰ª∂" class="headerlink" title="2.3 ÁºñËØëpjsua2Êñá‰ª∂"></a>2.3 ÁºñËØëpjsua2Êñá‰ª∂</h3><h6 id="1-cd-x2F-Users-x2F-gaolei-x2F-Downloads-x2F-pjproject2-12-1-cdÂà∞Ê∫êÁ†ÅÊ†πÁõÆÂΩï-make-clean"><a href="#1-cd-x2F-Users-x2F-gaolei-x2F-Downloads-x2F-pjproject2-12-1-cdÂà∞Ê∫êÁ†ÅÊ†πÁõÆÂΩï-make-clean" class="headerlink" title="1.cd &#x2F;Users&#x2F;gaolei&#x2F;Downloads&#x2F;pjproject2.12.1 #cdÂà∞Ê∫êÁ†ÅÊ†πÁõÆÂΩï make clean"></a>1.cd &#x2F;Users&#x2F;gaolei&#x2F;Downloads&#x2F;pjproject2.12.1 #cdÂà∞Ê∫êÁ†ÅÊ†πÁõÆÂΩï make clean</h6><h6 id="2-cd-pjsip-apps-x2F-src-x2F-pjsua-x2F-android-x2F-jni-make-clean"><a href="#2-cd-pjsip-apps-x2F-src-x2F-pjsua-x2F-android-x2F-jni-make-clean" class="headerlink" title="2.cd pjsip-apps&#x2F;src&#x2F;pjsua&#x2F;android&#x2F;jni   make clean"></a>2.cd pjsip-apps&#x2F;src&#x2F;pjsua&#x2F;android&#x2F;jni   make clean</h6><h5 id="3-cd-x2F-Users-x2F-gaolei-x2F-Downloads-x2F-pjproject-2-12-1-x2F-pjsip-apps-x2F-src-x2F-swig-make-clean"><a href="#3-cd-x2F-Users-x2F-gaolei-x2F-Downloads-x2F-pjproject-2-12-1-x2F-pjsip-apps-x2F-src-x2F-swig-make-clean" class="headerlink" title="3.cd &#x2F;Users&#x2F;gaolei&#x2F;Downloads&#x2F;pjproject-2.12.1&#x2F;pjsip-apps&#x2F;src&#x2F;swig  make clean"></a>3.cd &#x2F;Users&#x2F;gaolei&#x2F;Downloads&#x2F;pjproject-2.12.1&#x2F;pjsip-apps&#x2F;src&#x2F;swig  make clean</h5><h5 id="4-cd-x2F-Users-x2F-gaolei-x2F-Downloads-x2F-pjproject-2-12-1-export-ANDROID-NDK-ROOT-x3D-x2F-Users-x2F-gaolei-x2F-Library-x2F-Android-x2F-sdk-x2F-ndk-x2F-22-0-7026061"><a href="#4-cd-x2F-Users-x2F-gaolei-x2F-Downloads-x2F-pjproject-2-12-1-export-ANDROID-NDK-ROOT-x3D-x2F-Users-x2F-gaolei-x2F-Library-x2F-Android-x2F-sdk-x2F-ndk-x2F-22-0-7026061" class="headerlink" title="4.cd &#x2F;Users&#x2F;gaolei&#x2F;Downloads&#x2F;pjproject-2.12.1 export ANDROID_NDK_ROOT&#x3D;&#x2F;Users&#x2F;gaolei&#x2F;Library&#x2F;Android&#x2F;sdk&#x2F;ndk&#x2F;22.0.7026061"></a>4.cd &#x2F;Users&#x2F;gaolei&#x2F;Downloads&#x2F;pjproject-2.12.1 export ANDROID_NDK_ROOT&#x3D;&#x2F;Users&#x2F;gaolei&#x2F;Library&#x2F;Android&#x2F;sdk&#x2F;ndk&#x2F;22.0.7026061</h5><h5 id="5-ÁºñËØë‰∏çÂêåÂπ≥Âè∞ÁöÑÂëΩ‰ª§"><a href="#5-ÁºñËØë‰∏çÂêåÂπ≥Âè∞ÁöÑÂëΩ‰ª§" class="headerlink" title="5.ÁºñËØë‰∏çÂêåÂπ≥Âè∞ÁöÑÂëΩ‰ª§"></a>5.ÁºñËØë‰∏çÂêåÂπ≥Âè∞ÁöÑÂëΩ‰ª§</h5><p>APP_PLATFORM&#x3D;android-20 TARGET_ABI&#x3D;arm64-v8a .&#x2F;configure-android ‚Äìuse-ndk-cflags ‚Äìwith-ssl&#x3D;&#x2F;Users&#x2F;gaolei&#x2F;Desktop&#x2F;opensslarm64</p><p>APP_PLATFORM&#x3D;android-20 TARGET_ABI&#x3D;armeabi-v7a .&#x2F;configure-android ‚Äìuse-ndk-cflags ‚Äìwith-ssl&#x3D;&#x2F;Users&#x2F;gaolei&#x2F;Desktop&#x2F;opensslarm</p><p>APP_PLATFORM&#x3D;android-20 TARGET_ABI&#x3D;x86 .&#x2F;configure-android ‚Äìuse-ndk-cflags ‚Äìwith-ssl&#x3D;&#x2F;Users&#x2F;gaolei&#x2F;Desktop&#x2F;opensslx86</p><p>APP_PLATFORM&#x3D;android-20 TARGET_ABI&#x3D;x86_64 .&#x2F;configure-android ‚Äìuse-ndk-cflags ‚Äìwith-ssl&#x3D;&#x2F;Users&#x2F;gaolei&#x2F;Desktop&#x2F;opensslx86_64</p><p>make dep &amp;&amp; make clean &amp;&amp; make</p><h6 id="6-cd-pjsip-apps-x2F-src-x2F-swig-make"><a href="#6-cd-pjsip-apps-x2F-src-x2F-swig-make" class="headerlink" title="6.cd pjsip-apps&#x2F;src&#x2F;swig make"></a>6.cd pjsip-apps&#x2F;src&#x2F;swig make</h6><p>ÊØèÊ¨°ÊâßË°åÂ¶Ç‰∏äÊ≠•È™§ÔºåÊúÄÂêéÁîüÊàê‰∏ÄÂ•ócpuÊû∂ÊûÑÁöÑÂ∫ìÔºå‰Ωç‰∫é<br>pjsip-apps&#x2F;src&#x2F;swig&#x2F;java&#x2F;android&#x2F;pjsua2&#x2F;jniLibs,ÂèØ‰ª•ÂÖàÂ§çÂà∂Âá∫Êù•ÔºåÂõ†‰∏∫make clean‰πãÂêé‰ºöÂà†Èô§ÊéâÔºåËøôÊ†∑Â¶Ç‰∏äÊ≠•È™§Â¶ÇÊ≠§ÂèçÂ§çÔºåÂç≥ÂèØÁîüÊàêÂ§öÂ•óÂ∫ì„ÄÇ</p><h2 id="3-Â∞ÜÁºñËØëÁîüÊàêÁöÑ-soÊñá‰ª∂ÊîæÂà∞È°πÁõÆÈáå-ÁºñËØëËøêË°å-‰øÆÊîπÁõ∏ÂÖ≥‰ª£Á†Å-ËÉΩË∑ëËµ∑Êù•-ÁôªÂΩïÂèëÊ∂àÊÅØÈÉΩÊ≠£Â∏∏-ÊÑèÂë≥ÁùÄÁºñËØëÊàêÂäü"><a href="#3-Â∞ÜÁºñËØëÁîüÊàêÁöÑ-soÊñá‰ª∂ÊîæÂà∞È°πÁõÆÈáå-ÁºñËØëËøêË°å-‰øÆÊîπÁõ∏ÂÖ≥‰ª£Á†Å-ËÉΩË∑ëËµ∑Êù•-ÁôªÂΩïÂèëÊ∂àÊÅØÈÉΩÊ≠£Â∏∏-ÊÑèÂë≥ÁùÄÁºñËØëÊàêÂäü" class="headerlink" title="3.Â∞ÜÁºñËØëÁîüÊàêÁöÑ.soÊñá‰ª∂ÊîæÂà∞È°πÁõÆÈáå ÁºñËØëËøêË°å ‰øÆÊîπÁõ∏ÂÖ≥‰ª£Á†Å ËÉΩË∑ëËµ∑Êù• ÁôªÂΩïÂèëÊ∂àÊÅØÈÉΩÊ≠£Â∏∏ ÊÑèÂë≥ÁùÄÁºñËØëÊàêÂäü"></a>3.Â∞ÜÁºñËØëÁîüÊàêÁöÑ.soÊñá‰ª∂ÊîæÂà∞È°πÁõÆÈáå ÁºñËØëËøêË°å ‰øÆÊîπÁõ∏ÂÖ≥‰ª£Á†Å ËÉΩË∑ëËµ∑Êù• ÁôªÂΩïÂèëÊ∂àÊÅØÈÉΩÊ≠£Â∏∏ ÊÑèÂë≥ÁùÄÁºñËØëÊàêÂäü</h2>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;1-‰∏ãËΩΩËµÑÊ∫ê&quot;&gt;&lt;a href=&quot;#1-‰∏ãËΩΩËµÑÊ∫ê&quot; class=&quot;headerlink&quot; title=&quot;1.‰∏ãËΩΩËµÑÊ∫ê&quot;&gt;&lt;/a&gt;1.‰∏ãËΩΩËµÑÊ∫ê&lt;/h2&gt;&lt;h3 id=&quot;1-1-‰∏ãËΩΩopenssl&quot;&gt;&lt;a href=&quot;#1-1-‰∏ãËΩΩopenssl&quot; class=&quot;he</summary>
      
    
    
    
    
  </entry>
  
  <entry>
    <title>3.SIPÁôªÂΩïÁõ∏ÂÖ≥‰ª£Á†ÅÊ¢≥ÁêÜ</title>
    <link href="https://courage-gl.github.io/xiaoalei.github.io/2022/04/16/3-SIP%E7%99%BB%E5%BD%95%E7%9B%B8%E5%85%B3%E4%BB%A3%E7%A0%81%E6%A2%B3%E7%90%86/"/>
    <id>https://courage-gl.github.io/xiaoalei.github.io/2022/04/16/3-SIP%E7%99%BB%E5%BD%95%E7%9B%B8%E5%85%B3%E4%BB%A3%E7%A0%81%E6%A2%B3%E7%90%86/</id>
    <published>2022-04-16T01:18:49.000Z</published>
    <updated>2022-04-16T02:31:34.763Z</updated>
    
    <content type="html"><![CDATA[<h2 id="1-ËæìÂÖ•Áî®Êà∑ÂêçÂØÜÁ†ÅÁôªÂΩï"><a href="#1-ËæìÂÖ•Áî®Êà∑ÂêçÂØÜÁ†ÅÁôªÂΩï" class="headerlink" title="1.ËæìÂÖ•Áî®Êà∑ÂêçÂØÜÁ†ÅÁôªÂΩï"></a>1.ËæìÂÖ•Áî®Êà∑ÂêçÂØÜÁ†ÅÁôªÂΩï</h2><p class="code-caption" data-lang="java" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="Code" data-labels_right=":" data-labels_copy=""><span class="code-caption-label"></span><a class="code-caption-copy"></a></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * ÁôªÂΩï </span></span><br><span class="line"><span class="comment">     * 1„ÄÅÊãøÂà∞ËæìÂÖ•Ê°ÜËæìÂÖ•ÁöÑÁî®Êà∑Âêç ÂØÜÁ†Å</span></span><br><span class="line"><span class="comment">     * 2.ÂØÜÁ†Å‰ΩøÁî®new SMSM3().toMD5Âä†ÂØÜ</span></span><br><span class="line"><span class="comment">     * 3.ÂèëÈÄÅSipManager.ACTION_SIP_ACCOUNT_CHANGEDÂπøÊí≠</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">        <span class="type">Intent</span> <span class="variable">publishIntent</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Intent</span>(SipManager.ACTION_SIP_ACCOUNT_CHANGED);</span><br><span class="line">        <span class="comment">// publishIntent.putExtra(Filter.FIELD_ACCOUNT, account);</span></span><br><span class="line">        publishIntent.putExtra(SipProfile.FIELD_USERNAME, account.username);</span><br><span class="line">        <span class="comment">//the password use md5 value</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">passMd5</span> <span class="operator">=</span> MD5.md5PassWord(account.data);</span><br><span class="line">        <span class="comment">//Áé∞Âú®ÊòØÊµãËØï,Áî®sm3Âä†ÂØÜ</span></span><br><span class="line"><span class="comment">//        if (BuildConfig.DEBUG)</span></span><br><span class="line">        passMd5 = <span class="keyword">new</span> <span class="title class_">SMSM3</span>().toMD5(account.data);</span><br><span class="line">        publishIntent.putExtra(SipProfile.FIELD_DATA, passMd5);</span><br><span class="line">        publishIntent.putExtra(<span class="string">&quot;token&quot;</span>, loginToken);</span><br><span class="line">        mPrefsWrapper.setPreferenceStringValue(PreferencesWrapper.LAST_LOGIN_USERNAME,</span><br><span class="line">                account.username);</span><br><span class="line">        sendBroadcast(publishIntent);</span><br></pre></td></tr></table></figure><h3 id="1-1-SipManager-ACTION-SIP-ACCOUNT-CHANGEDÂπøÊí≠"><a href="#1-1-SipManager-ACTION-SIP-ACCOUNT-CHANGEDÂπøÊí≠" class="headerlink" title="1.1 SipManager.ACTION_SIP_ACCOUNT_CHANGEDÂπøÊí≠"></a>1.1 SipManager.ACTION_SIP_ACCOUNT_CHANGEDÂπøÊí≠</h3><p class="code-caption" data-lang="" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="Code" data-labels_right=":" data-labels_copy=""><span class="code-caption-label"></span><a class="code-caption-copy"></a></p><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> (action.equals(SipManager.ACTION_SIP_ACCOUNT_CHANGED)) &#123;</span><br><span class="line"> ¬† ¬† ¬† ¬† ¬† ¬†<span class="comment">// ‰∏∫ÁªüËÆ°Êú™ËØªÊ∂àÊÅØÂÅöÂ•ΩÂáÜÂ§á</span></span><br><span class="line">            service.notificationManager.build<span class="constructor">UnreadMessagesList()</span>;</span><br><span class="line"> ¬† ¬† ¬† ¬† ¬† ¬†<span class="comment">//ÊãøÂà∞Áî®Êà∑Âêç</span></span><br><span class="line"> ¬† ¬† ¬† ¬† ¬† ¬†final String username = intent.get<span class="constructor">StringExtra(SipProfile.FIELD_USERNAME)</span>;</span><br><span class="line"> ¬† ¬† ¬† ¬† ¬† ¬†<span class="comment">//ÊãøÂà∞ÂØÜÁ†Å</span></span><br><span class="line"> ¬† ¬† ¬† ¬† ¬† ¬†final String password = intent.get<span class="constructor">StringExtra(SipProfile.FIELD_DATA)</span>;</span><br><span class="line"> ¬† ¬† ¬† ¬† ¬† ¬†<span class="comment">//ÊãøÂà∞ tokenÔºàÊñ∞Â¢ûÔºâ</span></span><br><span class="line"> ¬† ¬† ¬† ¬† ¬† ¬†final String password = intent.get<span class="constructor">StringExtra(SipProfile.FIELD_DATA)</span>;</span><br><span class="line"> ¬† ¬† ¬† ¬† ¬† ¬†final String token = intent.get<span class="constructor">StringExtra(SipProfile.FIELD_TOKEN)</span>;</span><br><span class="line"> <span class="comment">// ÈÄöËøáNvÊäΩË±°Á±ªÂàõÂª∫account </span></span><br><span class="line"> ¬† ¬† ¬† ¬† ¬† ¬†SipProfile account = null;</span><br><span class="line">            <span class="keyword">if</span> (!<span class="module-access"><span class="module"><span class="identifier">TextUtils</span>.</span></span>is<span class="constructor">Empty(<span class="params">username</span>)</span><span class="operator"> &amp;&amp; </span>!<span class="module-access"><span class="module"><span class="identifier">TextUtils</span>.</span></span>is<span class="constructor">Empty(<span class="params">password</span>)</span>) &#123;</span><br><span class="line">                final SipProfile emptyAccount = <span class="keyword">new</span> <span class="constructor">SipProfile()</span>;</span><br><span class="line">                account = <span class="keyword">new</span> <span class="constructor">Nv()</span> &#123;</span><br><span class="line"></span><br><span class="line">                    @Override</span><br><span class="line">                    protected String get<span class="constructor">DisplayName()</span> &#123;</span><br><span class="line">                        return (!<span class="module-access"><span class="module"><span class="identifier">TextUtils</span>.</span></span>is<span class="constructor">Empty(<span class="params">emptyAccount</span>.<span class="params">display_name</span>)</span>) ? emptyAccount.display_name</span><br><span class="line">                                : service.get<span class="constructor">Resources()</span>.get<span class="constructor">String(R.<span class="params">string</span>.<span class="params">app_name</span>)</span>;</span><br><span class="line">                    &#125;</span><br><span class="line"><span class="comment">// Áªôaccount usernameËµãÂÄº</span></span><br><span class="line"> ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬†@Override</span><br><span class="line"> ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬†@Override</span><br><span class="line">                    protected String get<span class="constructor">UserName()</span> &#123;</span><br><span class="line">                        return username;</span><br><span class="line">                    &#125;</span><br><span class="line"><span class="comment">// Áªôaccount PasswordËµãÂÄº</span></span><br><span class="line">                    @Override</span><br><span class="line">                    protected String get<span class="constructor">Password()</span> &#123;</span><br><span class="line">                        return password;</span><br><span class="line">                    &#125;</span><br><span class="line"><span class="comment">// Áªôaccount tokenËµãÂÄº</span></span><br><span class="line">                    @Override</span><br><span class="line">                    protected String get<span class="constructor">Token()</span> &#123;</span><br><span class="line">                        return token;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    @Override</span><br><span class="line">                    protected String get<span class="constructor">ServerName()</span> &#123;</span><br><span class="line">                        return <span class="module-access"><span class="module"><span class="identifier">CustomDistribution</span>.</span></span>get<span class="constructor">DefaultAccountServer()</span>;</span><br><span class="line"><span class="comment">//                        return &quot;s&quot;+ DomainPreference.getBaseUrl();</span></span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;.build<span class="constructor">Account(<span class="params">emptyAccount</span>)</span>;</span><br><span class="line">                account.id = SipProfile.DEFAULT_ACCOUNT_ID;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="module-access"><span class="module"><span class="identifier">LogUtils</span>.</span></span>w(account);</span><br><span class="line">            </span><br><span class="line"> ¬† ¬† ¬† ¬† ¬† ¬†<span class="comment">// ÈªòËÆ§ accountId = SipProfile.INVALID_ID Â¶ÇÊûú‰∏çÁ≠â‰∫éËØ¥ÊòéÊú¨Âú∞Êï∞ÊçÆÊúâÂÄº ‰ªéÊú¨Âú∞Êï∞ÊçÆÂèñaccount</span></span><br><span class="line"> ¬† ¬† </span><br><span class="line"> ¬† ¬† ¬† ¬† ¬† ¬†<span class="keyword">if</span> (accountId != SipProfile.INVALID_ID) &#123;</span><br><span class="line">                account = service.get<span class="constructor">Account(<span class="params">accountId</span>)</span>;</span><br><span class="line">            &#125;</span><br><span class="line"> ¬† ¬† ¬† ¬† ¬† ¬†<span class="comment">// ÂºÄÂßãÁôªÂΩï</span></span><br><span class="line">            <span class="keyword">if</span> (account != null) &#123;</span><br><span class="line">                changeAccount = <span class="literal">true</span>;</span><br><span class="line">                service.set<span class="constructor">AccountRegistration(<span class="params">account</span>, <span class="params">account</span>.<span class="params">active</span> ? 1 : 0, <span class="params">true</span>)</span>;</span><br><span class="line">            &#125;</span><br></pre></td></tr></table></figure><h3 id="1-2-service-setAccountRegistration-account-account-active-1-0-true"><a href="#1-2-service-setAccountRegistration-account-account-active-1-0-true" class="headerlink" title="1.2 service.setAccountRegistration(account, account.active ? 1 : 0, true);"></a>1.2 service.setAccountRegistration(account, account.active ? 1 : 0, true);</h3><p class="code-caption" data-lang="java" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="Code" data-labels_right=":" data-labels_copy=""><span class="code-caption-label"></span><a class="code-caption-copy"></a></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * ÁôªÂΩïÊàñËÄÖÊ≥®ÈîÄ</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> account Ë¥¶Âè∑‰ø°ÊÅØ</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> renew 1ÊàñËÄÖ0 1ÊòØÁôªÂΩï 0ÊòØÊ≥®ÈîÄ</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> forceReAdd ÊòØÂê¶Âº∫Âà∂</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">    * <span class="doctag">@throws</span> SameThreadException</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">setAccountRegistration</span><span class="params">(SipProfile account, <span class="type">int</span> renew, <span class="type">boolean</span> forceReAdd)</span></span><br><span class="line">           <span class="keyword">throws</span> SameThreadException &#123;</span><br><span class="line">       LogUtils.e(<span class="string">&quot;Ë¥¶Âè∑Ê≥®ÂÜåÊàñËÄÖÊ≥®ÈîÄ: %s , %d ,%s&quot;</span>, account.username, renew, forceReAdd);</span><br><span class="line">       <span class="type">boolean</span> <span class="variable">status</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">       <span class="keyword">if</span> (pjService != <span class="literal">null</span>) &#123;</span><br><span class="line">           status = pjService.setAccountRegistration(account, renew, forceReAdd);</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="keyword">return</span> status;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure><h3 id="1-3pjService-setAccountRegistration-account-renew-forceReAdd"><a href="#1-3pjService-setAccountRegistration-account-renew-forceReAdd" class="headerlink" title="1.3pjService.setAccountRegistration(account, renew, forceReAdd);"></a>1.3pjService.setAccountRegistration(account, renew, forceReAdd);</h3><p class="code-caption" data-lang="" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="Code" data-labels_right=":" data-labels_copy=""><span class="code-caption-label"></span><a class="code-caption-copy"></a></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Change account registration / adding state</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> account    The account to modify registration</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> renew      if 0 we ask for deletion of this account; if 1 we ask for</span></span><br><span class="line"><span class="comment">    *                   registration of this account (and add if necessary)</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> forceReAdd if true, we will first remove the account and then</span></span><br><span class="line"><span class="comment">    *                   re-add it</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span> true if the operation get completed without problem</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@throws</span> SameThreadException</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">setAccountRegistration</span><span class="params">(SipProfile account, <span class="type">int</span> renew, <span class="type">boolean</span> forceReAdd)</span></span><br><span class="line">           <span class="keyword">throws</span> SameThreadException &#123;</span><br><span class="line">       <span class="type">int</span> <span class="variable">status</span> <span class="operator">=</span> -<span class="number">1</span>;</span><br><span class="line"><span class="comment">//       if (!created || account == null) &#123;</span></span><br><span class="line"><span class="comment">//           LogUtils.e(&quot;PJSIP is not started here, nothing can be done&quot;);</span></span><br><span class="line"><span class="comment">//           return false;</span></span><br><span class="line"><span class="comment">//       &#125;</span></span><br><span class="line">       <span class="keyword">if</span> (account.id == SipProfile.INVALID_ID) &#123;</span><br><span class="line">           LogUtils.e(<span class="string">&quot;Trying to set registration on a deleted account&quot;</span>);</span><br><span class="line">           <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="type">SipProfileState</span> <span class="variable">profileState</span> <span class="operator">=</span> getProfileState(account);</span><br><span class="line">       LogUtils.e(<span class="string">&quot;Ë¥¶Âè∑Ê≥®ÂÜåÊàñËÄÖÁôªÈôÜÊúçÂä°: %s&quot;</span>, profileState);</span><br><span class="line">       <span class="comment">// If local account -- Ensure we are not deleting, because this would be</span></span><br><span class="line">       <span class="comment">// invalid</span></span><br><span class="line">       <span class="keyword">if</span> (profileState.getWizard().equalsIgnoreCase(WizardUtils.LOCAL_WIZARD_TAG)) &#123;</span><br><span class="line">           <span class="keyword">if</span> (renew == <span class="number">0</span>) &#123;</span><br><span class="line">               <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="type">SipAccountMgr</span> <span class="variable">accountMgr</span> <span class="operator">=</span> SipAccountMgr.getInstance();</span><br><span class="line">       <span class="keyword">final</span> <span class="type">int</span> <span class="variable">accountId</span> <span class="operator">=</span> profileState.getPjsuaId();</span><br><span class="line"></span><br><span class="line">       LogUtils.e(<span class="string">&quot;setAccountRegistration accountId:&quot;</span> + accountId);</span><br><span class="line"></span><br><span class="line">       <span class="comment">// In case of already added, we have to act finely</span></span><br><span class="line">       <span class="comment">// If it&#x27;s local we can just consider that we have to re-add account</span></span><br><span class="line">       <span class="comment">// since it will actually just touch the account with a modify</span></span><br><span class="line">       <span class="keyword">if</span> (profileState.isAddedToStack()</span><br><span class="line">               &amp;&amp; !profileState.getWizard().equalsIgnoreCase(WizardUtils.LOCAL_WIZARD_TAG)) &#123;</span><br><span class="line">           LogUtil.log(<span class="string">&quot;aaaaaaaaaaaaaaaaaaaaaa&quot;</span>);</span><br><span class="line">           <span class="comment">// The account is already there in accounts list</span></span><br><span class="line">           <span class="keyword">try</span> &#123;</span><br><span class="line">               service.getContentResolver().delete(</span><br><span class="line">                       ContentUris.withAppendedId(SipProfile.ACCOUNT_STATUS_URI, account.id), <span class="literal">null</span>,</span><br><span class="line">                       <span class="literal">null</span>);</span><br><span class="line">           &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">               Log.e(THIS_FILE, <span class="string">&quot;&quot;</span>, e);</span><br><span class="line">           &#125;</span><br><span class="line">           LogUtils.w(<span class="string">&quot;Account already added to stack, remove and re-load or delete&quot;</span>);</span><br><span class="line">           <span class="keyword">if</span> (renew == <span class="number">1</span>) &#123;</span><br><span class="line">               <span class="keyword">if</span> (forceReAdd) &#123;</span><br><span class="line">                   <span class="comment">//status = pjsua.acc_del(profileState.getPjsuaId());</span></span><br><span class="line">                   status = accountMgr.delAccount(accountId) ? <span class="number">0</span> : -<span class="number">1</span>;</span><br><span class="line">                   addAccount(account);</span><br><span class="line">               &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                   accountMgr.setOnlineStatus(accountId, <span class="number">1</span> == getOnlineForStatus(service.getPresence()));</span><br><span class="line">                   status = accountMgr.setRegistration(accountId, renew == <span class="number">1</span>) ? <span class="number">0</span> : <span class="number">1</span>;</span><br><span class="line">                   <span class="comment">/*pjsua.acc_set_online_status(profileState.getPjsuaId(),</span></span><br><span class="line"><span class="comment">                           getOnlineForStatus(service.getPresence()));*/</span></span><br><span class="line">                   <span class="comment">//status = pjsua.acc_set_registration(profileState.getPjsuaId(), renew);</span></span><br><span class="line">               &#125;</span><br><span class="line">           &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">               <span class="comment">// if(status == pjsuaConstants.PJ_SUCCESS &amp;&amp; renew == 0) &#123;</span></span><br><span class="line">               LogUtils.w(<span class="string">&quot;Delete account !!&quot;</span>);</span><br><span class="line">               <span class="comment">//status = pjsua.acc_del(profileState.getPjsuaId());</span></span><br><span class="line">               status = accountMgr.delAccount(accountId) ? <span class="number">0</span> : -<span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">           &#125;</span><br><span class="line">       &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">           LogUtil.log(<span class="string">&quot;bbbbbbbbbbbbbbbbbbbbbbb&quot;</span>);</span><br><span class="line">           <span class="keyword">if</span> (renew == <span class="number">1</span>) &#123;</span><br><span class="line">               addAccount(account);</span><br><span class="line">           &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">               LogUtils.e(<span class="string">&quot;Ask to unregister an unexisting account !! %s&quot;</span> + account.id);</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">       &#125;</span><br><span class="line">       <span class="comment">// PJ_SUCCESS = 0</span></span><br><span class="line">       <span class="type">return</span> <span class="variable">status</span> <span class="operator">=</span>= <span class="number">0</span>;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Â∞ÜÊâÄÊúâÁöÑË¥¶Âè∑ÁöÑÊï∞ÊçÆÂ∫ìÂ≠òÂÇ®ÁöÑÁä∂ÊÄÅÊ†áËØÜ‰∏∫Á¶ªÁ∫øÔºåÁΩëÁªúÊñ≠ÂºÄÊó∂UIÊçÆÊ≠§ÊòæÁ§∫Áä∂ÊÄÅ</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setAccountStatusOffline</span><span class="params">()</span> &#123;</span><br><span class="line">       <span class="type">ContentValues</span> <span class="variable">cv</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ContentValues</span>();</span><br><span class="line"></span><br><span class="line">       <span class="comment">// Should be fine : status code are coherent with RFC</span></span><br><span class="line">       <span class="comment">// status codes</span></span><br><span class="line">       <span class="comment">//Ê†áËØÜ‰∏∫ÁΩëÁªúÊñ≠ÂºÄ</span></span><br><span class="line">       cv.put(SipProfileState.STATUS_CODE, SipCallSession.StatusCode.PJSIP_SC_BAD_GATEWAY);</span><br><span class="line"></span><br><span class="line">       cv.put(SipProfileState.STATUS_TEXT, <span class="string">&quot;&quot;</span>);</span><br><span class="line">       cv.put(SipProfileState.EXPIRES, <span class="string">&quot;&quot;</span>);</span><br><span class="line"></span><br><span class="line">       <span class="type">Cursor</span> <span class="variable">c</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">       <span class="keyword">try</span> &#123;</span><br><span class="line">           c = service.getContentResolver().query(SipProfile.ACCOUNT_URI,</span><br><span class="line">                   DBProvider.ACCOUNT_FULL_PROJECTION, <span class="literal">null</span>, <span class="literal">null</span>, <span class="literal">null</span>);</span><br><span class="line">           <span class="keyword">if</span> (c != <span class="literal">null</span> &amp;&amp; c.moveToFirst()) &#123;</span><br><span class="line">               <span class="keyword">do</span> &#123;</span><br><span class="line">                   <span class="type">SipProfile</span> <span class="variable">account</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SipProfile</span>(c);</span><br><span class="line">                   service.getContentResolver().update(ContentUris.withAppendedId(SipProfile.ACCOUNT_STATUS_URI,</span><br><span class="line">                           account.id), cv, <span class="literal">null</span>,</span><br><span class="line">                           <span class="literal">null</span>);</span><br><span class="line">               &#125; <span class="keyword">while</span> (c.moveToNext());</span><br><span class="line">           &#125;</span><br><span class="line">       &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">           LogUtils.e(<span class="string">&quot;Error on looping over sip profiles&quot;</span>, e);</span><br><span class="line">       &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">           <span class="keyword">if</span> (c != <span class="literal">null</span>) &#123;</span><br><span class="line">               c.close();</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure><h3 id="1-4-addAccount-account"><a href="#1-4-addAccount-account" class="headerlink" title="1.4 addAccount(account);"></a>1.4 addAccount(account);</h3><p class="code-caption" data-lang="java" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="Code" data-labels_right=":" data-labels_copy=""><span class="code-caption-label"></span><a class="code-caption-copy"></a></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">addAccount</span><span class="params">(SipProfile profile)</span> <span class="keyword">throws</span> SameThreadException &#123;</span><br><span class="line">        <span class="keyword">if</span> (profile != <span class="literal">null</span>)</span><br><span class="line">            LogUtil.log(<span class="string">&quot;Ê∑ªÂä†Ë¥¶Âè∑&quot;</span>, profile.username, profile.display_name);</span><br><span class="line">        <span class="type">int</span> <span class="variable">status</span> <span class="operator">=</span> pjsuaConstants.PJ_FALSE;</span><br><span class="line">        <span class="keyword">if</span> (!created) &#123;</span><br><span class="line">            Log.e(THIS_FILE, <span class="string">&quot;PJSIP is not started here, nothing can be done&quot;</span>);</span><br><span class="line">            <span class="type">return</span> <span class="variable">status</span> <span class="operator">=</span>= pjsuaConstants.PJ_SUCCESS;</span><br><span class="line">        &#125;</span><br><span class="line"><span class="comment">//    </span></span><br><span class="line"></span><br><span class="line">        <span class="type">SipAccountMgr</span> <span class="variable">accountMgr</span> <span class="operator">=</span> SipAccountMgr.getInstance();</span><br><span class="line">        <span class="type">SipProfileState</span> <span class="variable">currentAccountStatus</span> <span class="operator">=</span> getProfileState(profile);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (currentAccountStatus.isAddedToStack()) &#123;</span><br><span class="line">            <span class="comment">//Â¶ÇÊûúÁôªÈôÜËøá,‰ªéÊï∞ÊçÆÂ∫ì‰∏≠Êü•ËØ¢‰∏çÂà∞</span></span><br><span class="line">            beforeAccountRegistration(currentAccountStatus.getPjsuaId(), profile);</span><br><span class="line">            <span class="type">ContentValues</span> <span class="variable">cv</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ContentValues</span>();</span><br><span class="line">            cv.put(SipProfileState.ADDED_STATUS, status);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                service.getContentResolver().update(</span><br><span class="line">                        ContentUris.withAppendedId(SipProfile.ACCOUNT_STATUS_ID_URI_BASE, profile.id),</span><br><span class="line">                        cv, <span class="literal">null</span>, <span class="literal">null</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                Log.e(THIS_FILE, <span class="string">&quot;&quot;</span>, e);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">assert</span> profile != <span class="literal">null</span>;</span><br><span class="line">            <span class="keyword">if</span> (!profile.wizard.equalsIgnoreCase(WizardUtils.LOCAL_WIZARD_TAG)) &#123;</span><br><span class="line">                <span class="comment">// Re register</span></span><br><span class="line">                <span class="keyword">if</span> (status == pjsuaConstants.PJ_SUCCESS) &#123;</span><br><span class="line">                    status = accountMgr.setRegistration(currentAccountStatus.getPjsuaId(), <span class="literal">true</span>) ? <span class="number">0</span> : <span class="number">1</span>;</span><br><span class="line">                    Log.e(<span class="string">&quot;accountMgr.setRegistration&quot;</span>, <span class="string">&quot;accountMgr.setRegistration&quot;</span>);</span><br><span class="line">                    <span class="comment">//status = pjsua.acc_set_registration(currentAccountStatus.getPjsuaId(), 1);</span></span><br><span class="line">                    <span class="keyword">if</span> (status == pjsuaConstants.PJ_SUCCESS) &#123;</span><br><span class="line">                        <span class="comment">//pjsua.acc_set_online_status(currentAccountStatus.getPjsuaId(), 1);</span></span><br><span class="line">                        accountMgr.setOnlineStatus(currentAccountStatus.getPjsuaId(), <span class="literal">true</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="type">SipAccount</span> <span class="variable">sipAccount</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">            <span class="type">int</span>[] accId = <span class="keyword">new</span> <span class="title class_">int</span>[<span class="number">1</span>];</span><br><span class="line">            <span class="keyword">if</span> (profile.wizard.equalsIgnoreCase(WizardUtils.LOCAL_WIZARD_TAG)) &#123;</span><br><span class="line">            </span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line"> ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬†<span class="comment">// ÁôªÂΩïË∞ÉÁî®ÁöÑÊñπÊ≥ï</span></span><br><span class="line"> ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† <span class="keyword">if</span> ((sipAccount = accountMgr.addAccount(profile)) != <span class="literal">null</span>) &#123;</span><br><span class="line">                        status = pjsuaConstants.PJ_SUCCESS;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//Â¶ÇÊûúÈ¶ñÊ¨°ÁôªÈôÜÊàêÂäüÔºå‰ºöÊèíÂÖ•Âà∞Êï∞ÊçÆÂ∫ìÁöÑ,</span></span><br><span class="line">            <span class="keyword">if</span> (status == pjsuaConstants.PJ_SUCCESS) &#123;</span><br><span class="line">                <span class="type">SipProfileState</span> <span class="variable">ps</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SipProfileState</span>(profile);</span><br><span class="line">                ps.setAddedStatus(status);</span><br><span class="line">                accId[<span class="number">0</span>] = sipAccount.getId();</span><br><span class="line">                ps.setPjsuaId(accId[<span class="number">0</span>]);</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    service.getContentResolver().insert(</span><br><span class="line">                            ContentUris.withAppendedId(SipProfile.ACCOUNT_STATUS_ID_URI_BASE,</span><br><span class="line">                                    profile.id), ps.getAsContentValue());</span><br><span class="line"></span><br><span class="line">                    <span class="comment">//Ê≥®ÂÜåÊàêÂäüÔºå‰øÆÊîπMyApplicationÁöÑË¥¶Âè∑‰ø°ÊÅØ</span></span><br><span class="line">                    <span class="type">MyApplication</span> <span class="variable">app</span> <span class="operator">=</span> (MyApplication) service.getApplicationContext();</span><br><span class="line">                    app.changeCurrentSignedAccount(profile);</span><br><span class="line"></span><br><span class="line">                &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                    Log.e(THIS_FILE, <span class="string">&quot;&quot;</span>, e);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">return</span> <span class="variable">status</span> <span class="operator">=</span>= pjsuaConstants.PJ_SUCCESS;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><h3 id="1-5-accountMgr-addAccount-profile"><a href="#1-5-accountMgr-addAccount-profile" class="headerlink" title="1.5 accountMgr.addAccount(profile)"></a>1.5 accountMgr.addAccount(profile)</h3><p class="code-caption" data-lang="java" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="Code" data-labels_right=":" data-labels_copy=""><span class="code-caption-label"></span><a class="code-caption-copy"></a></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> SipAccount <span class="title function_">addAccount</span><span class="params">(SipProfile sipProfile)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="keyword">if</span> (!SipMain.getInstance().hasInitialized()) &#123;</span><br><span class="line">        LogUtil.log(<span class="string">&quot;addAccount sip stack not ready&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">SipAccountConfig</span> <span class="variable">accountConfig</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SipAccountConfig</span>();</span><br><span class="line">    <span class="comment">//account config</span></span><br><span class="line">    <span class="type">AccountConfig</span> <span class="variable">config</span> <span class="operator">=</span> accountConfig.accCfg;</span><br><span class="line">    config.setIdUri(SipUri.getDefaultSipUri(sipProfile.getUserName()));</span><br><span class="line">    config.getRegConfig().setRegistrarUri(sipProfile.reg_uri);</span><br><span class="line">    LogUtil.log(<span class="string">&quot;sipProfile.reg_uri==&quot;</span> + sipProfile.reg_uri);</span><br><span class="line"></span><br><span class="line">    <span class="type">SipHeaderVector</span> <span class="variable">headerVector</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SipHeaderVector</span>();</span><br><span class="line">    <span class="type">SipHeader</span> <span class="variable">sipHeader</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SipHeader</span>();</span><br><span class="line">    sipHeader.setHName(<span class="string">&quot;Client-ID&quot;</span>);</span><br><span class="line">    sipHeader.setHValue(DeviceIdFactory.getInstance(MyApplication.getApplication()).getDeviceUuid() + <span class="string">&quot;-com-chinaums-umschat2&quot;</span>);</span><br><span class="line">    <span class="type">SipHeader</span> <span class="variable">sipHeader1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SipHeader</span>();</span><br><span class="line">    sipHeader1.setHName(<span class="string">&quot;Platform&quot;</span>);</span><br><span class="line">    sipHeader1.setHValue(<span class="string">&quot;Android&quot;</span>);</span><br><span class="line">    <span class="type">SipHeader</span> <span class="variable">sipHeader2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SipHeader</span>();</span><br><span class="line">    sipHeader2.setHName(<span class="string">&quot;UAVersion&quot;</span>);</span><br><span class="line">    sipHeader2.setHValue(String.valueOf(SettingsUtils.getAppVersionCode(MyApplication.getApplication())));</span><br><span class="line">    <span class="type">SipHeader</span> <span class="variable">sipHeader3</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SipHeader</span>();</span><br><span class="line">    sipHeader3.setHName(<span class="string">&quot;deviceId&quot;</span>);</span><br><span class="line">    sipHeader3.setHValue(SettingsUtils.getAndroidId(MyApplication.getApplication()));</span><br><span class="line">    headerVector.add(sipHeader);</span><br><span class="line">    headerVector.add(sipHeader1);</span><br><span class="line">    headerVector.add(sipHeader2);</span><br><span class="line">    headerVector.add(sipHeader3);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="literal">null</span> != sipProfile.getToken()) &#123;</span><br><span class="line">        token = sipProfile.getToken();</span><br><span class="line">        addTokenHeader(token,headerVector);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!SharedPreferencesUtil.getString(MyApplication.getApplication(), <span class="string">&quot;token&quot;</span>, <span class="string">&quot;&quot;</span>).isEmpty()) &#123;</span><br><span class="line">        token = SharedPreferencesUtil.getString(MyApplication.getApplication(), <span class="string">&quot;token&quot;</span>, <span class="string">&quot;&quot;</span>);</span><br><span class="line">        addTokenHeader(token,headerVector);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        token = sipProfile.getPassword();</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">//    token = sipProfile.getPassword();</span></span><br><span class="line">    config.getRegConfig().setHeaders(headerVector);</span><br><span class="line">    <span class="type">AuthCredInfo</span> <span class="variable">authCredInfo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AuthCredInfo</span>(sipProfile.scheme, sipProfile.realm, sipProfile.getUserName(), sipProfile.datatype, token);</span><br><span class="line"><span class="comment">//   Log.d(&quot;CLIENT-ID&quot;,DeviceIdFactory.getInstance(MyApplication.getApplication()).getDeviceUuid()+sipProfile.username);</span></span><br><span class="line">    <span class="comment">//nat config</span></span><br><span class="line">    config.getNatConfig().setContactRewriteUse(sipProfile.allow_contact_rewrite ? pjsuaConstants.PJ_TRUE</span><br><span class="line">            : pjsuaConstants.PJ_FALSE);</span><br><span class="line">    LogUtil.log(<span class="string">&quot;sipProfile.allow_contact_rewrite==&quot;</span> + sipProfile.allow_contact_rewrite + <span class="string">&quot;&quot;</span>);</span><br><span class="line">    <span class="comment">//keep alive interval ‰øùÊåÅÊ¥ªÂä®Èó¥Èöî</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//    ËÆæÁΩÆÊ≥®ÂÜåÂ§±Ë¥•ÈáçËØïÊú∫Âà∂</span></span><br><span class="line">    <span class="comment">//Ëá™Âä®Ê≥®ÂÜåÊó∂Èó¥Èó¥ÈöîÔºåÈªòËÆ§300ÁßíÔºåÂç≥ÊØè5ÂàÜÈíüÊ≥®ÂÜå‰∏ÄÊ¨°</span></span><br><span class="line">    config.getRegConfig().setTimeoutSec(<span class="number">65</span>);</span><br><span class="line">    <span class="comment">//Ê≥®ÂÜåÂ§±Ë¥•ÂêéÔºåÈ¶ñÊ¨°‰ªéÊñ∞Ê≥®ÂÜåÊó∂Èó¥ÔºåÈªòËÆ§0ÔºåÂΩìÂç≥ÂèëËµ∑‰ªéÊñ∞Ê≥®ÂÜå</span></span><br><span class="line">    config.getRegConfig().setFirstRetryIntervalSec(<span class="number">0</span>);</span><br><span class="line">    <span class="comment">//Ê≥®ÂÜåÂ§±Ë¥•ÂêéÔºå‰ªéÊñ∞ÂèëËµ∑Ê≥®ÂÜåÁöÑÊó∂Èó¥Èó¥ÈöîÔºåÈªòËÆ§300Áßí</span></span><br><span class="line">    config.getRegConfig().setRetryIntervalSec(<span class="number">10</span>);</span><br><span class="line">    <span class="comment">//‰ªéÊñ∞ÂèëËµ∑Ê≥®ÂÜåÁöÑÊó∂Èó¥ÈöèÊú∫ËåÉÂõ¥Ôºà‰∏∫‰∫Ü‰∏çÂ§öÂ∏êÊà∑Áä∂ÂÜµ‰∏ãÂêåÊó∂ÂèëËµ∑Ê≥®ÂÜåÔºâÔºå</span></span><br><span class="line">    <span class="comment">// Ê≠£Ë¥ü5ÔºåÂÆûÈôÖÊó∂Èó¥ÊòØ60~70ÁßíÔºåÈªòËÆ§10Áßí</span></span><br><span class="line">    config.getRegConfig().setRandomRetryIntervalSec(<span class="number">5</span>);</span><br><span class="line">    <span class="comment">//Ê≥®ÂÜåË∂ÖÊó∂ÂâçÔºàtimeoutSecÔºâÂ§öÈïøÊó∂Èó¥Âà∑Êñ∞ÂÆ¢Êà∑Á´ØÊ≥®ÂÜåÁä∂ÊÄÅÔºåÈªòËÆ§5Áßí</span></span><br><span class="line">    config.getRegConfig().setDelayBeforeRefreshSec(<span class="number">5</span>);</span><br><span class="line"><span class="comment">//    config.getNatConfig().setIceWaitNominationTimeoutMsec(30);</span></span><br><span class="line"><span class="comment">//    config.getCallConfig().setTimerMinSESec(30);</span></span><br><span class="line"><span class="comment">//    config.getCallConfig().setTimerSessExpiresSec(30);</span></span><br><span class="line">    config.getNatConfig().setUdpKaIntervalSec(PreferencesWrapper.getInstance(MyApplication.getContext()).getUdpKeepAliveInterval());</span><br><span class="line">    <span class="comment">//proxies</span></span><br><span class="line">    setProxies(sipProfile, config);</span><br><span class="line">    <span class="comment">//mwi</span></span><br><span class="line">    config.getMwiConfig().setEnabled(sipProfile.mwi_enabled ? <span class="literal">true</span> : <span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//account media config</span></span><br><span class="line">    config.getMediaConfig().setIpv6Use(sipProfile.ipv6_media_use == <span class="number">1</span> ? pjsua_ipv6_use.PJSUA_IPV6_ENABLED</span><br><span class="line">            : pjsua_ipv6_use.PJSUA_IPV6_DISABLED);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">// Transport</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">regUri</span> <span class="operator">=</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">    <span class="type">String</span> <span class="variable">argument</span> <span class="operator">=</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">    <span class="keyword">switch</span> (sipProfile.transport) &#123;</span><br><span class="line">        <span class="keyword">case</span> SipProfile.TRANSPORT_UDP:</span><br><span class="line">            argument = <span class="string">&quot;;transport=udp;lr&quot;</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> SipProfile.TRANSPORT_TCP:</span><br><span class="line">            argument = <span class="string">&quot;;transport=tcp;lr&quot;</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> SipProfile.TRANSPORT_TLS:</span><br><span class="line">            <span class="comment">// TODO : differentiate ssl/tls ?</span></span><br><span class="line">            argument = <span class="string">&quot;;transport=tls;lr&quot;</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    LogUtil.log(argument);</span><br><span class="line">    Log.e(<span class="string">&quot;argument&quot;</span>, argument);</span><br><span class="line">    <span class="keyword">if</span> (!TextUtils.isEmpty(argument)) &#123;</span><br><span class="line">        regUri = config.getRegConfig().getRegistrarUri();</span><br><span class="line">        <span class="keyword">if</span> (!TextUtils.isEmpty(regUri)) &#123;</span><br><span class="line">            <span class="type">long</span> <span class="variable">initialProxyCnt</span> <span class="operator">=</span> config.getSipConfig().getProxies().size();</span><br><span class="line">            <span class="type">StringVector</span> <span class="variable">proxies</span> <span class="operator">=</span> config.getSipConfig().getProxies();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// TODO : remove lr and transport from uri</span></span><br><span class="line">            <span class="comment">// cfg.setReg_uri(pjsua.pj_str_copy(proposed_server));</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">firstProxy</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">            <span class="keyword">if</span> (proxies.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                firstProxy = proxies.get(<span class="number">0</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (initialProxyCnt == <span class="number">0</span> || TextUtils.isEmpty(firstProxy)) &#123;</span><br><span class="line">                config.getRegConfig().setRegistrarUri(regUri + argument);</span><br><span class="line"><span class="comment">//                cfg.setProxy_cnt(0);</span></span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                proxies.set(<span class="number">0</span>, firstProxy + argument);</span><br><span class="line">                config.getSipConfig().setProxies(proxies);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">//sip config</span></span><br><span class="line">    <span class="keyword">if</span> (sipProfile.force_contact != <span class="literal">null</span>) &#123;</span><br><span class="line">        config.getSipConfig().setContactForced(sipProfile.force_contact);</span><br><span class="line">    &#125;</span><br><span class="line">    config.getSipConfig().getAuthCreds().add(authCredInfo);</span><br><span class="line"></span><br><span class="line">    <span class="type">SipAccount</span> <span class="variable">account</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SipAccount</span>(config);</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">//ÁôªÈôÜË¥¶Âè∑Ôºå‰∫§Áî±ÈÄöËÆØÊ®°ÂùóÂ§ÑÁêÜÔºåÂ¶ÇÊûúÂ§±Ë¥•‰∫ÜÔºåËøîÂõûnull ,ËøôÊòØ‰∏™ËÄóÊó∂ÊÄßÊìç‰Ωú</span></span><br><span class="line">        account.create(config);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Throwable error) &#123;</span><br><span class="line">        LogUtil.log(<span class="string">&quot;ÂàõÂª∫Ë¥¶Âè∑error&quot;</span>, error);</span><br><span class="line">        account = <span class="literal">null</span>;</span><br><span class="line">        Log.e(THIS_FILE, <span class="string">&quot;addAccount &quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (account != <span class="literal">null</span>) &#123;</span><br><span class="line">        LogUtil.log(<span class="string">&quot;addAccount success. &quot;</span> + sipProfile.getUserName() + <span class="string">&quot;  id:&quot;</span> + account.getId());</span><br><span class="line">        accounts.put(account.getId(), account);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> account;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="1-6-account-create-config"><a href="#1-6-account-create-config" class="headerlink" title="1.6  account.create(config);"></a>1.6  account.create(config);</h3><p class="code-caption" data-lang="java" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="Code" data-labels_right=":" data-labels_copy=""><span class="code-caption-label"></span><a class="code-caption-copy"></a></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">create</span><span class="params">(AccountConfig cfg)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    pjsua2JNI.Account_create__SWIG_1(<span class="built_in">this</span>.swigCPtr, <span class="built_in">this</span>, AccountConfig.getCPtr(cfg), cfg);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="2-Ê≥®ÈîÄ"><a href="#2-Ê≥®ÈîÄ" class="headerlink" title="2.Ê≥®ÈîÄ"></a>2.Ê≥®ÈîÄ</h2><p class="code-caption" data-lang="java" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="Code" data-labels_right=":" data-labels_copy=""><span class="code-caption-label"></span><a class="code-caption-copy"></a></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> (flag == LOGOUT) &#123;</span><br><span class="line">                   LogUtils.e(<span class="string">&quot;ÈÄÄÂá∫ÁôªÂΩï„ÄÇ„ÄÇ„ÄÇ„ÄÇ&quot;</span>);</span><br><span class="line">                   prefProviderWrapper.setPreferenceBooleanValue(</span><br><span class="line">                           PreferencesWrapper.SHOW_MINE_WORK_UNREAD, <span class="literal">false</span>);</span><br><span class="line">                   <span class="type">SharedPreferences</span> <span class="variable">preferences</span> <span class="operator">=</span> PreferenceManager.getDefaultSharedPreferences(getBaseContext());</span><br><span class="line">                   preferences.edit().remove(HomeActivity.keyCheckZuzhiJiagou).apply();</span><br><span class="line">                   preferences.edit().remove(<span class="string">&quot;isFirstLogin&quot;</span>).apply();</span><br><span class="line">                   getContentResolver().call(MyContentProvider.BaseUri,</span><br><span class="line">                           <span class="string">&quot;deleteOrg&quot;</span>, <span class="literal">null</span>, <span class="literal">null</span>); <span class="comment">// Ê∏ÖÈô§ÁªÑÁªáÊû∂ÊûÑ</span></span><br><span class="line">                   SessionManager.getInstance().resetSessionId(); <span class="comment">// Ê∏ÖÈô§ session</span></span><br><span class="line">                   getContentResolver().delete(SipProfile.ACCOUNT_URI, <span class="string">&quot;1&quot;</span>, <span class="literal">null</span>);</span><br><span class="line">                   <span class="type">Intent</span> <span class="variable">publishIntent</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Intent</span>(SipManager.ACTION_SIP_ACCOUNT_CHANGED);</span><br><span class="line">                   publishIntent.putExtra(SipProfile.FIELD_USERNAME, account.username);</span><br><span class="line">                   <span class="type">String</span> <span class="variable">passMd5</span> <span class="operator">=</span> MD5.md5PassWord(account.data);</span><br><span class="line">                   passMd5 = <span class="keyword">new</span> <span class="title class_">SMSM3</span>().toMD5(account.data);</span><br><span class="line">                   publishIntent.putExtra(SipProfile.FIELD_DATA, passMd5);</span><br><span class="line">                   sendBroadcast(publishIntent);</span><br><span class="line">                   <span class="keyword">try</span> &#123;</span><br><span class="line">                       <span class="comment">//remove all cookies</span></span><br><span class="line">                       CookieSyncManager.createInstance(UserSettingActivity.<span class="built_in">this</span>);</span><br><span class="line">                       CookieManager.getInstance().removeAllCookie();</span><br><span class="line">                   &#125; <span class="keyword">catch</span> (IllegalStateException e) &#123;</span><br><span class="line">                       Log.e(THIS_FILE, <span class="string">&quot;remove all cookies failed cause&quot;</span>, e.fillInStackTrace());</span><br><span class="line">                   &#125;</span><br><span class="line"></span><br><span class="line">                   sendBroadcast(<span class="keyword">new</span> <span class="title class_">Intent</span>(</span><br><span class="line">                           SipManager.ACTION_SIP_ACCOUNTS_DELETE));</span><br><span class="line">                   Manipulator.logout(UserSettingActivity.<span class="built_in">this</span>.getApplicationContext());</span><br><span class="line">¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬†<span class="comment">// Ë∑≥ËΩ¨Âà∞ÁôªÂΩïÈ°µÈù¢</span></span><br><span class="line">¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬†placeLogin();</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;);</span><br></pre></td></tr></table></figure><h3 id="2-1-SipManager-ACTION-SIP-ACCOUNT-CHANGE-Âêå‰∏ä1-1-‰∏çÂÜçËµòËø∞"><a href="#2-1-SipManager-ACTION-SIP-ACCOUNT-CHANGE-Âêå‰∏ä1-1-‰∏çÂÜçËµòËø∞" class="headerlink" title="2.1 SipManager.ACTION_SIP_ACCOUNT_CHANGE Âêå‰∏ä1.1 ‰∏çÂÜçËµòËø∞"></a>2.1 SipManager.ACTION_SIP_ACCOUNT_CHANGE Âêå‰∏ä1.1 ‰∏çÂÜçËµòËø∞</h3><h3 id="2-2-SipManager-ACTION-SIP-ACCOUNTS-DELETE"><a href="#2-2-SipManager-ACTION-SIP-ACCOUNTS-DELETE" class="headerlink" title="2.2 SipManager.ACTION_SIP_ACCOUNTS_DELETE"></a>2.2 SipManager.ACTION_SIP_ACCOUNTS_DELETE</h3><p class="code-caption" data-lang="java" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="Code" data-labels_right=":" data-labels_copy=""><span class="code-caption-label"></span><a class="code-caption-copy"></a></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> (SipManager.ACTION_SIP_ACCOUNTS_DELETE</span><br><span class="line">                .equals(intentAction)) &#123;</span><br><span class="line">            <span class="comment">// Added by txp 2016-2-29,Broadcast sent when we want to</span></span><br><span class="line">            <span class="comment">// unregister the current account and delete it.</span></span><br><span class="line">            deleteAllAccounts(context);</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure><h3 id="2-3-deleteAllAccounts-context"><a href="#2-3-deleteAllAccounts-context" class="headerlink" title="2.3  deleteAllAccounts(context);"></a>2.3  deleteAllAccounts(context);</h3><p class="code-caption" data-lang="java" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="Code" data-labels_right=":" data-labels_copy=""><span class="code-caption-label"></span><a class="code-caption-copy"></a></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * unregister all accounts and delete it</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">deleteAllAccounts</span><span class="params">(Context context)</span> &#123;</span><br><span class="line">        LogUtils.e(<span class="string">&quot;Âà†Èô§ÊâÄÊúâË¥¶Âè∑&quot;</span>);</span><br><span class="line">        LogUtils.e(<span class="string">&quot;Remove current account and delete it&quot;</span>);</span><br><span class="line">        <span class="type">Cursor</span> <span class="variable">c</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="type">Long</span> <span class="variable">id</span> <span class="operator">=</span> SipProfile.INVALID_ID;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            c = context.getContentResolver().query(SipProfile.ACCOUNT_URI,</span><br><span class="line">                    <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;</span><br><span class="line">                            SipProfile.FIELD_ID</span><br><span class="line">                    &#125;, <span class="literal">null</span>, <span class="literal">null</span>, <span class="literal">null</span>);</span><br><span class="line">            <span class="keyword">if</span> (c != <span class="literal">null</span> &amp;&amp; c.moveToFirst()) &#123;</span><br><span class="line">                <span class="keyword">do</span> &#123;</span><br><span class="line">                    id = c.getLong(c.getColumnIndex(SipProfile.FIELD_ID));</span><br><span class="line">                    context.getContentResolver().delete(ContentUris.withAppendedId(</span><br><span class="line">                            SipProfile.ACCOUNT_ID_URI_BASE, id), <span class="literal">null</span>, <span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line">                &#125; <span class="keyword">while</span> (c.moveToNext());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            Log.e(THIS_FILE, <span class="string">&quot;Error on looping delete over sip profiles&quot;</span>, e);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (c != <span class="literal">null</span>) &#123;</span><br><span class="line">                c.close();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><h2 id="3-ÈÄÄÂá∫"><a href="#3-ÈÄÄÂá∫" class="headerlink" title="3.ÈÄÄÂá∫"></a>3.ÈÄÄÂá∫</h2><p class="code-caption" data-lang="java" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="Code" data-labels_right=":" data-labels_copy=""><span class="code-caption-label"></span><a class="code-caption-copy"></a></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">prefProviderWrapper.setPreferenceBooleanValue(</span><br><span class="line">                          PreferencesWrapper.HAS_BEEN_QUIT, <span class="literal">true</span>);</span><br><span class="line">                  LauncherUI.needShowWelcomeLogo = <span class="literal">true</span>;</span><br><span class="line">                  <span class="type">Intent</span> <span class="variable">intent</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Intent</span>(</span><br><span class="line">                          SipManager.ACTION_SIP_ACCOUNTS_UNREGISTER);</span><br><span class="line">                  sendBroadcast(intent);</span><br><span class="line">                  disconnect(<span class="literal">true</span>);</span><br></pre></td></tr></table></figure><h3 id="3-1-SipManager-ACTION-SIP-ACCOUNTS-UNREGISTER"><a href="#3-1-SipManager-ACTION-SIP-ACCOUNTS-UNREGISTER" class="headerlink" title="3.1 SipManager.ACTION_SIP_ACCOUNTS_UNREGISTER"></a>3.1 SipManager.ACTION_SIP_ACCOUNTS_UNREGISTER</h3><p class="code-caption" data-lang="java" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="Code" data-labels_right=":" data-labels_copy=""><span class="code-caption-label"></span><a class="code-caption-copy"></a></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> (action.equals(SipManager.ACTION_SIP_ACCOUNTS_UNREGISTER)) &#123;</span><br><span class="line">                        <span class="keyword">try</span> &#123;</span><br><span class="line">                            unregisterAllAccounts(<span class="literal">true</span>);</span><br><span class="line">                        &#125; <span class="keyword">catch</span> (SameThreadException e) &#123;</span><br><span class="line">                            Log.e(THIS_FILE, <span class="string">&quot;unregister accounts failed&quot;</span>);</span><br><span class="line">                        &#125;</span><br></pre></td></tr></table></figure><h3 id="3-2-unregisterAllAccounts-true"><a href="#3-2-unregisterAllAccounts-true" class="headerlink" title="3.2  unregisterAllAccounts(true);"></a>3.2  unregisterAllAccounts(true);</h3><p class="code-caption" data-lang="java" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="Code" data-labels_right=":" data-labels_copy=""><span class="code-caption-label"></span><a class="code-caption-copy"></a></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * unregister all accounts</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">unregisterAllAccounts</span><span class="params">(<span class="type">boolean</span> needRunOnSipExecutor)</span> <span class="keyword">throws</span> SameThreadException &#123;</span><br><span class="line"></span><br><span class="line">       <span class="type">Runnable</span> <span class="variable">runnable</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Runnable</span>() &#123;</span><br><span class="line">           <span class="meta">@Override</span></span><br><span class="line">           <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">               releaseResources();</span><br><span class="line">               Log.d(THIS_FILE, <span class="string">&quot;Remove all accounts&quot;</span>);</span><br><span class="line">               <span class="type">Cursor</span> <span class="variable">c</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">               <span class="keyword">try</span> &#123;</span><br><span class="line">                   c = getContentResolver().query(SipProfile.ACCOUNT_URI,</span><br><span class="line">                           DBProvider.ACCOUNT_FULL_PROJECTION, <span class="literal">null</span>, <span class="literal">null</span>, <span class="literal">null</span>);</span><br><span class="line">                   <span class="keyword">if</span> (c != <span class="literal">null</span> &amp;&amp; c.moveToFirst()) &#123;</span><br><span class="line">                       <span class="keyword">do</span> &#123;</span><br><span class="line">                           <span class="type">SipProfile</span> <span class="variable">account</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SipProfile</span>(c);</span><br><span class="line">                           setAccountRegistration(account, <span class="number">0</span>, <span class="literal">false</span>);</span><br><span class="line">                       &#125; <span class="keyword">while</span> (c.moveToNext());</span><br><span class="line">                   &#125;</span><br><span class="line">               &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                   Log.e(THIS_FILE, <span class="string">&quot;Error on looping over sip profiles&quot;</span>, e);</span><br><span class="line">               &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                   <span class="keyword">if</span> (c != <span class="literal">null</span>) &#123;</span><br><span class="line">                       c.close();</span><br><span class="line">                   &#125;</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;;</span><br><span class="line"></span><br><span class="line">       <span class="keyword">if</span> (needRunOnSipExecutor) &#123;</span><br><span class="line">           <span class="comment">//ÊîæÂú®ÂíåsipÂàùÂßãÂåñÂêå‰∏Ä‰∏™Á∫øÁ®ã‰∏≠ÊâßË°åÔºåÂê¶ÂàôÂ∞±ÈúÄË¶ÅÂú®ÊâßË°åÁ∫øÁ®ã‰∏≠Ë∞ÉÁî®Endpoint.libRegisterThreadÂéªÊ≥®ÂÜå</span></span><br><span class="line">           getExecutor().execute(runnable);</span><br><span class="line">       &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">           runnable.run();</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure><h3 id="3-3-disconnect-true"><a href="#3-3-disconnect-true" class="headerlink" title="3.3  disconnect(true);"></a>3.3  disconnect(true);</h3><p class="code-caption" data-lang="" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="Code" data-labels_right=":" data-labels_copy=""><span class="code-caption-label"></span><a class="code-caption-copy"></a></p><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> void disconnect(boolean quit) &#123;</span><br><span class="line">        <span class="module-access"><span class="module"><span class="identifier">Log</span>.</span></span>d(THIS_FILE, <span class="string">&quot;True disconnection...&quot;</span>);</span><br><span class="line">        Intent intent = <span class="keyword">new</span> <span class="constructor">Intent(SipManager.ACTION_OUTGOING_UNREGISTER)</span>;</span><br><span class="line">        intent.put<span class="constructor">Extra(SipManager.EXTRA_OUTGOING_ACTIVITY, <span class="params">new</span> ComponentName(<span class="params">this</span>, HomeActivity.<span class="params">class</span>)</span>);</span><br><span class="line">        send<span class="constructor">Broadcast(<span class="params">intent</span>)</span>;</span><br><span class="line">        <span class="keyword">if</span> (quit) &#123;</span><br><span class="line">            <span class="comment">// give time for sip service to destory self and sip stack</span></span><br><span class="line">            <span class="comment">// SystemClock.sleep(2000);</span></span><br><span class="line">            <span class="comment">// finish();</span></span><br><span class="line">            DelayedDismissWaitDialog dialog = <span class="keyword">new</span> <span class="constructor">DelayedDismissWaitDialog(<span class="params">this</span>, 1000)</span>;</span><br><span class="line">            dialog.set<span class="constructor">Message(R.<span class="params">string</span>.<span class="params">alert_message_quiting</span>)</span>;</span><br><span class="line">            dialog.set<span class="constructor">OnDismissListener(<span class="params">new</span> DialogInterface.OnDismissListener()</span> &#123;</span><br><span class="line">                @Override</span><br><span class="line">                public void on<span class="constructor">Dismiss(DialogInterface <span class="params">dialog</span>)</span> &#123;</span><br><span class="line">                    Intent startMain = <span class="keyword">new</span> <span class="constructor">Intent(Intent.ACTION_MAIN)</span>;</span><br><span class="line">                    startMain.add<span class="constructor">Category(Intent.CATEGORY_HOME)</span>;</span><br><span class="line">                    startMain.set<span class="constructor">Flags(Intent.FLAG_ACTIVITY_NEW_TASK)</span>;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        start<span class="constructor">Activity(<span class="params">startMain</span>)</span>;</span><br><span class="line">                    &#125; catch (Exception e) &#123;</span><br><span class="line">                        <span class="module-access"><span class="module"><span class="identifier">Log</span>.</span></span>e(THIS_FILE, <span class="string">&quot;exitApp failed cause&quot;</span>, e);</span><br><span class="line">                    &#125;</span><br><span class="line">                    clear<span class="constructor">AllSherlockFragmentActivities()</span>;</span><br><span class="line"><span class="comment">//                    android.os.Process.killProcess(android.os.Process.myPid());</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">            dialog.show<span class="literal">()</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><h3 id="ÊÄªÁªìÔºöÊ≥®ÈîÄË∑üÈÄÄÂá∫ÁöÑÂå∫Âà´ÊòØ"><a href="#ÊÄªÁªìÔºöÊ≥®ÈîÄË∑üÈÄÄÂá∫ÁöÑÂå∫Âà´ÊòØ" class="headerlink" title="ÊÄªÁªìÔºöÊ≥®ÈîÄË∑üÈÄÄÂá∫ÁöÑÂå∫Âà´ÊòØ"></a>ÊÄªÁªìÔºöÊ≥®ÈîÄË∑üÈÄÄÂá∫ÁöÑÂå∫Âà´ÊòØ</h3><p> ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬†<br>1„ÄÅÈÄÄÂá∫ Âè™ÊòØÊ≥®ÈîÄÂΩìÂâçË¥¶Âè∑ Âπ∂‰∏çÂà†Èô§Ë¥¶Âè∑ÔºåÁºìÂ≠òÁ≠âÊï∞ÊçÆ<br>2„ÄÅÊ≥®ÈîÄ Ê≥®ÈîÄÂΩìÂâçË¥¶Âè∑ Âà†Èô§ÂΩìÂâçË¥¶Âè∑ Ê∏ÖÁ©∫Ë¥¶Âè∑ÔºåË¥¶Âè∑‰ø°ÊÅØÊï∞ÊçÆÂ∫ì Âà†Èô§ÁºìÂ≠òÁ≠âÊï∞ÊçÆ<br>3„ÄÅÊ≥®ÈîÄÂêé‰ºöË∑≥ËΩ¨Âà∞ÁôªÂΩïÁïåÈù¢ ÈÄÄÂá∫Âêé‰ºöÈÄÄÂá∫CUÂà∞ÊâãÊú∫Ê°åÈù¢</p><h2 id="4-ÈÄÄÂà∞ÂêéÂè∞ÂÜçËøõÂÖ•-ËµÑÊ∫êÊú™Ë¢´ÂõûÊî∂Êó∂ÔºåÊú™ËøõË°å‰ªª‰ΩïÊìç‰Ωú"><a href="#4-ÈÄÄÂà∞ÂêéÂè∞ÂÜçËøõÂÖ•-ËµÑÊ∫êÊú™Ë¢´ÂõûÊî∂Êó∂ÔºåÊú™ËøõË°å‰ªª‰ΩïÊìç‰Ωú" class="headerlink" title="4.ÈÄÄÂà∞ÂêéÂè∞ÂÜçËøõÂÖ• ËµÑÊ∫êÊú™Ë¢´ÂõûÊî∂Êó∂ÔºåÊú™ËøõË°å‰ªª‰ΩïÊìç‰Ωú"></a>4.ÈÄÄÂà∞ÂêéÂè∞ÂÜçËøõÂÖ• ËµÑÊ∫êÊú™Ë¢´ÂõûÊî∂Êó∂ÔºåÊú™ËøõË°å‰ªª‰ΩïÊìç‰Ωú</h2><h2 id="5-ÈÄÄÂà∞ÂêéÂè∞ÂÜçËøõÂÖ•-ËµÑÊ∫êË¢´ÂõûÊî∂Êó∂-ÈáçÊñ∞ÁôªÂΩï"><a href="#5-ÈÄÄÂà∞ÂêéÂè∞ÂÜçËøõÂÖ•-ËµÑÊ∫êË¢´ÂõûÊî∂Êó∂-ÈáçÊñ∞ÁôªÂΩï" class="headerlink" title="5.ÈÄÄÂà∞ÂêéÂè∞ÂÜçËøõÂÖ• ËµÑÊ∫êË¢´ÂõûÊî∂Êó∂ ÈáçÊñ∞ÁôªÂΩï"></a>5.ÈÄÄÂà∞ÂêéÂè∞ÂÜçËøõÂÖ• ËµÑÊ∫êË¢´ÂõûÊî∂Êó∂ ÈáçÊñ∞ÁôªÂΩï</h2><p class="code-caption" data-lang="java" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="Code" data-labels_right=":" data-labels_copy=""><span class="code-caption-label"></span><a class="code-caption-copy"></a></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">else</span> <span class="keyword">if</span>(action.equals(ACTION_ACCOUNT_REGIEST))&#123;</span><br><span class="line">            <span class="keyword">if</span> (System.currentTimeMillis() - lastCheckRegisterTime &gt; <span class="number">1000</span> * <span class="number">10</span></span><br><span class="line">                    &amp;&amp; service.isConnectivityValid()) &#123;</span><br><span class="line">                lastCheckRegisterTime = System.currentTimeMillis();</span><br><span class="line">                <span class="type">long</span> <span class="variable">accountId</span> <span class="operator">=</span> SipProfile</span><br><span class="line">                        .getProfileAccountId(context);</span><br><span class="line">                <span class="type">SipProfileState</span> <span class="variable">sipProfile</span> <span class="operator">=</span> SipProfileState.getSipProfileState(context, accountId);</span><br><span class="line">                <span class="type">SipProfile</span> <span class="variable">account</span> <span class="operator">=</span> service.getAccount(accountId);</span><br><span class="line">                <span class="keyword">if</span> (sipProfile != <span class="literal">null</span></span><br><span class="line">                        &amp;&amp; System.currentTimeMillis() - sipProfile.getLast_register_time() &gt; <span class="number">1000</span> * account.reg_timeout) &#123;</span><br><span class="line"></span><br><span class="line">                    service.setAccountRegistration(account, account.active ? <span class="number">1</span> : <span class="number">0</span>, <span class="literal">true</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br></pre></td></tr></table></figure><h2 id="6-ÁΩëÁªúÂàáÊç¢"><a href="#6-ÁΩëÁªúÂàáÊç¢" class="headerlink" title="6.ÁΩëÁªúÂàáÊç¢"></a>6.ÁΩëÁªúÂàáÊç¢</h2><h3 id="6-1-È£ûË°åÊ®°ÂºèÂàáÊç¢Ôºàwifi-4g-ÂàáÊç¢Ôºâ"><a href="#6-1-È£ûË°åÊ®°ÂºèÂàáÊç¢Ôºàwifi-4g-ÂàáÊç¢Ôºâ" class="headerlink" title="6.1 È£ûË°åÊ®°ÂºèÂàáÊç¢Ôºàwifi 4g ÂàáÊç¢Ôºâ"></a>6.1 È£ûË°åÊ®°ÂºèÂàáÊç¢Ôºàwifi 4g ÂàáÊç¢Ôºâ</h3><h4 id="6-1-1-ÁôªÂΩïÁä∂ÊÄÅÊîπÂèò"><a href="#6-1-1-ÁôªÂΩïÁä∂ÊÄÅÊîπÂèò" class="headerlink" title="6.1.1 ÁôªÂΩïÁä∂ÊÄÅÊîπÂèò"></a>6.1.1 ÁôªÂΩïÁä∂ÊÄÅÊîπÂèò</h4><p class="code-caption" data-lang="java" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="Code" data-labels_right=":" data-labels_copy=""><span class="code-caption-label"></span><a class="code-caption-copy"></a></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> (action.equals(SipManager.ACTION_SIP_REGISTRATION_CHANGED)) &#123;</span><br><span class="line">            AccountListUtils.<span class="type">AccountStatusDisplay</span> <span class="variable">accountDisplay</span> <span class="operator">=</span> AccountListUtils.getAccountDisplay(</span><br><span class="line">                    service, SipProfile.DEFAULT_ACCOUNT_ID);</span><br><span class="line"> </span><br><span class="line">            <span class="keyword">if</span> (accountDisplay != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="type">int</span> <span class="variable">statusCode</span> <span class="operator">=</span> accountDisplay.statusCode;</span><br><span class="line">                <span class="keyword">if</span> (statusCode == SipCallSession.StatusCode.OK &amp;&amp; changeAccount) &#123;</span><br><span class="line">                    Log.d(THIS_FILE, <span class="string">&quot;change account and register success&quot;</span>);</span><br><span class="line">                    changeAccount = <span class="literal">false</span>;</span><br><span class="line">                 </span><br><span class="line">                  </span><br><span class="line">                    EduContacts.updateAllRemoteContactsAndGroups(service);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br></pre></td></tr></table></figure><h4 id="6-1-2-ÁΩëÁªúËøûÊé•ÊîπÂèò"><a href="#6-1-2-ÁΩëÁªúËøûÊé•ÊîπÂèò" class="headerlink" title="6.1.2 ÁΩëÁªúËøûÊé•ÊîπÂèò"></a>6.1.2 ÁΩëÁªúËøûÊé•ÊîπÂèò</h4><p class="code-caption" data-lang="java" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="Code" data-labels_right=":" data-labels_copy=""><span class="code-caption-label"></span><a class="code-caption-copy"></a></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">if</span> (action.equals(ConnectivityManager.CONNECTIVITY_ACTION)) &#123;</span><br><span class="line">            <span class="type">ConnectivityManagerWrap</span> <span class="variable">cm</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ConnectivityManagerWrap</span>(context);</span><br><span class="line">            <span class="type">NetworkInfo</span> <span class="variable">activeNetwork</span> <span class="operator">=</span> cm.getActiveNetworkInfo();</span><br><span class="line">            onConnectivityChanged(context,activeNetwork, isSticky);</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure><h4 id="6-1-3-onConnectivityChanged-context-activeNetwork-isSticky"><a href="#6-1-3-onConnectivityChanged-context-activeNetwork-isSticky" class="headerlink" title="6.1.3 onConnectivityChanged(context,activeNetwork, isSticky);"></a>6.1.3 onConnectivityChanged(context,activeNetwork, isSticky);</h4><p class="code-caption" data-lang="java" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="Code" data-labels_right=":" data-labels_copy=""><span class="code-caption-label"></span><a class="code-caption-copy"></a></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Treat the fact that the connectivity has changed</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> info Network info</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@throws</span> SameThreadException</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">onConnectivityChanged</span><span class="params">(Context context,NetworkInfo info, <span class="type">boolean</span> isSticky)</span></span><br><span class="line">           <span class="keyword">throws</span> SameThreadException &#123;</span><br><span class="line">       LogUtils.i(<span class="string">&quot;onConnectivityChanged isSticky=&quot;</span> + isSticky);</span><br><span class="line">       <span class="comment">// We only care about the default network, and getActiveNetworkInfo()</span></span><br><span class="line">       <span class="comment">// is the only way to distinguish them. However, as broadcasts are</span></span><br><span class="line">       <span class="comment">// delivered asynchronously, we might miss DISCONNECTED events from</span></span><br><span class="line">       <span class="comment">// getActiveNetworkInfo(), which is critical to our SIP stack. To</span></span><br><span class="line">       <span class="comment">// solve this, if it is a DISCONNECTED event to our current network,</span></span><br><span class="line">       <span class="comment">// respect it. Otherwise get a new one from getActiveNetworkInfo().</span></span><br><span class="line">       <span class="keyword">if</span> (info == <span class="literal">null</span> || info.isConnected() ||</span><br><span class="line">               !info.getTypeName().equals(mNetworkType)) &#123;</span><br><span class="line">           <span class="type">ConnectivityManagerWrap</span> <span class="variable">cm</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ConnectivityManagerWrap</span>(service);</span><br><span class="line">           info = cm.getActiveNetworkInfo();</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="type">boolean</span> <span class="variable">connected</span> <span class="operator">=</span> (info != <span class="literal">null</span> &amp;&amp; info.isConnected() &amp;&amp; service.isConnectivityValid());</span><br><span class="line">       <span class="type">String</span> <span class="variable">networkType</span> <span class="operator">=</span> connected ? info.getTypeName() : <span class="string">&quot;null&quot;</span>;</span><br><span class="line">       <span class="type">String</span> <span class="variable">currentRoutes</span> <span class="operator">=</span> dumpRoutes(context);</span><br><span class="line">       String oldRoutes;</span><br><span class="line">       <span class="keyword">synchronized</span> (mRoutes) &#123;</span><br><span class="line">           oldRoutes = mRoutes;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="comment">// Ignore the event if the current active network is not changed.</span></span><br><span class="line">       <span class="keyword">if</span> (connected == mConnected &amp;&amp; networkType.equals(mNetworkType)</span><br><span class="line">               &amp;&amp; currentRoutes.equals(oldRoutes)) &#123;</span><br><span class="line">           <span class="keyword">return</span>;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">if</span> (Log.getLogLevel() &gt;= <span class="number">4</span>) &#123;</span><br><span class="line">           <span class="keyword">if</span> (!networkType.equals(mNetworkType)) &#123;</span><br><span class="line">               LogUtils.d(<span class="string">&quot;onConnectivityChanged(): &quot;</span> + mNetworkType +</span><br><span class="line">                       <span class="string">&quot; -&gt; &quot;</span> + networkType);</span><br><span class="line">           &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">               LogUtils.d(<span class="string">&quot;Route changed : &quot;</span> + mRoutes + <span class="string">&quot; -&gt; &quot;</span> + currentRoutes);</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="comment">// Now process the event</span></span><br><span class="line">       <span class="keyword">synchronized</span> (mRoutes) &#123;</span><br><span class="line">           mRoutes = currentRoutes;</span><br><span class="line">       &#125;</span><br><span class="line">       mConnected = connected;</span><br><span class="line">       mNetworkType = networkType;</span><br><span class="line"></span><br><span class="line">       <span class="keyword">if</span> (!isSticky) &#123;</span><br><span class="line">           <span class="keyword">if</span> (connected) &#123;</span><br><span class="line">               LogUtils.i(<span class="string">&quot;We are connected, try to register all accounts&quot;</span>);</span><br><span class="line">               service.addAllAccounts();</span><br><span class="line">               SipReceiver.NetWorkConnected.connected();</span><br><span class="line">               service.restartSipStack();</span><br><span class="line">           &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">               LogUtils.i(<span class="string">&quot;We are not connected, update all accounts status offline&quot;</span>);</span><br><span class="line">               service.getPjSipService().setAccountStatusOffline();</span><br><span class="line"></span><br><span class="line"><span class="comment">//               service.unregisterAllAccounts(false);</span></span><br><span class="line"><span class="comment">//               if (service.stopSipStack()) &#123;</span></span><br><span class="line"><span class="comment">//                   service.stopSelf();</span></span><br><span class="line"><span class="comment">//               &#125;</span></span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure><h4 id="6-1-4-Â¶ÇÊûúÁΩëÁªúËøû‰∏ä-service-restartSipStack"><a href="#6-1-4-Â¶ÇÊûúÁΩëÁªúËøû‰∏ä-service-restartSipStack" class="headerlink" title="6.1.4 Â¶ÇÊûúÁΩëÁªúËøû‰∏ä  service.restartSipStack();"></a>6.1.4 Â¶ÇÊûúÁΩëÁªúËøû‰∏ä  service.restartSipStack();</h4><p class="code-caption" data-lang="java" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="Code" data-labels_right=":" data-labels_copy=""><span class="code-caption-label"></span><a class="code-caption-copy"></a></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//     private KeepAliveTimer kaAlarm;</span></span><br><span class="line">   <span class="comment">// This is always done in SipExecutor thread</span></span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">startSipStack</span><span class="params">()</span> <span class="keyword">throws</span> SameThreadException &#123;</span><br><span class="line">       <span class="comment">// Cache some prefs</span></span><br><span class="line">       supportMultipleCalls = prefsProviderWrapper</span><br><span class="line">               .getPreferenceBooleanValue(SipConfigManager.SUPPORT_MULTIPLE_CALLS);</span><br><span class="line"></span><br><span class="line">       <span class="keyword">if</span> (!isConnectivityValid()) &#123;</span><br><span class="line">           notifyUserOfMessage(R.string.connection_not_valid);</span><br><span class="line">           Log.e(THIS_FILE, <span class="string">&quot;No need to start sip&quot;</span>);</span><br><span class="line">           <span class="keyword">return</span>;</span><br><span class="line">       &#125;</span><br><span class="line">       Log.d(THIS_FILE, <span class="string">&quot;Start was asked and we should actually start now&quot;</span>);</span><br><span class="line">       <span class="keyword">if</span> (pjService == <span class="literal">null</span>) &#123;</span><br><span class="line">           Log.d(THIS_FILE, <span class="string">&quot;Start was asked and pjService in not there&quot;</span>);</span><br><span class="line">           <span class="keyword">if</span> (!loadStack()) &#123;</span><br><span class="line">               Log.e(THIS_FILE, <span class="string">&quot;Unable to load SIP stack !! &quot;</span>);</span><br><span class="line">               <span class="keyword">return</span>;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">       Log.d(THIS_FILE, <span class="string">&quot;Ask pjservice to start itself&quot;</span>);</span><br><span class="line">       LogUtil.log(<span class="string">&quot;ÂêØÂä®pjservice&quot;</span>);</span><br><span class="line">       presenceMgr.startMonitoring(<span class="built_in">this</span>);</span><br><span class="line">       <span class="keyword">if</span> (pjService.sipStart()) &#123;</span><br><span class="line">           <span class="comment">// This should be done after in acquire resource</span></span><br><span class="line">           <span class="comment">// But due to</span></span><br><span class="line">           <span class="comment">// http://code.google.com/p/android/issues/detail?id=21635</span></span><br><span class="line">           <span class="comment">// not a good idea</span></span><br><span class="line">           applyComponentEnablingState(<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">           registerBroadcasts(<span class="built_in">this</span>);</span><br><span class="line">           Log.d(THIS_FILE, <span class="string">&quot;Add all accounts&quot;</span>);</span><br><span class="line">           LogUtil.log(<span class="string">&quot;Ê∑ªÂä†Ë¥¶Âè∑  Ê≥®ÂÜåÂπøÊí≠&quot;</span>, <span class="string">&quot;add all accounts&quot;</span>);</span><br><span class="line">           addAllAccounts();</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure><h4 id="6-1-5-Â¶ÇÊûúÁΩëÁªúÊú™Ëøû‰∏ä-service-getPjSipService-setAccountStatusOffline"><a href="#6-1-5-Â¶ÇÊûúÁΩëÁªúÊú™Ëøû‰∏ä-service-getPjSipService-setAccountStatusOffline" class="headerlink" title="6.1.5 Â¶ÇÊûúÁΩëÁªúÊú™Ëøû‰∏ä service.getPjSipService().setAccountStatusOffline();"></a>6.1.5 Â¶ÇÊûúÁΩëÁªúÊú™Ëøû‰∏ä service.getPjSipService().setAccountStatusOffline();</h4><p class="code-caption" data-lang="java" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="Code" data-labels_right=":" data-labels_copy=""><span class="code-caption-label"></span><a class="code-caption-copy"></a></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Â∞ÜÊâÄÊúâÁöÑË¥¶Âè∑ÁöÑÊï∞ÊçÆÂ∫ìÂ≠òÂÇ®ÁöÑÁä∂ÊÄÅÊ†áËØÜ‰∏∫Á¶ªÁ∫øÔºåÁΩëÁªúÊñ≠ÂºÄÊó∂UIÊçÆÊ≠§ÊòæÁ§∫Áä∂ÊÄÅ</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setAccountStatusOffline</span><span class="params">()</span> &#123;</span><br><span class="line">       <span class="type">ContentValues</span> <span class="variable">cv</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ContentValues</span>();</span><br><span class="line"></span><br><span class="line">       <span class="comment">// Should be fine : status code are coherent with RFC</span></span><br><span class="line">       <span class="comment">// status codes</span></span><br><span class="line">       <span class="comment">//Ê†áËØÜ‰∏∫ÁΩëÁªúÊñ≠ÂºÄ</span></span><br><span class="line">       cv.put(SipProfileState.STATUS_CODE, SipCallSession.StatusCode.PJSIP_SC_BAD_GATEWAY);</span><br><span class="line"></span><br><span class="line">       cv.put(SipProfileState.STATUS_TEXT, <span class="string">&quot;&quot;</span>);</span><br><span class="line">       cv.put(SipProfileState.EXPIRES, <span class="string">&quot;&quot;</span>);</span><br><span class="line"></span><br><span class="line">       <span class="type">Cursor</span> <span class="variable">c</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">       <span class="keyword">try</span> &#123;</span><br><span class="line">           c = service.getContentResolver().query(SipProfile.ACCOUNT_URI,</span><br><span class="line">                   DBProvider.ACCOUNT_FULL_PROJECTION, <span class="literal">null</span>, <span class="literal">null</span>, <span class="literal">null</span>);</span><br><span class="line">           <span class="keyword">if</span> (c != <span class="literal">null</span> &amp;&amp; c.moveToFirst()) &#123;</span><br><span class="line">               <span class="keyword">do</span> &#123;</span><br><span class="line">                   <span class="type">SipProfile</span> <span class="variable">account</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SipProfile</span>(c);</span><br><span class="line">                   service.getContentResolver().update(ContentUris.withAppendedId(SipProfile.ACCOUNT_STATUS_URI,</span><br><span class="line">                           account.id), cv, <span class="literal">null</span>,</span><br><span class="line">                           <span class="literal">null</span>);</span><br><span class="line">               &#125; <span class="keyword">while</span> (c.moveToNext());</span><br><span class="line">           &#125;</span><br><span class="line">       &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">           LogUtils.e(<span class="string">&quot;Error on looping over sip profiles&quot;</span>, e);</span><br><span class="line">       &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">           <span class="keyword">if</span> (c != <span class="literal">null</span>) &#123;</span><br><span class="line">               c.close();</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure><p> ¬† ¬† ¬† </p>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;1-ËæìÂÖ•Áî®Êà∑ÂêçÂØÜÁ†ÅÁôªÂΩï&quot;&gt;&lt;a href=&quot;#1-ËæìÂÖ•Áî®Êà∑ÂêçÂØÜÁ†ÅÁôªÂΩï&quot; class=&quot;headerlink&quot; title=&quot;1.ËæìÂÖ•Áî®Êà∑ÂêçÂØÜÁ†ÅÁôªÂΩï&quot;&gt;&lt;/a&gt;1.ËæìÂÖ•Áî®Êà∑ÂêçÂØÜÁ†ÅÁôªÂΩï&lt;/h2&gt;&lt;p class=&quot;code-caption&quot; data-lang=&quot;ja</summary>
      
    
    
    
    
  </entry>
  
  <entry>
    <title>2.SIPÂèëÈÄÅÊ∂àÊÅØÊµÅÁ®ãÊ¢≥ÁêÜ</title>
    <link href="https://courage-gl.github.io/xiaoalei.github.io/2022/04/02/2-SIP%E5%BF%83%E8%B7%B3%E7%9B%B8%E5%85%B3%E6%95%B4%E7%90%86/"/>
    <id>https://courage-gl.github.io/xiaoalei.github.io/2022/04/02/2-SIP%E5%BF%83%E8%B7%B3%E7%9B%B8%E5%85%B3%E6%95%B4%E7%90%86/</id>
    <published>2022-04-02T09:54:00.000Z</published>
    <updated>2022-04-06T04:18:14.427Z</updated>
    
    <content type="html"><![CDATA[<h1 id="1-snedMsg"><a href="#1-snedMsg" class="headerlink" title="1.snedMsg"></a>1.snedMsg</h1><p class="code-caption" data-lang="java" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="Code" data-labels_right=":" data-labels_copy=""><span class="code-caption-label"></span><a class="code-caption-copy"></a></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@param</span> target      the receiver Êé•Êî∂ËÄÖ</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@param</span> textContent the message content Ê∂àÊÅØÂÜÖÂÆπ</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@param</span> type        the message mimeType &#123;<span class="doctag">@link</span> SipMessage#MESSAGE_TYPE_TEXT&#125; etc Ê∂àÊÅØÁ±ªÂûã</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@param</span> filePath    the path of the file which will be post to the remote  Ê∂àÊÅØË∑ØÂæÑ</span></span><br><span class="line"><span class="comment">  *                    server</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@param</span> data        the associated data to the message,actually only use for type audio,means the Ê∂àÊÅØÂ§ßÂ∞è</span></span><br><span class="line"><span class="comment">  *                    length of the audio</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"> <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">sendMessage</span><span class="params">(String target, String textContent, String type,</span></span><br><span class="line"><span class="params">                         <span class="keyword">final</span> String filePath,</span></span><br><span class="line"><span class="params">                         <span class="keyword">final</span> <span class="type">int</span> data)</span> &#123;</span><br><span class="line">     LogUtil.log(<span class="string">&quot;ÂèëÈÄÅÊñáÂ≠óÊ∂àÊÅØ&quot;</span>, target, textContent, type, filePath, data);</span><br><span class="line">     <span class="keyword">if</span> (checkDebugMode(textContent)) &#123;</span><br><span class="line">         <span class="keyword">return</span>;</span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line">     textContent = TextUtils.isEmpty(textContent) ? <span class="string">&quot;&quot;</span> : textContent;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">     <span class="keyword">final</span> <span class="type">String</span> <span class="variable">msgType</span> <span class="operator">=</span> getMessageType(type);</span><br><span class="line">     <span class="keyword">if</span> (SipMessage.MESSAGE_TYPE_MSG_STATUS.equals(msgType)) &#123;</span><br><span class="line">         <span class="type">Gson</span> <span class="variable">gson</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Gson</span>();</span><br><span class="line">         <span class="type">StatusMsgBean</span> <span class="variable">statusMsgBean</span> <span class="operator">=</span> gson.fromJson(textContent, StatusMsgBean.class);</span><br><span class="line">         <span class="keyword">if</span> (!statusMsgBean.getMsgType().equals(<span class="string">&quot;SMS&quot;</span>)) &#123;</span><br><span class="line">             target = userID;</span><br><span class="line">         &#125;</span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line">     <span class="keyword">if</span> (msgType.equals(SipMessage.MESSAGE_TYPE_MSG_DELETE)) &#123;</span><br><span class="line">         target = userID;</span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line">     mActionBar.setVisibility(View.VISIBLE);</span><br><span class="line">     <span class="keyword">if</span> (mMessageInputFragment != <span class="literal">null</span>) &#123;</span><br><span class="line">         mMessageInputFragment.hideInputView(View.VISIBLE);</span><br><span class="line">     &#125;</span><br><span class="line"><span class="comment">// ÂèãÁõüÁªüËÆ°Ê∂àÊÅØÂèëÈÄÅÁöÑÁ±ªÂûã</span></span><br><span class="line">     umengStatistics(msgType);</span><br><span class="line"><span class="comment">//Ë∞ÉÁî®ÂπøÊí≠Êù•ÂèëÈÄÅÊ∂àÊÅØ</span></span><br><span class="line">     HttpMessageUtils.sendMessageBroadcast(getActivity(), textContent,</span><br><span class="line">             TextUtils.isEmpty(target) ? remoteFullFrom : target, msgType, filePath, data);</span><br><span class="line">     <span class="comment">// Ê∏ÖÊ•öËæìÂÖ•Ê°ÜÁöÑÂÜÖÂÆπ</span></span><br><span class="line">     clearEditText(msgType);</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure><h1 id="2-sendMessageBroadcast"><a href="#2-sendMessageBroadcast" class="headerlink" title="2.sendMessageBroadcast"></a>2.sendMessageBroadcast</h1><p class="code-caption" data-lang="java" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="Code" data-labels_right=":" data-labels_copy=""><span class="code-caption-label"></span><a class="code-caption-copy"></a></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * ÂèëÈÄÅÊ∂àÊÅØ</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> context ‰∏ä‰∏ãÊñáÂØπË±°</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> textContent Ê∂àÊÅØÂÜÖÂÆπ</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> remoteFullFrom Êé•Êî∂ËÄÖ</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> msgType Ê∂àÊÅØÁ±ªÂûã</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> filePath Ê∂àÊÅØË∑ØÂæÑ</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> data Ê∂àÊÅØÂ§ßÂ∞è</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">sendMessageBroadcast</span><span class="params">(Context context, String textContent,</span></span><br><span class="line"><span class="params">                                           String remoteFullFrom,</span></span><br><span class="line"><span class="params">                                           String msgType, String filePath, <span class="type">int</span> data)</span> &#123;</span><br><span class="line"></span><br><span class="line">       <span class="type">Intent</span> <span class="variable">intent</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Intent</span>(SipManager.ACTION_SEND_MESSAGE);</span><br><span class="line">       intent.putExtra(MessageFragment.BroadcastBundleKeys.SEND_MSG_TXT_CONTENT, textContent);</span><br><span class="line">       intent.putExtra(MessageFragment.BroadcastBundleKeys.SEND_MSG_REMOTE_FULL_FROM,</span><br><span class="line">               remoteFullFrom);</span><br><span class="line">       intent.putExtra(MessageFragment.BroadcastBundleKeys.SEND_MSG_TYPE, msgType);</span><br><span class="line">       intent.putExtra(MessageFragment.BroadcastBundleKeys.SEND_MSG_FILE_PATH, filePath);</span><br><span class="line">       intent.putExtra(MessageFragment.BroadcastBundleKeys.SEND_MSG_DATA, data);</span><br><span class="line"></span><br><span class="line">       intent.putExtra(MessageFragment.BroadcastBundleKeys.SEND_MSG_TIMESTAMP,</span><br><span class="line">               System.currentTimeMillis());</span><br><span class="line"><span class="comment">//      Ë∑≥ËΩ¨Âà∞SipServer</span></span><br><span class="line">       context.sendBroadcast(intent);</span><br><span class="line"><span class="comment">//       ÈùôÊÄÅdumpstack()ÊñπÊ≥ïÊèê‰æõ‰∏Ä‰∏™new exception (&quot;stack trace&quot;).printstacktrace ()ÁöÑÂ∞ÅË£ÖÔºåÊâìÂç∞‰∏Ä‰∏™ËøΩË∏™ÂΩìÂâçÁ∫øÁ®ãÁöÑÂ†ÜÊ†à</span></span><br><span class="line"><span class="comment">//       Thread.dumpStack();</span></span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure><h1 id="3-SipManager-ACTION-SEND-MESSAGEÂπøÊí≠ÁõëÂê¨"><a href="#3-SipManager-ACTION-SEND-MESSAGEÂπøÊí≠ÁõëÂê¨" class="headerlink" title="3.SipManager.ACTION_SEND_MESSAGEÂπøÊí≠ÁõëÂê¨"></a>3.SipManager.ACTION_SEND_MESSAGEÂπøÊí≠ÁõëÂê¨</h1><p class="code-caption" data-lang="java" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="Code" data-labels_right=":" data-labels_copy=""><span class="code-caption-label"></span><a class="code-caption-copy"></a></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Ê≥®ÂÜåÂπøÊí≠ÁõëÂê¨</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">registerServiceBroadcasts</span><span class="params">()</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (serviceReceiver == <span class="literal">null</span>) &#123;</span><br><span class="line">          <span class="type">IntentFilter</span> <span class="variable">intentfilter</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">IntentFilter</span>();</span><br><span class="line">          intentfilter.addAction(SipManager.ACTION_DEFER_OUTGOING_UNREGISTER);</span><br><span class="line">          intentfilter.addAction(SipManager.ACTION_OUTGOING_UNREGISTER);</span><br><span class="line">          <span class="comment">// added by txp,2013-9-10 register broadcast for unregister all</span></span><br><span class="line">          <span class="comment">// accounts</span></span><br><span class="line">          intentfilter.addAction(SipManager.ACTION_SIP_ACCOUNTS_UNREGISTER);</span><br><span class="line">          <span class="comment">// added by txp,2013-10-16 register broadcast for cancel message</span></span><br><span class="line">          <span class="comment">// notification</span></span><br><span class="line">          intentfilter.addAction(SipManager.ACTION_CANCEL_MESSAGE_NOTIFICATION);</span><br><span class="line">          <span class="comment">// added by zjf 2014-08-19</span></span><br><span class="line">          intentfilter.addAction(SipManager.ACTION_SET_VIEWING_MESSAGE);</span><br><span class="line">          intentfilter.addAction(SipManager.ACTION_SEND_MESSAGE);</span><br><span class="line">          intentfilter.addAction(SipManager.ACTION_FORWARD_MESSAGE);</span><br><span class="line">          intentfilter.addAction(SipManager.ACTION_MAKE_CALL_WITH_OPTIONS);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">          intentfilter.addAction(SipManager.ACTION_SIP_MESSAGE_CONVERSATION_DELETED);</span><br><span class="line">          intentfilter.addAction(SipManager.ACTION_SIP_MESSAGE_READ_STATUS_CHANGED);</span><br><span class="line">          intentfilter.addAction(SipManager.ACTION_SIP_ACCOUNT_OFF_LINE);</span><br><span class="line">          intentfilter.addAction(SipManager.ACTION_SIP_CANCEL_ALL_NOTIFICATIONS);</span><br><span class="line"></span><br><span class="line">          serviceReceiver = <span class="keyword">new</span> <span class="title class_">BroadcastReceiver</span>() &#123;</span><br><span class="line">              <span class="meta">@Override</span></span><br><span class="line">              <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onReceive</span><span class="params">(Context context, Intent intent)</span> &#123;</span><br><span class="line">                  LogUtils.d(<span class="string">&quot;sip service Êî∂Âà∞ÁöÑaction: %s&quot;</span>, intent.getAction());</span><br><span class="line">                  LogUtils.v(intent.getExtras());</span><br><span class="line">                  <span class="type">String</span> <span class="variable">action</span> <span class="operator">=</span> intent.getAction();</span><br><span class="line">                  <span class="keyword">if</span> (action.equals(SipManager.ACTION_OUTGOING_UNREGISTER)) &#123;</span><br><span class="line">                      unregisterForOutgoing((ComponentName) intent</span><br><span class="line">                              .getParcelableExtra(SipManager.EXTRA_OUTGOING_ACTIVITY));</span><br><span class="line">                  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (action.equals(SipManager.ACTION_DEFER_OUTGOING_UNREGISTER)) &#123;</span><br><span class="line">                      deferUnregisterForOutgoing((ComponentName) intent</span><br><span class="line">                              .getParcelableExtra(SipManager.EXTRA_OUTGOING_ACTIVITY));</span><br><span class="line">                  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (action.equals(SipManager.ACTION_SIP_ACCOUNTS_UNREGISTER)) &#123;</span><br><span class="line">                      <span class="keyword">try</span> &#123;</span><br><span class="line">                          unregisterAllAccounts(<span class="literal">true</span>);</span><br><span class="line">                      &#125; <span class="keyword">catch</span> (SameThreadException e) &#123;</span><br><span class="line">                          Log.e(THIS_FILE, <span class="string">&quot;unregister accounts failed&quot;</span>);</span><br><span class="line">                      &#125;</span><br><span class="line">                  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (action.equals(SipManager.ACTION_CANCEL_MESSAGE_NOTIFICATION)) &#123;</span><br><span class="line">                      notificationManager.cancelMessages();</span><br><span class="line">                  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (action.equals(SipManager.ACTION_SIP_MESSAGE_CONVERSATION_DELETED)</span><br><span class="line">                          || action.equals(SipManager.ACTION_SIP_MESSAGE_READ_STATUS_CHANGED)) &#123;</span><br><span class="line">                      notificationManager.buildUnreadMessagesList();</span><br><span class="line"><span class="comment">//                      notificationManager.cancelMessages();</span></span><br><span class="line">                  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (SipManager.ACTION_SET_VIEWING_MESSAGE.equals(action)) &#123;</span><br><span class="line">                      <span class="keyword">if</span> (intent != <span class="literal">null</span>) &#123;</span><br><span class="line">                          <span class="keyword">final</span> <span class="type">String</span> <span class="variable">from</span> <span class="operator">=</span> intent</span><br><span class="line">                                  .getStringExtra(</span><br><span class="line">                                          MessageFragment.BroadcastBundleKeys.SET_VIEWING_MSG_REMOTE_FROM);</span><br><span class="line">                          notificationManager.setViewingMessageFrom(from);</span><br><span class="line">                      &#125;</span><br><span class="line">                  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (SipManager.ACTION_SEND_MESSAGE.equals(action)) &#123;</span><br><span class="line">                      <span class="comment">//ÂèëÈÄÅËÅäÂ§©</span></span><br><span class="line">                      LogUtil.printIntent(intent);</span><br><span class="line">                      <span class="keyword">if</span> (intent != <span class="literal">null</span>) &#123;</span><br><span class="line">                          <span class="keyword">final</span> <span class="type">String</span> <span class="variable">content</span> <span class="operator">=</span> intent.getStringExtra(</span><br><span class="line">                                  MessageFragment.BroadcastBundleKeys.SEND_MSG_TXT_CONTENT);</span><br><span class="line">                          <span class="keyword">final</span> <span class="type">String</span> <span class="variable">to</span> <span class="operator">=</span> intent.getStringExtra(</span><br><span class="line">                                  MessageFragment.BroadcastBundleKeys.SEND_MSG_REMOTE_FULL_FROM);</span><br><span class="line"></span><br><span class="line">                          <span class="type">long</span> <span class="variable">accountId</span> <span class="operator">=</span> SipProfile.INVALID_ID;</span><br><span class="line">                          <span class="type">SipProfile</span> <span class="variable">sipProfile</span> <span class="operator">=</span> SipProfile.getAccountFromCurrentAppContext(SipService.<span class="built_in">this</span>);</span><br><span class="line">                          <span class="keyword">if</span> (sipProfile != <span class="literal">null</span>) &#123;</span><br><span class="line">                              accountId = sipProfile.id;</span><br><span class="line">                          &#125;</span><br><span class="line"></span><br><span class="line">                          <span class="keyword">final</span> <span class="type">String</span> <span class="variable">msgType</span> <span class="operator">=</span> intent.getStringExtra(</span><br><span class="line">                                  MessageFragment.BroadcastBundleKeys.SEND_MSG_TYPE);</span><br><span class="line">                          <span class="keyword">final</span> <span class="type">String</span> <span class="variable">filePath</span> <span class="operator">=</span> intent.getStringExtra(</span><br><span class="line">                                  MessageFragment.BroadcastBundleKeys.SEND_MSG_FILE_PATH);</span><br><span class="line">                          <span class="keyword">final</span> <span class="type">int</span> <span class="variable">data</span> <span class="operator">=</span> intent.getIntExtra(</span><br><span class="line">                                  MessageFragment.BroadcastBundleKeys.SEND_MSG_DATA, <span class="number">0</span>);</span><br><span class="line">                          <span class="keyword">final</span> <span class="type">long</span> <span class="variable">timestamp</span> <span class="operator">=</span> intent.getLongExtra(</span><br><span class="line">                                  MessageFragment.BroadcastBundleKeys.SEND_MSG_TIMESTAMP, -<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">                          <span class="keyword">try</span> &#123;</span><br><span class="line">                              <span class="keyword">if</span> (timestamp != lastMsgSendingTimestamp) &#123;</span><br><span class="line">                                  lastMsgSendingTimestamp = timestamp;</span><br><span class="line">                                  binder.sendMessage(content, to, accountId, msgType, filePath,</span><br><span class="line">                                          data);</span><br><span class="line">                                  LogUtils.d(<span class="string">&quot;binder.sendMessage(....)&quot;</span>);</span><br><span class="line">                              &#125;</span><br><span class="line">                          &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">                              e.printStackTrace();</span><br><span class="line">                          &#125;</span><br><span class="line">                      &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                          Toast.makeText(context, <span class="string">&quot;ÁΩëÁªú‰∏çÂèØÁî®&quot;</span>, Toast.LENGTH_SHORT).show();</span><br><span class="line">                      &#125;</span><br><span class="line">                  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (SipManager.ACTION_FORWARD_MESSAGE.equals(action)) &#123;</span><br><span class="line">                      <span class="keyword">if</span> (intent != <span class="literal">null</span>) &#123;</span><br><span class="line">                          <span class="keyword">final</span> <span class="type">String</span> <span class="variable">content</span> <span class="operator">=</span> intent.getStringExtra(</span><br><span class="line">                                  MessageFragment.BroadcastBundleKeys.SEND_MSG_TXT_CONTENT);</span><br><span class="line">                          <span class="keyword">final</span> <span class="type">String</span> <span class="variable">to</span> <span class="operator">=</span> intent.getStringExtra(</span><br><span class="line">                                  MessageFragment.BroadcastBundleKeys.SEND_MSG_REMOTE_FULL_FROM);</span><br><span class="line"></span><br><span class="line">                          <span class="type">long</span> <span class="variable">accountId</span> <span class="operator">=</span> SipProfile.INVALID_ID;</span><br><span class="line">                          <span class="type">SipProfile</span> <span class="variable">sipProfile</span> <span class="operator">=</span> SipProfile.getAccountFromCurrentAppContext(SipService.<span class="built_in">this</span>);</span><br><span class="line">                          <span class="keyword">if</span> (sipProfile != <span class="literal">null</span>) &#123;</span><br><span class="line">                              accountId = sipProfile.id;</span><br><span class="line">                          &#125;</span><br><span class="line"></span><br><span class="line">                          <span class="keyword">final</span> <span class="type">String</span> <span class="variable">msgType</span> <span class="operator">=</span> intent.getStringExtra(</span><br><span class="line">                                  MessageFragment.BroadcastBundleKeys.SEND_MSG_TYPE);</span><br><span class="line">                          <span class="keyword">final</span> <span class="type">String</span> <span class="variable">filePath</span> <span class="operator">=</span> intent.getStringExtra(</span><br><span class="line">                                  MessageFragment.BroadcastBundleKeys.SEND_MSG_FILE_PATH);</span><br><span class="line">                          <span class="keyword">final</span> <span class="type">int</span> <span class="variable">data</span> <span class="operator">=</span> intent.getIntExtra(</span><br><span class="line">                                  MessageFragment.BroadcastBundleKeys.SEND_MSG_DATA, <span class="number">0</span>);</span><br><span class="line">                          <span class="keyword">final</span> <span class="type">long</span> <span class="variable">timestamp</span> <span class="operator">=</span> intent.getLongExtra(</span><br><span class="line">                                  MessageFragment.BroadcastBundleKeys.SEND_MSG_TIMESTAMP, -<span class="number">1</span>);</span><br><span class="line"><span class="comment">//                        Â§ö‰ΩôÁöÑÈÄªËæë Âà†Èô§Êéâ Ëß£ÂÜ≥ËΩ¨Âèë‰∏¢Ê∂àÊÅØÁöÑÈóÆÈ¢ò</span></span><br><span class="line"><span class="comment">//                          if (timestamp != lastMsgSendingTimestamp) &#123;</span></span><br><span class="line"><span class="comment">//                              lastMsgSendingTimestamp = timestamp;</span></span><br><span class="line">                          <span class="keyword">try</span> &#123;</span><br><span class="line">                              binder.forwardMessage(content, to, accountId, msgType, filePath,</span><br><span class="line">                                      data);</span><br><span class="line">                          &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">                              e.printStackTrace();</span><br><span class="line">                          &#125;</span><br><span class="line"><span class="comment">//                          &#125;</span></span><br><span class="line">                      &#125;</span><br><span class="line">                  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (SipManager.ACTION_MAKE_CALL_WITH_OPTIONS.equals(action)) &#123;</span><br><span class="line">                      <span class="keyword">if</span> (intent != <span class="literal">null</span>) &#123;</span><br><span class="line">                          <span class="keyword">final</span> <span class="type">String</span> <span class="variable">callee</span> <span class="operator">=</span> intent.getStringExtra(</span><br><span class="line">                                  MessageFragment.BroadcastBundleKeys.MAKE_CALL_WITH_OPTS_CALLEE);</span><br><span class="line">                          <span class="keyword">final</span> <span class="type">long</span> <span class="variable">accountId</span> <span class="operator">=</span> intent</span><br><span class="line">                                  .getLongExtra(</span><br><span class="line">                                          MessageFragment.BroadcastBundleKeys.MAKE_CALL_WITH_OPTS_ACCOUNT_ID,</span><br><span class="line">                                          -<span class="number">1</span>);</span><br><span class="line">                          <span class="keyword">final</span> <span class="type">Bundle</span> <span class="variable">options</span> <span class="operator">=</span> intent</span><br><span class="line">                                  .getBundleExtra(</span><br><span class="line">                                          MessageFragment.BroadcastBundleKeys.MAKE_CALL_WITH_OPTS_OPTIONS);</span><br><span class="line">                          <span class="keyword">try</span> &#123;</span><br><span class="line">                              binder.makeCallWithOptions(callee, (<span class="type">int</span>) accountId, options);</span><br><span class="line">                          &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">                              e.printStackTrace();</span><br><span class="line">                          &#125;</span><br><span class="line">                      &#125;</span><br><span class="line">                  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (SipManager.ACTION_SIP_ACCOUNT_OFF_LINE.equals(action)) &#123;</span><br><span class="line">                      LogUtil.log(<span class="string">&quot;sipÊúçÂä°Êî∂Âà∞Á¶ªÁ∫øÁöÑÂπøÊí≠&quot;</span>);</span><br><span class="line">                      LogUtil.printIntent(intent);</span><br><span class="line">                      <span class="keyword">try</span> &#123;</span><br><span class="line">                          deleteAllAccountsNotUnRegister();</span><br><span class="line">                      &#125; <span class="keyword">catch</span> (SameThreadException e) &#123;</span><br><span class="line">                          Log.e(THIS_FILE, <span class="string">&quot;delete accounts failed&quot;</span>);</span><br><span class="line">                          LogUtil.log(e);</span><br><span class="line">                      &#125;</span><br><span class="line">                  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (SipManager.ACTION_SIP_CANCEL_ALL_NOTIFICATIONS.equals(action)) &#123;</span><br><span class="line">                      notificationManager.cancelAll();</span><br><span class="line">                  &#125;</span><br><span class="line">              &#125;</span><br><span class="line"></span><br><span class="line">          &#125;;</span><br><span class="line">          registerReceiver(serviceReceiver, intentfilter);</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><h1 id="4-binder-sendMessage-content-to-accountId-msgType-filePath"><a href="#4-binder-sendMessage-content-to-accountId-msgType-filePath" class="headerlink" title="4.binder.sendMessage(content, to, accountId, msgType, filePath,"></a>4.binder.sendMessage(content, to, accountId, msgType, filePath,</h1><pre><code>                                        data);</code></pre><p class="code-caption" data-lang="java" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="Code" data-labels_right=":" data-labels_copy=""><span class="code-caption-label"></span><a class="code-caption-copy"></a></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/***</span></span><br><span class="line"><span class="comment">        * SipServer ÂèëÈÄÅÊ∂àÊÅØ</span></span><br><span class="line"><span class="comment">        * <span class="doctag">@param</span> message ÂÜÖÂÆπ</span></span><br><span class="line"><span class="comment">        * <span class="doctag">@param</span> callee Êé•Êî∂ËÄÖ</span></span><br><span class="line"><span class="comment">        * <span class="doctag">@param</span> accountId ÂΩìÂâçÁî®Êà∑Id</span></span><br><span class="line"><span class="comment">        * <span class="doctag">@param</span> mimeType Ê∂àÊÅØÁ±ªÂûã</span></span><br><span class="line"><span class="comment">        * <span class="doctag">@param</span> filePath Ê∂àÊÅØË∑ØÂæÑ</span></span><br><span class="line"><span class="comment">        * <span class="doctag">@param</span> data Ê∂àÊÅØÂ§ßÂ∞è</span></span><br><span class="line"><span class="comment">        * <span class="doctag">@throws</span> RemoteException ÂèØËÉΩ‰ºöÊä•ÁöÑÂºÇÂ∏∏</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">       <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">sendMessage</span><span class="params">(<span class="keyword">final</span> String message, <span class="keyword">final</span> String callee, <span class="keyword">final</span> <span class="type">long</span> accountId,</span></span><br><span class="line"><span class="params">                               <span class="keyword">final</span> String mimeType,</span></span><br><span class="line"><span class="params">                               <span class="keyword">final</span> String filePath, <span class="keyword">final</span> <span class="type">int</span> data)</span> <span class="keyword">throws</span> RemoteException &#123;</span><br><span class="line">           LogUtils.i(<span class="string">&quot;%s, %s, %s, %s, %s, %s&quot;</span>, message, callee, accountId, mimeType, filePath, data);</span><br><span class="line">           SipService.<span class="built_in">this</span>.enforceCallingOrSelfPermission(SipManager.PERMISSION_USE_SIP, <span class="literal">null</span>);</span><br><span class="line">           <span class="comment">// We have to ensure service is properly started and not just binded</span></span><br><span class="line">           <span class="keyword">if</span> (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.O) &#123;</span><br><span class="line">               <span class="comment">//android8.0‰ª•‰∏äÈÄöËøástartForegroundServiceÂêØÂä®service</span></span><br><span class="line">               SipService.<span class="built_in">this</span>.startForegroundService(<span class="keyword">new</span> <span class="title class_">Intent</span>(SipService.<span class="built_in">this</span>, SipService.class));</span><br><span class="line">           &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">               SipService.<span class="built_in">this</span>.startService(<span class="keyword">new</span> <span class="title class_">Intent</span>(SipService.<span class="built_in">this</span>, SipService.class));</span><br><span class="line">           &#125;</span><br><span class="line">           Log.i(THIS_FILE, <span class="string">&quot;try to sms &quot;</span> + callee + <span class="string">&quot; mimeType=&quot;</span> + mimeType);</span><br><span class="line">           <span class="type">int</span> <span class="variable">textSize</span> <span class="operator">=</span> message != <span class="literal">null</span> ? message.getBytes().length : <span class="number">0</span>;</span><br><span class="line">           <span class="keyword">if</span> (SipMessage.MESSAGE_TYPE_TEXT.equals(mimeType)</span><br><span class="line">                   || (mimeType.equals(SipMessage.MESSAGE_TYPE_RECEIPT) &amp;&amp; textSize &gt;= SipMessage.LONG_TEXT_MIN_BYTES)) &#123;</span><br><span class="line">               getExecutor().execute(<span class="keyword">new</span> <span class="title class_">SipRunnable</span>() &#123;</span><br><span class="line">                   <span class="meta">@Override</span></span><br><span class="line">                   <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">doRun</span><span class="params">()</span> <span class="keyword">throws</span> SameThreadException &#123;</span><br><span class="line">                       <span class="type">MessageBean</span> <span class="variable">textMessageBean</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TextMessageBean</span>(message, accountId, pjService, callee, SipService.<span class="built_in">this</span>, mimeType);</span><br><span class="line">                       textMessageBean.sendMessage();</span><br><span class="line">                   &#125;</span><br><span class="line">               &#125;);</span><br><span class="line">           &#125; <span class="keyword">else</span> <span class="keyword">if</span> (SipMessage.MESSAGE_TYPE_CANCEL.equals(mimeType)) &#123;</span><br><span class="line">               getExecutor().execute(<span class="keyword">new</span> <span class="title class_">SipRunnable</span>() &#123;</span><br><span class="line">                   <span class="meta">@Override</span></span><br><span class="line">                   <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">doRun</span><span class="params">()</span> <span class="keyword">throws</span> SameThreadException &#123;</span><br><span class="line">                       <span class="type">MessageBean</span> <span class="variable">customMessageBean</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TextCancelMessageBean</span>(message, accountId, pjService, callee, SipService.<span class="built_in">this</span>);</span><br><span class="line">                       customMessageBean.sendMessage();</span><br><span class="line">                   &#125;</span><br><span class="line">               &#125;);</span><br><span class="line">           &#125; <span class="keyword">else</span> <span class="keyword">if</span> (SipMessage.MESSAGE_TYPE_API.equals(mimeType)) &#123;</span><br><span class="line">               <span class="comment">// it is a handler thread</span></span><br><span class="line">               getExecutor().execute(<span class="keyword">new</span> <span class="title class_">SipRunnable</span>() &#123;</span><br><span class="line">                   <span class="meta">@Override</span></span><br><span class="line">                   <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">doRun</span><span class="params">()</span> <span class="keyword">throws</span> SameThreadException &#123;</span><br><span class="line">                       <span class="type">MessageBean</span> <span class="variable">apiMessageBean</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ApiMessageBean</span>(message, accountId, pjService, callee, SipService.<span class="built_in">this</span>);</span><br><span class="line">                       apiMessageBean.sendMessage();</span><br><span class="line">                   &#125;</span><br><span class="line">               &#125;);</span><br><span class="line">           &#125; <span class="keyword">else</span> <span class="keyword">if</span> (SipMessage.MESSAGE_TYPE_APPROVE.equals(mimeType)) &#123;</span><br><span class="line">               <span class="comment">// it is a handler thread</span></span><br><span class="line">               getExecutor().execute(<span class="keyword">new</span> <span class="title class_">SipRunnable</span>() &#123;</span><br><span class="line">                   <span class="meta">@Override</span></span><br><span class="line">                   <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">doRun</span><span class="params">()</span> <span class="keyword">throws</span> SameThreadException &#123;</span><br><span class="line">                       Log.i(THIS_FILE, <span class="string">&quot;approve sms &quot;</span> + callee + <span class="string">&quot; mimeType=&quot;</span> + mimeType);</span><br><span class="line">                       <span class="type">MessageBean</span> <span class="variable">approveMessageBean</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ApproveMessageBean</span>(message, accountId, pjService, callee, SipService.<span class="built_in">this</span>);</span><br><span class="line">                       approveMessageBean.sendMessage();</span><br><span class="line">                   &#125;</span><br><span class="line">               &#125;);</span><br><span class="line">           &#125; <span class="keyword">else</span> <span class="keyword">if</span> (SipMessage.MESSAGE_TYPE_CIRCLE.equals(mimeType)) &#123;</span><br><span class="line">               <span class="comment">// it is a handler thread</span></span><br><span class="line">               getExecutor().execute(<span class="keyword">new</span> <span class="title class_">SipRunnable</span>() &#123;</span><br><span class="line">                   <span class="meta">@Override</span></span><br><span class="line">                   <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">doRun</span><span class="params">()</span> <span class="keyword">throws</span> SameThreadException &#123;</span><br><span class="line">                       <span class="type">MessageBean</span> <span class="variable">circleMessageBean</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CircleMessageBean</span>(message, accountId, pjService, callee, SipService.<span class="built_in">this</span>);</span><br><span class="line">                       circleMessageBean.sendMessage();</span><br><span class="line">                   &#125;</span><br><span class="line">               &#125;);</span><br><span class="line">           &#125; <span class="keyword">else</span> <span class="keyword">if</span> (SipMessage.MESSAGE_TYPE_LOC.equals(mimeType)) &#123;</span><br><span class="line">               <span class="comment">// it is a handler thread</span></span><br><span class="line">               getExecutor().execute(<span class="keyword">new</span> <span class="title class_">SipRunnable</span>() &#123;</span><br><span class="line">                   <span class="meta">@Override</span></span><br><span class="line">                   <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">doRun</span><span class="params">()</span> <span class="keyword">throws</span> SameThreadException &#123;</span><br><span class="line">                       <span class="type">MessageBean</span> <span class="variable">locMessageBean</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">LocMessageBean</span>(message, accountId, pjService, callee, SipService.<span class="built_in">this</span>);</span><br><span class="line">                       locMessageBean.sendMessage();</span><br><span class="line">                   &#125;</span><br><span class="line">               &#125;);</span><br><span class="line">           &#125; <span class="keyword">else</span> <span class="keyword">if</span> (SipMessage.MESSAGE_TYPE_JOIN_CLASS.equals(mimeType)) &#123;</span><br><span class="line"></span><br><span class="line">               getExecutor().execute(<span class="keyword">new</span> <span class="title class_">SipRunnable</span>() &#123;</span><br><span class="line">                   <span class="meta">@Override</span></span><br><span class="line">                   <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">doRun</span><span class="params">()</span> <span class="keyword">throws</span> SameThreadException &#123;</span><br><span class="line">                       <span class="keyword">new</span> <span class="title class_">CommonMessageBean</span>.Builder(pjService, callee, accountId, SipService.<span class="built_in">this</span>).setMimeType(mimeType)</span><br><span class="line">                               .setDbMessageBody(message)</span><br><span class="line">                               .setSendMessageBody(message)</span><br><span class="line">                               .setNeedInsertToDb(<span class="literal">false</span>).create().sendMessage();</span><br><span class="line">                   &#125;</span><br><span class="line">               &#125;);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">           &#125; <span class="keyword">else</span> <span class="keyword">if</span> (SipMessage.MESSAGE_TYPE_SHARE.equals(mimeType)</span><br><span class="line">                   || SipMessage.MESSAGE_TYPE_NET_DISK.equals(mimeType)</span><br><span class="line">                   || SipMessage.MESSAGE_TYPE_TRAFFIC.equals(mimeType)</span><br><span class="line">                   || SipMessage.MESSAGE_TYPE_EXPRESSION.equals(mimeType)</span><br><span class="line">                   || SipMessage.MESSAGE_TYPE_NAME_CARD.equals(mimeType)</span><br><span class="line">                   || SipMessage.MESSAGE_TYPE_MSG_STATUS.equals(mimeType)</span><br><span class="line">                   || SipMessage.MESSAGE_TYPE_MSG_DELETE.equals(mimeType)</span><br><span class="line">                   || SipMessage.MESSAGE_TYPE_METTING.equals(mimeType)</span><br><span class="line">                   || SipMessage.MESSAGE_TYPE_TRANSFER.equals(mimeType)</span><br><span class="line">                   || mimeType.equals(SipMessage.MESSAGE_TYPE_RECEIPT)) &#123;</span><br><span class="line">               <span class="comment">// it is a handler thread</span></span><br><span class="line">               getExecutor().execute(<span class="keyword">new</span> <span class="title class_">SipRunnable</span>() &#123;</span><br><span class="line">                   <span class="meta">@Override</span></span><br><span class="line">                   <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">doRun</span><span class="params">()</span> <span class="keyword">throws</span> SameThreadException &#123;</span><br><span class="line">                       <span class="keyword">new</span> <span class="title class_">CommonMessageBean</span>.Builder(pjService, callee, accountId, SipService.<span class="built_in">this</span>).setMimeType(mimeType)</span><br><span class="line">                               .setDbMessageBody(message)</span><br><span class="line">                               .setSendMessageBody(message)</span><br><span class="line">                               .setNeedInsertToDb(<span class="literal">true</span>).create().sendMessage();</span><br><span class="line">                   &#125;</span><br><span class="line">               &#125;);</span><br><span class="line"></span><br><span class="line">           &#125; <span class="keyword">else</span> <span class="keyword">if</span> (SipMessage.MESSAGE_TYPE_RECORD.equals(mimeType)) &#123;</span><br><span class="line">               getExecutor().execute(<span class="keyword">new</span> <span class="title class_">SipRunnable</span>() &#123;</span><br><span class="line">                   <span class="meta">@Override</span></span><br><span class="line">                   <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">doRun</span><span class="params">()</span> <span class="keyword">throws</span> SameThreadException &#123;</span><br><span class="line">                       <span class="type">MessageBean</span> <span class="variable">textMessageBean</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MergeForwardBean</span>(message, accountId, pjService, callee, SipService.<span class="built_in">this</span>, mimeType);</span><br><span class="line">                       textMessageBean.sendMessage();</span><br><span class="line">                   &#125;</span><br><span class="line">               &#125;);</span><br><span class="line">           &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">               <span class="comment">// every time create a new thread</span></span><br><span class="line">               getExecutor().execute(<span class="keyword">new</span> <span class="title class_">Thread</span>() &#123;</span><br><span class="line">                   <span class="meta">@Override</span></span><br><span class="line">                   <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">                       sipWakeLock.acquire(<span class="built_in">this</span>);</span><br><span class="line">                       <span class="keyword">if</span> (SipMessage.MESSAGE_TYPE_IMAGE.equals(mimeType)) &#123;</span><br><span class="line">                           <span class="type">MessageBean</span> <span class="variable">imageMessageBean</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ImageMessageBean</span>(message, filePath, data, accountId, pjService, callee, SipService.<span class="built_in">this</span>);</span><br><span class="line">                           imageMessageBean.sendMessage();</span><br><span class="line">                       &#125; <span class="keyword">else</span> <span class="keyword">if</span> (SipMessage.MESSAGE_TYPE_AUDIO.equals(mimeType)) &#123;</span><br><span class="line">                           <span class="type">MessageBean</span> <span class="variable">audioMessageBean</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AudioMessageBean</span>(message, filePath, data, accountId, pjService, callee, SipService.<span class="built_in">this</span>);</span><br><span class="line">                           audioMessageBean.sendMessage();</span><br><span class="line">                       &#125; <span class="keyword">else</span> <span class="keyword">if</span> (SipMessage.MESSAGE_TYPE_VEDIO.equals(mimeType)) &#123;</span><br><span class="line">                           <span class="type">MessageBean</span> <span class="variable">videoMessage</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">VideoMessageBean</span>(message, filePath, data, accountId, pjService, callee, SipService.<span class="built_in">this</span>);</span><br><span class="line">                           videoMessage.sendMessage();</span><br><span class="line">                       &#125;</span><br><span class="line"></span><br><span class="line">                       sipWakeLock.release(<span class="built_in">this</span>);</span><br><span class="line">                   &#125;</span><br><span class="line">               &#125;);</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">       &#125;</span><br></pre></td></tr></table></figure><h1 id="5-Âà§Êñ≠ÊòØ‰ªÄ‰πàÊ∂àÊÅØÁ±ªÂûã-Â∞ÅË£Ö‰∏çÂêåÁöÑÊ∂àÊÅØÁ±ªÂûãÔºå‰ª•ÂõæÁâáÊ∂àÊÅØ‰∏∫‰æã-MESSAGE-TYPE-IMAGE"><a href="#5-Âà§Êñ≠ÊòØ‰ªÄ‰πàÊ∂àÊÅØÁ±ªÂûã-Â∞ÅË£Ö‰∏çÂêåÁöÑÊ∂àÊÅØÁ±ªÂûãÔºå‰ª•ÂõæÁâáÊ∂àÊÅØ‰∏∫‰æã-MESSAGE-TYPE-IMAGE" class="headerlink" title="5.Âà§Êñ≠ÊòØ‰ªÄ‰πàÊ∂àÊÅØÁ±ªÂûã Â∞ÅË£Ö‰∏çÂêåÁöÑÊ∂àÊÅØÁ±ªÂûãÔºå‰ª•ÂõæÁâáÊ∂àÊÅØ‰∏∫‰æã(MESSAGE_TYPE_IMAGE)"></a>5.Âà§Êñ≠ÊòØ‰ªÄ‰πàÊ∂àÊÅØÁ±ªÂûã Â∞ÅË£Ö‰∏çÂêåÁöÑÊ∂àÊÅØÁ±ªÂûãÔºå‰ª•ÂõæÁâáÊ∂àÊÅØ‰∏∫‰æã(MESSAGE_TYPE_IMAGE)</h1><p class="code-caption" data-lang="java" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="Code" data-labels_right=":" data-labels_copy=""><span class="code-caption-label"></span><a class="code-caption-copy"></a></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (SipMessage.MESSAGE_TYPE_IMAGE.equals(mimeType)) &#123;</span><br><span class="line"> <span class="type">MessageBean</span> <span class="variable">imageMessageBean</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ImageMessageBean</span>(message, filePath, data, accountId, pjService, callee, SipService.<span class="built_in">this</span>);</span><br><span class="line">  imageMessageBean.sendMessage();</span><br><span class="line">                       &#125;</span><br></pre></td></tr></table></figure><h1 id="5-1-ImageMessageBean"><a href="#5-1-ImageMessageBean" class="headerlink" title="5.1 ImageMessageBean"></a>5.1 ImageMessageBean</h1><p class="code-caption" data-lang="java" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="Code" data-labels_right=":" data-labels_copy=""><span class="code-caption-label"></span><a class="code-caption-copy"></a></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * ÂõæÁâáÁ±ªÂûãÊ∂àÊÅØÂ∞ÅË£Ö</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> message</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> filePath</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> data</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> accountId</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> pjSipService</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> callee</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> context</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">ImageMessageBean</span><span class="params">(String message, String filePath, <span class="type">int</span> data, <span class="type">long</span> accountId, PjSipService pjSipService, String callee, Context context)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(message, accountId, pjSipService, callee, context);</span><br><span class="line">        <span class="built_in">this</span>.data = data == -<span class="number">100</span> ? <span class="number">0</span> : data;</span><br><span class="line">        <span class="comment">// normal message,just use the text as content</span></span><br><span class="line">        finalMessageContent = strurl.toString();</span><br><span class="line">        dbMessageBody = finalMessageContent;</span><br><span class="line">        <span class="keyword">if</span> (SipMessage.MESSAGE_TYPE_IMAGE.equals(getMessageMimeType())) &#123;</span><br><span class="line">            <span class="comment">// get the image file path after zooming ÊãøÂà∞ÂõæÁâáÂ§ßÂ∞è</span></span><br><span class="line">            finalFilePath = data == -<span class="number">100</span> ? HttpMessageUtils.copyImage(filePath) : HttpMessageUtils.getScaledImagePath(filePath);</span><br><span class="line">            <span class="comment">// move to folder of callee ÁßªÂä®Âà∞Êé•Êî∂ËÄÖÊâÄÂú®ÁöÑÁõÆÂΩï</span></span><br><span class="line">            FileUtils.<span class="type">FileInfo</span> <span class="variable">fileInfo</span> <span class="operator">=</span> FileUtils.getFileInfo(finalFilePath);</span><br><span class="line">            <span class="keyword">if</span> (fileInfo != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="type">String</span> <span class="variable">finalFolder</span> <span class="operator">=</span> CustomDistribution.getImageFolder()</span><br><span class="line">                        + File.separator + SipUri</span><br><span class="line">                        .getUserName(callee);</span><br><span class="line">                <span class="type">String</span> <span class="variable">finalFileName</span> <span class="operator">=</span> fileInfo.fileName</span><br><span class="line">                        + SipMessage.MESSAGE_IMAGE_SUFFIX;</span><br><span class="line">                <span class="keyword">if</span> (FileUtils.renameFile(finalFilePath, finalFolder,</span><br><span class="line">                        finalFileName)) &#123;</span><br><span class="line">                    finalFilePath = finalFolder + File.separator</span><br><span class="line">                            + finalFileName;</span><br><span class="line">                    uploadFilePath = HttpMessageUtils</span><br><span class="line">                            .generateTmpPath(SipMessage.SAVE_IMAGE_SUFFIX);</span><br><span class="line">                    FileUtils.copyFile(finalFilePath, uploadFilePath);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><h1 id="5-2-imageMessageBean-sendMessage"><a href="#5-2-imageMessageBean-sendMessage" class="headerlink" title="5.2 imageMessageBean.sendMessage();"></a>5.2 imageMessageBean.sendMessage();</h1><p class="code-caption" data-lang="java" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="Code" data-labels_right=":" data-labels_copy=""><span class="code-caption-label"></span><a class="code-caption-copy"></a></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">   * ÂèëÈÄÅÊ∂àÊÅØ</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">sendMessage</span><span class="params">()</span> &#123;</span><br><span class="line">      <span class="comment">// ÁîüÊàêhashCode</span></span><br><span class="line">      hashCode = getHashCode();</span><br><span class="line">      <span class="keyword">if</span> (toCall != <span class="literal">null</span>) &#123;</span><br><span class="line"><span class="comment">//          ÊãøÂà∞Ë¶ÅÂèëÈÄÅÁöÑÊ∂àÊÅØ</span></span><br><span class="line">          <span class="type">SipMessage</span> <span class="variable">sipMessage</span> <span class="operator">=</span> getSipMessage();</span><br><span class="line">          <span class="keyword">if</span> (needInsertToDb &amp;&amp; !TextUtils.isEmpty(getDbMessageBody())) &#123;</span><br><span class="line"><span class="comment">//              ÊèíÂÖ•Âà∞Êï∞ÊçÆÂ∫ì</span></span><br><span class="line">              <span class="type">Uri</span> <span class="variable">uri</span> <span class="operator">=</span> HttpMessageUtils.insertMessage(context, sipMessage, <span class="literal">false</span>);</span><br><span class="line">              prepareForSend(uri);</span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">          <span class="keyword">if</span> (!flag) &#123;</span><br><span class="line">              Log.e(THIS_FILE, <span class="string">&quot;abort to send text message to &quot;</span> + toCall + <span class="string">&quot;as flag == false&quot;</span>);</span><br><span class="line">              <span class="keyword">return</span>;</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">try</span> &#123;</span><br><span class="line">              <span class="keyword">if</span> (toCall.isPjsipAccountValid() &amp;&amp; PreferencesWrapper.getInstance(MyApplication.getApplication())</span><br><span class="line">                      .isValidConnectionForIncoming()) &#123;</span><br><span class="line"><span class="comment">//                  ÂèëÈÄÅÊ∂àÊÅØ</span></span><br><span class="line">                  pjSipService.sendMessage(toCall, getSendMessageBody(), sipMessage.getX_msgid(), getMessageMimeType(), hashCode);</span><br><span class="line">              &#125;</span><br><span class="line">          &#125; <span class="keyword">catch</span> (SipService.SameThreadException e) &#123;</span><br><span class="line">              e.printStackTrace();</span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          Log.e(THIS_FILE, <span class="string">&quot;failed to send text message to &quot;</span> + toCall);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><h1 id="6-‰ΩøÁî®SIPServerÂèëÈÄÅÊ∂àÊÅØ-ÔºàSend-sms-x2F-message-using-SIP-serverÔºâ"><a href="#6-‰ΩøÁî®SIPServerÂèëÈÄÅÊ∂àÊÅØ-ÔºàSend-sms-x2F-message-using-SIP-serverÔºâ" class="headerlink" title="6.‰ΩøÁî®SIPServerÂèëÈÄÅÊ∂àÊÅØ ÔºàSend sms&#x2F;message using SIP serverÔºâ"></a>6.‰ΩøÁî®SIPServerÂèëÈÄÅÊ∂àÊÅØ ÔºàSend sms&#x2F;message using SIP serverÔºâ</h1><p class="code-caption" data-lang="java" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="Code" data-labels_right=":" data-labels_copy=""><span class="code-caption-label"></span><a class="code-caption-copy"></a></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Send sms/message using SIP server</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="comment">// modified by txp,2014-10-28</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">sendMessage</span><span class="params">(ToCall callee, String message, String x_msgid, String mimeType, <span class="type">long</span> currentTimeMillis)</span></span><br><span class="line">            <span class="keyword">throws</span> SameThreadException &#123;</span><br><span class="line">        <span class="keyword">if</span> (!created) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (callee != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> SipMain.sendMessage(callee.getCallee(), x_msgid, mimeType, message, currentTimeMillis);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><h1 id="7-SipMainÂèëÈÄÅÊ∂àÊÅØ"><a href="#7-SipMainÂèëÈÄÅÊ∂àÊÅØ" class="headerlink" title="7.SipMainÂèëÈÄÅÊ∂àÊÅØ"></a>7.SipMainÂèëÈÄÅÊ∂àÊÅØ</h1><p class="code-caption" data-lang="java" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="Code" data-labels_right=":" data-labels_copy=""><span class="code-caption-label"></span><a class="code-caption-copy"></a></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">sendMessage</span><span class="params">(<span class="keyword">final</span> String uri, String x_msgid, <span class="keyword">final</span> String mimeType, <span class="keyword">final</span> String content, <span class="keyword">final</span> <span class="type">long</span> currentTimeMillis)</span> &#123;</span><br><span class="line">       LogUtils.e(<span class="string">&quot;%s,%s,%s,%s&quot;</span>, uri, x_msgid, mimeType, content, currentTimeMillis);</span><br><span class="line">       <span class="keyword">return</span> SipMessenger.getMessenger().sendMessage(uri, x_msgid, mimeType, content, currentTimeMillis);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure><h1 id="8-SipMessengerÂèëÈÄÅÊ∂àÊÅØ"><a href="#8-SipMessengerÂèëÈÄÅÊ∂àÊÅØ" class="headerlink" title="8.SipMessengerÂèëÈÄÅÊ∂àÊÅØ"></a>8.SipMessengerÂèëÈÄÅÊ∂àÊÅØ</h1><p class="code-caption" data-lang="java" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="Code" data-labels_right=":" data-labels_copy=""><span class="code-caption-label"></span><a class="code-caption-copy"></a></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">sendMessage</span><span class="params">(<span class="keyword">final</span> String uri, <span class="keyword">final</span> String x_msgid, <span class="keyword">final</span> String mimeType, <span class="keyword">final</span> String content, <span class="keyword">final</span> <span class="type">long</span> currentTimeMillis)</span> &#123;</span><br><span class="line"><span class="comment">//       Ëé∑ÂèñÂΩìÂâçÁôªÂΩïÁöÑÁî®Êà∑</span></span><br><span class="line">        <span class="keyword">final</span> <span class="type">SipAccount</span> <span class="variable">account</span> <span class="operator">=</span> SipAccountMgr.getInstance().getCurrentAccount();</span><br><span class="line">        <span class="keyword">if</span> (account != <span class="literal">null</span> &amp;&amp; SipUri.validSipUri(uri)</span><br><span class="line">                &amp;&amp; !TextUtils.isEmpty(mimeType) &amp;&amp; !TextUtils.isEmpty(content)) &#123;</span><br><span class="line">            SipMain.getInstance().runOnMainThread(<span class="keyword">new</span> <span class="title class_">Runnable</span>() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line"><span class="comment">//                    ÂàáÊç¢Âà∞‰∏ªÁ∫øÁ®ãÈáåÂéªÂèëÊ∂àÊÅØ</span></span><br><span class="line">                    sendMessage(account, x_msgid, uri, mimeType, content, currentTimeMillis);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            LogUtils.d(<span class="string">&quot;send params not valid. uri:&quot;</span> + uri + <span class="string">&quot; mimeType:&quot;</span> + mimeType + <span class="string">&quot; content:&quot;</span> + content);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><h1 id="9-ÁúüÊ≠£Ë∞ÉÁî®sipÂèëÈÄÅÊ∂àÊÅØÁöÑÂáΩÊï∞"><a href="#9-ÁúüÊ≠£Ë∞ÉÁî®sipÂèëÈÄÅÊ∂àÊÅØÁöÑÂáΩÊï∞" class="headerlink" title="9. ÁúüÊ≠£Ë∞ÉÁî®sipÂèëÈÄÅÊ∂àÊÅØÁöÑÂáΩÊï∞"></a>9. ÁúüÊ≠£Ë∞ÉÁî®sipÂèëÈÄÅÊ∂àÊÅØÁöÑÂáΩÊï∞</h1><p class="code-caption" data-lang="java" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="Code" data-labels_right=":" data-labels_copy=""><span class="code-caption-label"></span><a class="code-caption-copy"></a></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SuppressLint(&quot;HardwareIds&quot;)</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">sendMessage</span><span class="params">(SipAccount account, String x_msgid, String sipUri, String mimeType, String content, <span class="type">long</span> currentTimeMillis)</span> &#123;</span><br><span class="line">    <span class="type">Buddy</span> <span class="variable">buddy</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Buddy</span>();</span><br><span class="line">    <span class="type">BuddyConfig</span> <span class="variable">buddyConfig</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BuddyConfig</span>();</span><br><span class="line">    <span class="type">SendInstantMessageParam</span> <span class="variable">param</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SendInstantMessageParam</span>();</span><br><span class="line">    content = SipEncryptor.encode(content);</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        buddyConfig.setUri(sipUri);</span><br><span class="line">        buddy.create(account, buddyConfig);</span><br><span class="line">        param.setContentType(mimeType);</span><br><span class="line">        param.setContent(content);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (SipMessage.MESSAGE_TYPE_CANCEL.equals(mimeType)) &#123;</span><br><span class="line">            MyApplication.getApplication().addCancelHashcode(currentTimeMillis);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//Áî®Êù•ÂîØ‰∏ÄÊ†áËØÜËøôÊù°ÂèëÈÄÅÁöÑÊ∂àÊÅØ</span></span><br><span class="line">        <span class="type">SWIGTYPE_p_void</span> <span class="variable">a</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SwigtypePVoidWrapper</span>((<span class="type">int</span>) currentTimeMillis, <span class="literal">true</span>);</span><br><span class="line">        param.setUserData(a);</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         *  2ÂàÜÈíüÂÜÖÊí§ÂõûÊ∂àÊÅØÂ¢ûÂä†</span></span><br><span class="line"><span class="comment">         * */</span></span><br><span class="line">        param.getTxOption().setMsgBody((<span class="type">int</span>) currentTimeMillis + <span class="string">&quot;&quot;</span>);</span><br><span class="line">        <span class="type">SipTxOption</span> <span class="variable">txOption</span> <span class="operator">=</span> param.getTxOption();</span><br><span class="line">        <span class="type">SipHeaderVector</span> <span class="variable">headerVector</span> <span class="operator">=</span> txOption.getHeaders();</span><br><span class="line">        <span class="type">SipHeader</span> <span class="variable">sipHeader</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SipHeader</span>();</span><br><span class="line">        sipHeader.setHName(SipMessage.X_MSGID);</span><br><span class="line">        sipHeader.setHValue(x_msgid);</span><br><span class="line">        headerVector.add(sipHeader);</span><br><span class="line">        txOption.setHeaders(headerVector);</span><br><span class="line">        param.setTxOption(txOption);</span><br><span class="line">        buddy.sendInstantMessage(param);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">        LogUtils.e(<span class="string">&quot;send Message failed.&quot;</span> + e);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        param.delete();</span><br><span class="line">        buddy.delete();</span><br><span class="line">        buddyConfig.delete();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="10-ÊúÄÂ∫ïÂ±ÇÂèëÈÄÅÊ∂àÊÅØÁöÑÂáΩÊï∞"><a href="#10-ÊúÄÂ∫ïÂ±ÇÂèëÈÄÅÊ∂àÊÅØÁöÑÂáΩÊï∞" class="headerlink" title="10.ÊúÄÂ∫ïÂ±ÇÂèëÈÄÅÊ∂àÊÅØÁöÑÂáΩÊï∞"></a>10.ÊúÄÂ∫ïÂ±ÇÂèëÈÄÅÊ∂àÊÅØÁöÑÂáΩÊï∞</h1><p class="code-caption" data-lang="java" data-line_number="frontend" data-trim_indent="backend" data-label_position="outer" data-labels_left="Code" data-labels_right=":" data-labels_copy=""><span class="code-caption-label"></span><a class="code-caption-copy"></a></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">sendInstantMessage</span><span class="params">(SendInstantMessageParam prm)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    pjsua2JNI.Buddy_sendInstantMessage(<span class="built_in">this</span>.swigCPtr, <span class="built_in">this</span>, SendInstantMessageParam.getCPtr(prm), prm);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;1-snedMsg&quot;&gt;&lt;a href=&quot;#1-snedMsg&quot; class=&quot;headerlink&quot; title=&quot;1.snedMsg&quot;&gt;&lt;/a&gt;1.snedMsg&lt;/h1&gt;&lt;p class=&quot;code-caption&quot; data-lang=&quot;java&quot; data</summary>
      
    
    
    
    
  </entry>
  
  <entry>
    <title>1.SIPÁôªÂΩïÊ®°ÂùóÊï¥ÁêÜ</title>
    <link href="https://courage-gl.github.io/xiaoalei.github.io/2022/04/02/1.SIP%E7%99%BB%E5%BD%95%E6%A8%A1%E5%9D%97%E6%95%B4%E7%90%86/"/>
    <id>https://courage-gl.github.io/xiaoalei.github.io/2022/04/02/1.SIP%E7%99%BB%E5%BD%95%E6%A8%A1%E5%9D%97%E6%95%B4%E7%90%86/</id>
    <published>2022-04-02T09:12:05.000Z</published>
    <updated>2022-04-02T09:53:35.208Z</updated>
    
    <content type="html"><![CDATA[<h1 id="SipÁôªÂΩïÁõ∏ÂÖ≥ÈóÆÈ¢ò"><a href="#SipÁôªÂΩïÁõ∏ÂÖ≥ÈóÆÈ¢ò" class="headerlink" title="SipÁôªÂΩïÁõ∏ÂÖ≥ÈóÆÈ¢ò"></a>SipÁôªÂΩïÁõ∏ÂÖ≥ÈóÆÈ¢ò</h1><h4 id="1-ÁôªÂΩïÊµÅÁ®ã"><a href="#1-ÁôªÂΩïÊµÅÁ®ã" class="headerlink" title="1.ÁôªÂΩïÊµÅÁ®ã"></a>1.ÁôªÂΩïÊµÅÁ®ã</h4><p><img src="/xiaoalei.github.io/images/sip_login.png"></p><h4 id="2-ÁôªÂΩï„ÄÅÊ≥®ÈîÄ"><a href="#2-ÁôªÂΩï„ÄÅÊ≥®ÈîÄ" class="headerlink" title="2.ÁôªÂΩï„ÄÅÊ≥®ÈîÄ"></a>2.ÁôªÂΩï„ÄÅÊ≥®ÈîÄ</h4><p><img src="/xiaoalei.github.io/images/login_unlogin1.png"><br><img src="/xiaoalei.github.io/images/login_unlogin2.png"></p><h4 id="3-ÁôªÂΩïÁä∂ÊÄÅ"><a href="#3-ÁôªÂΩïÁä∂ÊÄÅ" class="headerlink" title="3.ÁôªÂΩïÁä∂ÊÄÅ"></a>3.ÁôªÂΩïÁä∂ÊÄÅ</h4><p><img src="/xiaoalei.github.io/images/login_status.png"></p><h4 id="4-Ê≥®ÈîÄÁôªÂΩï"><a href="#4-Ê≥®ÈîÄÁôªÂΩï" class="headerlink" title="4.Ê≥®ÈîÄÁôªÂΩï"></a>4.Ê≥®ÈîÄÁôªÂΩï</h4><p><img src="/xiaoalei.github.io/images/login_unlogin.png"></p><h4 id="5-ÁΩëÁªúÂàáÊç¢"><a href="#5-ÁΩëÁªúÂàáÊç¢" class="headerlink" title="5.ÁΩëÁªúÂàáÊç¢"></a>5.ÁΩëÁªúÂàáÊç¢</h4><p><img src="/xiaoalei.github.io/images/network_change.png"></p><h4 id="6-ÊùÄÊéâÂêéÂÜçÊâìÂºÄ"><a href="#6-ÊùÄÊéâÂêéÂÜçÊâìÂºÄ" class="headerlink" title="6.ÊùÄÊéâÂêéÂÜçÊâìÂºÄ"></a>6.ÊùÄÊéâÂêéÂÜçÊâìÂºÄ</h4><p><img src="/xiaoalei.github.io/images/kill_and_open.png"></p><h4 id="7-ÊîæÂà∞ÂêéÂè∞ÂÜçÊâìÂºÄ"><a href="#7-ÊîæÂà∞ÂêéÂè∞ÂÜçÊâìÂºÄ" class="headerlink" title="7.ÊîæÂà∞ÂêéÂè∞ÂÜçÊâìÂºÄ"></a>7.ÊîæÂà∞ÂêéÂè∞ÂÜçÊâìÂºÄ</h4><p><img src="/xiaoalei.github.io/images/background_opne.png"></p><h4 id="8-sipÂøÉË∑≥Êú∫Âà∂"><a href="#8-sipÂøÉË∑≥Êú∫Âà∂" class="headerlink" title="8.sipÂøÉË∑≥Êú∫Âà∂"></a>8.sipÂøÉË∑≥Êú∫Âà∂</h4><p><img src="/xiaoalei.github.io/images/sip_beat.png"></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;SipÁôªÂΩïÁõ∏ÂÖ≥ÈóÆÈ¢ò&quot;&gt;&lt;a href=&quot;#SipÁôªÂΩïÁõ∏ÂÖ≥ÈóÆÈ¢ò&quot; class=&quot;headerlink&quot; title=&quot;SipÁôªÂΩïÁõ∏ÂÖ≥ÈóÆÈ¢ò&quot;&gt;&lt;/a&gt;SipÁôªÂΩïÁõ∏ÂÖ≥ÈóÆÈ¢ò&lt;/h1&gt;&lt;h4 id=&quot;1-ÁôªÂΩïÊµÅÁ®ã&quot;&gt;&lt;a href=&quot;#1-ÁôªÂΩïÊµÅÁ®ã&quot; class=&quot;head</summary>
      
    
    
    
    
  </entry>
  
</feed>
